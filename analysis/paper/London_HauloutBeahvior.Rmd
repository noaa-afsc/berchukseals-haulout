---
title: "Haul-out behavior and aerial survey detectability of seals in the Bering and Chukchi seas"
author:
  - Josh M. London:
      email: josh.london@noaa.gov
      institute: [MML]
      correspondence: true
  - Paul B. Conn:
      institute: [MML]
      correspondence: false
  - Stacie K. Hardy:
      institute: [MML]
      correspondence: false
  - Erin L. Richmond:
      institute: [MML]
      correspondence: false
  - Jay M. Ver Hoef:
      institute: [MML]
      correspondence: false
  - Michael F. Cameron:
      institute: [MML]
      correspondence: false
  - Justin Crawford:
      institute: [ADFG]
      correspondence: false
  - Andrew L. Von Duyke:
      institute: [NSB]
      correspondence: false
  - Lori T. Quakenbush:
      institute: [ADFG]
      correspondence: false
  - Peter L. Boveng:
      institute: [MML]
      correspondence: false
institute:
  - MML: Marine Mammal Laboratory, Alaska Fisheries Science Center, NOAA Fisheries, Seattle, Washington, USA
  - ADFG: Arctic Marine Mammals Program, Alaska Department of Fish and Game, Fairbanks, Alaska, USA
  - NSB: Department of Wildlife Management, North Slope Borough, Utqiaġvik, Alaska, USA
output: 
  officedown::rdocx_document:
    reference_docx: ../templates/jml_template.docx
    pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
    page_size:
      width: 8.5
      height: 11
      orient: "portrait"
    page_margins:
      bottom: 1.25
      top: 1.25
      right: 1.0
      left: 0.5
      header: 0.5
      footer: 0.5
      gutter: 0.5
bibliography: references.json
link-citations: true
csl: ../templates/proceedings-of-the-royal-society-b.csl
always_allow_html: true
---

## Abstract

Ice-associated seals rely on sea ice for a variety of activities, including
breeding, molting, pupping, and resting. In the Arctic, many of these activities
occur in spring (April-June) as sea ice begins to melt and retreat northward.
Rapid acceleration of climate change in Arctic ecosystems is therefore of
concern as the quantity and quality of suitable habitat is forecast to decrease.
In this paper, we use data collected from satellite-linked bio-loggers deployed
between 2005 and 2020 to investigate the seasonal timing and environmental
factors affecting haul-out behavior by ice-associated seals. We specifically
focused on bearded (_Erignathus barbatus_), ribbon (_Histriophoca fasciata_),
and spotted seals (_Phoca largha_)) in the Bering and Chukchi seas. Because
ringed seals (_Phoca hispida_) are unique in their use of snow lairs, they were
not included and a separate analysis is warranted. In addition to providing
baseline data on phenology, these data also allow us to quantify 'availability',
which is needed to accurately estimate abundance from aerial survey counts of
these seals basking on ice (i.e., to correct for the proportion of animals that
are in the water while surveys are conducted). Using generalized linear mixed
pseudo-models to properly account for temporal autocorrelation, we fit models
with covariates of interest (e.g., day-of-year, solar hour, age-sex class, wind
speed, barometric pressure, temperature, precipitation) to examine their ability
to explain variation in hourly haul-out probability. We found evidence for
strong diurnal and within-season patterns in haul-out behavior, as well as
strong weather effects (particularly wind and temperature). In general, seals
were more likely to haul out on ice in the middle of the day and when wind speed
was low and temperatures were higher. Haul-out probability increased through
March and April, peaking in May and early June before declining again. The
timing and frequency of haul-out events also varied based on species and age-sex
class. For ribbon and spotted seals, models with year effects were highly
supported, indicating that the timing and magnitude of haul-out behavior varied
among years. However, we did not find evidence that haul-out timing was linked
to annual sea ice extent. Our analysis emphasizes the importance of accounting
for seasonal and temporal variation in haul-out behavior, as well as associated
environmental covariates, when interpreting the number of seals counted in
aerial surveys.

keywords: availability; generalized linear mixed pseudo-model; haul-out
behavior; phenology; Phocidae; sea ice

```{r setup, include = FALSE}
library(targets)
library(conflicted)
library(tidyverse)
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
library(lubridate)
conflict_prefer("month","lubridate")
library(glue)
library(scales)
library(DBI)
library(dbplyr)
library(RPostgres)
library(pingr)
library(sf)
library(flextable)
library(patchwork)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggspatial)
library(ggsci)
library(ggrepel)
library(gghighlight)
library(ggtext)
library(glmmLDTS)
library(mgcv)
library(ragg)
library(stickylabeller)

knitr::opts_chunk$set(dev = "ragg_png")

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  include = FALSE,
  fig.path = "../figures/",
  dpi = 400,
  fig.width = 6.5,
  out.width = "100%"
)

knitr::opts_chunk$set(
  tab.cap.style = "Table Caption",
  tab.cap.pre = "Table ",
  tab.cap.sep = ": "
  )

knitr::opts_chunk$set(
  fig.cap.style = "Image Caption",
  fig.cap.pre = "Figure ",
  fig.cap.sep = ": "
  )

options(scipen = 3, digits = 3)

theme_set(theme_minimal(base_family = 'Source Sans Pro'))
theme_replace(plot.title.position = "plot")
```

# Introduction

The global climate disruption is causing considerable reduction in Arctic sea
ice extent, volume, and seasonal presence [@kwok2018;
@meier2014; @overland2021; @wang2017]. These changes have ripple effects on
Arctic organisms, ecosystems, and the human communities who live in the region
[@huntington2020]. Such disruptions are a particular cause of concern for the
ice-associated seals that depend on spring and early summer sea ice (March-June)
in the Bering and Chukchi seas as a platform for important life history
functions, such as pupping, nursing, breeding, and molting [@boveng2009;
@boveng2013a; @cameron2010; @kelly2010]. Limited data and large knowledge gaps
complicate predictions about the ultimate effects of changes in sea ice on the
behavior, health, abundance, and distribution of these seals. To date, indices
of seal health sampled during periods of declining sea ice differ regionally
[@crawford2015; @harwood2020]. Knowledge about evolutionary constraints on the
timing of reproductive and molting behavior is generally lacking, so it is
difficult to predict the readiness with which ice-associated seal species will
be able to adapt to future changes (e.g., by adjusting pupping or molting
schedules to earlier dates or different locales). This is further complicated by
the spatio-temporal variation in the phenology of these life history events 
within regions and throughout their full ranges. Additionally, trends in
abundance from large scale surveys of these species are unknown, so it is difficult to assess the
effect, if any, declines in sea ice habitat have had, or will have, on seal
densities.

For ice-associated seals, haul-out behavior is tightly linked with sea ice.
Ribbon seals (_Histriophoca fasciata_) haul out of the water almost exclusively
on sea ice and are mostly pelagic outside the spring pupping, breeding, and
molting season [@boveng2018a]. While spotted (_Phoca largha_) and bearded
(_Erignathus barbatus_) seals rest on coastal features, they strongly prefer sea
ice as a resting platform during the spring and early summer [@frost2018].
Ringed seals (_Phoca hispida_) --- not included in this study --- bask on
sea-ice but also within snow lairs built during the spring. The remoteness of
the Bering and Chukchi seas mean direct scientific observation of seal behavior
is impractical. Thus, bio-logging devices are especially useful tools for
collecting key information on movement and haul-out behavior for these species.

Bio-logging records of time spent out of the water provide valuable data for
identifying covariates that explain variation in haul-out behavior. For
instance, in the Antarctic, Bengtson and Cameron [-@bengtson2004] relied on
bio-logging data to demonstrate greater haul-out propensity in juvenile
crabeater seals (*Lobodon carcinophaga*) than adults, with highest probabilities
in February and at times close to solar noon. In the Arctic, Von Duyke et al.
[-@vonduyke2020] used satellite-linked bio-loggers to corroborate seasonal
changes between diurnal and nocturnal haul-out behavior of ringed seals
previously described by Kelly et al. [-@kelly2010] using VHF radio tags and
direct observation. Bengtson et al. [-@bengtson2005a] documented a higher
propensity for ringed seal basking near solar noon, as did Ver Hoef et al.
[-@verhoef2014a] in an analysis of bearded, ribbon, and spotted seals using much
larger sample sizes. Olnes et al. [-@olnes2020] showed that the proportion of
time bearded seals spent hauled out progressively increased through spring and
summer. And, Ver Hoef et al. [-@verhoef2014a] found haul-out probabilities
increased gradually starting in March and peaking in May and June for bearded,
ribbon, and spotted seals.

Knowledge of haul-out patterns is not only important for understanding natural
history and ecology, but also for developing "availability" correction factors
for aerial surveys. Specifically, researchers need to know the fraction of seals
hauled out (versus in the water) when aerial surveys are conducted. Studies
estimating availability correction factors for seals typically use logistic
regression-style analyses to estimate the time-specific probability of being
hauled out based on 'wet/dry' data relayed by bio-loggers. In these models,
haul-out probabilities were expressed as a function of predictive covariates,
such as time-of-day, day-of-year, sex, age class, and environmental conditions
(e.g., [@reder2003], [@bengtson2004], [@bengtson2005a], [@udevitz2009],
[@verhoef2014a], and [@southwell2008]). However, sample sizes have often been
insufficient to permit strong inference about life history and/or seasonal
variation in haul-out probabilities. For instance, Bengtson and Cameron's
[-@bengtson2004] study included 5 adult and 2 juvenile crabeater seals, while
Bengtson et al.'s [-@bengtson2005a] study was based on 6 ringed seals in the
Chukchi Sea. These studies were often further limited by logistical constraints
on fieldwork and the attachment duration or operational life of bio-loggers. In
this study, we address some of these limitations by deploying small bio-loggers
designed for longer-term attachment on rear flippers of a subset of the study
individuals. These devices are designed to collect data through the molt period
(when those adhered to the hair would fall off) and, in some situations, provide
multiple years of data.

Ultimately, knowledge of trends in phenology and abundance (or life history
surrogates such as survival and recruitment) will be necessary to make credible
quantitative predictions about the effects of climate disruptions on the
abundance and distribution of Arctic seal populations. Before we can construct a
trend, however, we first require a baseline. Several studies have contributed
estimates of the distribution and abundance of ice-associated seal species in
the Arctic using aerial surveys (e.g., [@bengtson2005a], [@conn2014a], and
[@verhoef2014a]). Such abundance studies were conducted over very large areas and
estimation of absolute abundance required making inference about numerous issues
affecting the observation of seals on ice. These included availability (only
seals basking on ice were available to be counted), detection probability
(observers or automated detection systems may have missed some seals on ice),
species misclassification, and possible disturbance of seals by aircraft
[@conn2014a; @verhoef2014a]. Refining these inferences will improve the
accuracy of abundance estimates in the Arctic.

In this study, we used 16 years of bio-logging data to investigate the haul-out
behavior of bearded, ribbon, and spotted seals in the Bering and Chukchi seas.
Our goals were threefold. First, we wished to establish baseline estimates for
the chronology of haul-out behavior in the critical spring season for each
species across different age and sex classes. Second, we refined estimates of
haul-out availability corrections for aerial surveys in order to improve
estimates of seal abundance. Previously estimated availability correction
factors (e.g., [@bengtson2005a], [@conn2014a], and [@verhoef2014a]) accounted
for variables such as the time-of-day and day-of-year, but did not investigate
meteorological variables that have been shown to influence haul-out behavior of
walruses [@reder2003; @udevitz2009]. Third, we assessed the annual variability
in haul-out timing and possible linkage to changes in the extent of seasonal sea
ice between 2005 and 2020. Our work extends the scope of previous haul-out
analyses, includes the influence of meteorological variability, and investigates
the potential impact of a changing icescape on the behavior of these species.

# Methods

## Data collection

```{r getdata}
targets::tar_load(analysis_data, store = here::here("_targets"))
targets::tar_load(grid, store = here::here("_targets"))
targets::tar_load(deploy_table, store = here::here("_targets"))
```
Data used in our study came from bio-loggers deployed on bearded, ribbon, and
spotted seals in the Bering, Chukchi, and Beaufort seas by multiple
organizations as part of collaborative investigations from 2005 through 2020.
Seals were captured using nets and bio-loggers attached during ship-based
capture trips and from coastal Alaska communities. Ship-based capture events
occurred during spring near the southern ice edge in the Bering Sea. Land-based
capture events occurred from May to October, generally between the coastal
communities of Scammon Bay, Alaska, in the Bering Sea, and Utqiaġvik, Alaska,
near the junction of the Chukchi and Beaufort seas, from 2005 to 2020. We refer
readers to the primary literature for detailed capture and bio-logger attachment
methods (Supplemental Material, Table).

Haul-out behavior data from bio-loggers deployed on 
`r dplyr::n_distinct(deploy_table$speno)` bearded, ribbon, and spotted seals were
subset to include only records from 1 March to 15 July between 
`r min(lubridate::year(analysis_data$haulout_dt))` and 
`r max(lubridate::year(analysis_data$haulout_dt))`. Bio-loggers were of the
'SPLASH' or 'SPOT' family of tags developed by Wildlife Computers (Redmond,
Washington, USA) and either adhered to the hair on the seal or attached to the
rear flipper inter-digital webbing. The use of bio-loggers adhered to the back
or head provide some benefits over flipper mounted devices (e.g. increased
satellite transmittal rates, locations at sea) but these are lost during the
following annual molt, which, depending on deployment date, limits the duration
of haul-out data they provide. Additionally, bio-loggers attached to the head or
dorsal region are often dry while the seal is at the surface and can slightly
bias the hourly percent-dry values reported by the bio-logger. For this study,
in cases where both bio-logger types were deployed, hourly percent dry
observations from the flipper tag were preferred.

Field identification of age class can be inexact, particularly when discerning
subadults from adults. Sex and age class (non-dependent _young-of-the-year_,
sexually immature _subadults_, and mature _adults_) were estimated at the time
of deployment by various combinations of length, claw growth ridges [@burns1969;
@burns1983; @mclaren1958a], and pelage characteristics for some species. In the
case of ribbon seals, subadults often have less distinct ribbons than adults.
Bearded seal subadults will often have a spotted pattern in the pelage that is
not seen in adults. Spotted seal pelage cannot be used to reliably discern
adults from subadults. Despite these challenges, we feel the age classifications
used in this analysis are useful in testing for age-related effects on haul-out
behavior. Seals determined to be less than one year were classified as
young-of-the-year. Subadults are those seals likely greater than one year of age
but not yet sexually mature. Adults are likely sexually mature and older than
four years. For those bio-loggers deployed on young-of-the-year and transmitting
into the next year, the age class was advanced to subadult on 1 March of the
following year. Table \@ref(tab:tblDeploy) provides a summary of these
deployments and data received from them.

```{r tblDeploy, include=TRUE, tab.id="tblDeploy",tab.cap = "Summary of bio-logger data across seal species and age classification from 1 March to 15 July 2005-2020. Total seal hours represents the sum of available data across all seals. Because young-of-the-year are advanced to subadult on 1 March of the following year, some individual seals are represented in both columns in this table"}
 
deploy_table %>% 
  dplyr::group_by(species, sex, age) %>% 
  dplyr::summarise(
    n = n(),
    seal_hours = sum(n_hours)
  ) %>% 
  dplyr::mutate(
    deploy_stats = glue::glue('{n} ({format(seal_hours, big.mark=",")} seal hours)')
  ) %>% 
  dplyr::select(-c("n","seal_hours")) %>% 
  tidyr::pivot_wider(names_from = age, values_from = c(deploy_stats)) %>% 
  dplyr::ungroup() %>% 
  dplyr::rename(Species = species, Sex = sex, `Young-of-the-Year` = `YOUNG OF YEAR`,
                `Subadult` = SUBADULT, Adult = ADULT) %>% 
  flextable() %>% 
  add_header(`Young-of-the-Year` = "Age Class",
   Subadult = "Age Class", Adult = "Age Class",
   top = TRUE ) %>% 
  merge_h(part = "header") %>% 
  align(align = "center", part = "header") %>% 
  font(fontname = "Source Serif Pro Light", part = "all") %>% 
  fontsize(size = 10) %>% 
  autofit()
```

```{r seal-hours}
create_yday_groups <- function(analysis_data) {
  d <- analysis_data %>%
    tibble::as_tibble() %>%
    dplyr::mutate(yday = lubridate::yday(haulout_dt)) %>%
    dplyr::select(yday) %>%
    dplyr::distinct() %>%
    dplyr::arrange(yday)
  
  d <- split(d$yday, ceiling(seq_along(d$yday) / 8)) %>%
    dplyr::as_tibble() %>%
    tidyr::pivot_longer(
      cols = 1:18,
      names_to = "col_group",
      values_to = "yday",
      names_transform = list(col_group = as.integer),
      values_transform = list(yday = as.integer)
    ) %>%
    dplyr::arrange(yday) %>% 
    transform(row_group = letters[1:8]) %>% 
    dplyr::filter(col_group < 18)
  return(d)
}

yday_groups <- create_yday_groups(analysis_data)

seal_hours_tbl <- analysis_data %>% 
  tibble::as_tibble() %>% 
  dplyr::mutate(yday = lubridate::yday(haulout_dt)) %>% 
  dplyr::group_by(species, yday) %>% 
  dplyr::count()
```

Tags that fall off due to molt, attachment failure, or seal mortality and remain
on ice or land can still send data to satellites; i.e., the bio-logger will be
on ice or land and dry, therefore, it will record and transmit data suggesting
the seal is hauled out. As such, end times of each deployment were identified by
examining bio-logger locations and dive behavior to determine when bio-loggers
ceased providing data consistent with seal behavior. Data outside of the
deployment start and end times were discarded prior to analysis. After
approximately 9 months, 7 devices deployed on the rear flipper of bearded seals
reported implausible hourly percent-dry data. All data after the first instance
of unrealistic values were censored from this analysis. Figure
\@ref(fig:dataCal) shows the distribution of all haul-out data
across the study season for each species. Observations for ribbon and spotted
seals are concentrated in the months of May and June due to the timing of
deployment (April and May) and the timing of molt (May and June). During molt,
seals (and their attached bio-loggers) spend more time out of the water and more
data are transmitted. Molt timing also impacts when many deployments end as any
bio-loggers adhered to the hair will fall off. Bearded seal deployments are more
evenly spread with fewer observations in May and June. The majority of bearded
seal deployments start later in the summer and by May bio-loggers have either
fallen off or the batteries are depleted.

```{r seal-hours-calendar, include=TRUE, fig.id = "dataCal", fig.height = 4, fig.cap = "Distribution of hourly percent-dry bio-logger data from 1 March to 15 July for each species. Data are grouped by day-of-year and presented in seal-hours collated across all years between 2005 and 2020. The higher density of data from May and June in ribbon and spotted seals coincides with peak molting when seals (and their attached bio-loggers) are more likely hauled out. Additionally, many bio-logger deployments started in April and May."}

# bar chart instead of a strip
#
# ggplot(data = seal_hours_tbl, aes(x=yday, y=n, fill=n)) +
#   geom_col(binwidth = 1) +
#   scale_fill_gradient(low = "#6baed6", high = "#08306b") +
#   scale_x_continuous(breaks = c(60, 91, 121, 152, 182),
#                      labels = c("March", "April", "May", "June", "July"),
#                      expand = expansion(mult = c(0.01, 0.025))) +
#   guides(fill = guide_legend(title.position = "bottom", title.hjust = 0.5)) +
#   facet_grid(species ~ .) + 
#   theme(axis.text.x = element_text(hjust = 0),
#         axis.text.y = element_blank(),
#         axis.title = element_blank(),
#         panel.grid = element_blank(),
#         legend.position = "bottom") +
#   labs(fill = "seal-hours of bio-logger data") +
#   ggtitle("Density of haul-out behavior observations varies from March through July",
#           subtitle = "data are grouped by day-of-year and presented in seal-hours collated across years (2005-2020)")

ggplot(data = seal_hours_tbl, aes(x = yday, y = 1, fill = n))+
        geom_tile()+
        scale_fill_viridis_c(option="mako") +
        scale_x_continuous(breaks = c(60, 91, 121, 152, 182),
                           labels = c("01 March", "01 April", "01 May", "01 June", "01 July"),
                           expand = expansion(mult = c(0, 0))) +
        scale_y_continuous(expand = expansion(mult = c(0, 0))) +
  guides(fill = guide_colorbar(title.position = "bottom", 
                               title.hjust = 0.5, barwidth = 15,
                               barheight = 0.5)) +
  facet_grid(species ~ .) + 
  theme(axis.text.x = element_text(hjust = 0),
        axis.text.y = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        legend.position = "bottom") +
  labs(fill = "seal-hours of bio-logger data") +
  ggtitle("Density of haul-out behavior observations varies from March through July",
          subtitle = "data are grouped by day-of-year and presented in seal-hours collated across years (2005-2020)")


```

```{r binomialdata}

portion_10 <- function(d) {
  n <- nrow(d)
  f <- d %>% dplyr::filter(percent_dry <= 10) %>% 
    nrow()
  p10 <- f/n
  return(p10)
}

portion_90 <- function(d) {
  n <- nrow(d)
  f <- d %>% dplyr::filter(percent_dry >= 90) %>% 
    nrow()
  p90 <- f/n
  return(p90)
}

```

Haul-out behavior data were recorded and transmitted via the Argos satellite
network as hourly percent-dry timelines. For each hour of a day, the wet/dry
sensor was polled by the tag firmware every few seconds and a percent of the
hour in a dry state was calculated (Figure \@ref(fig:examplePlot)). On board the
bio-logger, hourly percent-dry data were rounded to the nearest 10 percent
inclusive of 0 and 100 percent and additional values at 3 and 98 percent. This
compression resulted in additional data transmission as each message consisted
of two complete 24-hour records. Bio-loggers were, generally, deployed and
programmed in a manner to maximize data transmission during the spring pupping
and molting period; however, hourly percent-dry data were not always
successfully transmitted. This is due to a variety of factors including
satellite coverage, tag availability (i.e. tags mounted to the rear flipper
often do not transmit while at sea), tag performance, duty cycling, and
extra-terrestrial atmospheric interference. Fortunately, missing records do not
seem to greatly bias inference about haul-out probabilities [@conn2012b].

```{r examplePlot, include=TRUE, fig.id="examplePlot", fig.cap="Haul-out behavior observations recorded by a bio-logger deployment on a ribbon seal over two years during the months of March, April, and May. Areas of the plot indicated with an 'X' represent missing data that were not successfully transmitted from the tag."}

d <- analysis_data %>% 
  filter(speno == "HF2016_1002") %>% 
  dplyr::select(speno, haulout_dt, percent_dry) %>% 
  arrange(haulout_dt) %>% st_drop_geometry() %>% 
  mutate(year = lubridate::year(haulout_dt),
         month = lubridate::month(haulout_dt,label=TRUE),
         day = lubridate::day(haulout_dt),
         hour = lubridate::hour(haulout_dt)) %>% 
  filter(month != 'Jun')

d_deploy <- analysis_data %>% 
  sf::st_drop_geometry() %>% 
  filter(speno == "HF2016_1002") %>% 
  dplyr::select(speno,deploy_dt,haulout_dt,percent_dry) %>% 
  mutate(year = lubridate::year(deploy_dt),
         month = lubridate::month(deploy_dt, label = TRUE),
         day = lubridate::day(deploy_dt),
         hour = lubridate::hour(deploy_dt))

missing_hours <- tibble(haulout_dt = seq(min(d_deploy$haulout_dt),
              max(d_deploy$haulout_dt),by = "hour")) %>% 
  filter(!haulout_dt %in% d_deploy$haulout_dt) %>% 
  filter(lubridate::month(haulout_dt) %in% c(3,4,5)) %>% 
  mutate(percent_dry = 0) %>% 
  mutate(year = lubridate::year(haulout_dt),
         month = lubridate::month(haulout_dt,label=TRUE),
         day = lubridate::day(haulout_dt),
         hour = lubridate::hour(haulout_dt))

p <- ggplot(d,aes(day,hour,fill=percent_dry))+
  geom_tile(color= "white",size=0) + 
  scale_fill_distiller(palette = "YlGnBu",
                       name = "hourly percent dry", aesthetics = "fill",
    guide = guide_colorbar(title.position = "bottom", barwidth = 15,
                           barheight = 0.5, title.hjust = 0.5)
    )

p <- p + facet_grid(year~month, scales = "free_x")
p <- p + scale_x_continuous(breaks = c(5,15,25), expand = c(0,0)) +
  scale_y_continuous(breaks = c(4,12,20))
p <- p + theme(legend.position = "bottom") +
  theme(strip.background = element_rect(colour="white")) +
  theme(axis.ticks=element_blank()) +
  theme(panel.spacing = unit(0,"line")) +
  ggtitle("Observation records are incomplete because not all data are transmitted",
          subtitle = "percent-dry data for a single ribbon seal across two years") +
  xlab("day of month") + ylab("hour (UTC)") 
p <- p + 
  geom_point(aes(x = day, y = hour), data = missing_hours, 
             color = "black", shape = 4, size=0.8)
p
```

Of key interest in this study was the relationship between haul-out behavior and
weather covariates that vary with time and animal location. We explored the use
of a continuous-time correlated random walk [@devins.johnson2008] movement model
to predict locations at specific times. However, the sparse nature of data from
some bio-loggers, especially those mounted to the rear flipper, resulted in poor
modeling performance or convergence issues. For this study, we calculated a
weighted average daily location where the inverse of the estimated Argos or
FastLoc GPS location error was used for the weight. Each Argos location estimate
was assigned an error radius based on either the categorical location quality (
_3_=250m, _2_=500m, _1_=1500m, _0_=2500m [@lopez2013]; we chose 2500m for
location classes _A_ and _B_) or, when available, the estimated error radius
from the Argos Kalman filter algorithm. Location estimates from FastLoc GPS were
all assigned an error radius of 50m. Any days where haul-out observations were
present but location data were missing we used the last calculated weighted
average daily location, and any days where the location intersected with land
were removed from the data set. We recognized that bearded and spotted seals
haul out on land. However, assessing the relationship between haul-out behavior
and weather covariates and their availability for aerial surveys on land was
outside the scope of this study. Additionally, any daily locations on land are
likely more reflective of coordinate averaging and measurement error instead of
actual use of coastal features. Figure \@ref(fig:dataMap) shows the spatial
distribution weighted locations with available haul-out behavior data for each
species across the study area.

```{r locs-count-mapdata}
haulout_locs <- analysis_data %>% 
  filter(lubridate::hour(haulout_dt) == 12)
         

hexgrid <- sf::st_make_grid(st_bbox(haulout_locs) %>% st_as_sfc(), cellsize = 50*1000,
                            what = "polygons", square = FALSE) 
hexgrid <- st_sf(index = 1:length(lengths(hexgrid)), hexgrid)

hexbin <- st_join(haulout_locs, hexgrid, join = st_intersects)

locs_count <- hexgrid %>%
  left_join(
    count(hexbin, index, species) %>%
      as_tibble() %>%
      dplyr::select(species, index, ct=n)
  ) %>% drop_na()
```

```{r dataMap, fig.height = 3.75, fig.id="dataMap", include=TRUE, fig.cap="Spatial distribution of haul-out data during the months of March through July 15 for each of the three species. Data were collated across all years between 2005 and 2020."}

world <- ne_countries(scale = "medium", returnclass = "sf") %>% 
  sf::st_transform(st_crs(locs_count))

ggplot() +
  annotation_spatial(world, 
                     size = 0, 
                     fill = "grey70") +
  layer_spatial(
    data = locs_count, size = 0.125,
    aes(fill = ct)
  ) +
  scale_fill_distiller(type = "seq", palette = "YlOrRd", direction = 1,
                    trans = "log10", aesthetics = "fill",
    name = "number of locations",
    guide = guide_colorbar(title.position = "bottom", barwidth = 15, 
                           barheight = 0.5, title.hjust = 0.5)) + 
  facet_grid(~ species) +
  theme(legend.position = "bottom") +
  ggtitle("Spatial distribution of haul-out behavior data")
```

## Explanatory variables

In addition to sex and age class, we analyzed variables that might help explain
variation in haul-out probabilities. These included day-of-year (for seasonal
effects) and local solar hour (for diurnal effects). Solar hour was calculated
using the {solaR} package [@perpinan2012] within the R statistical environment
[@rcoreteam2021] using the daily locations. We included several weather
variables shown to affect haul-out behavior in other Arctic pinnipeds
[@reder2003; @udevitz2009; @perry2017]. In particular, we linked the weighted
average daily locations from our bio-loggers to key weather values from the
North American Regional Reanalysis (NARR) model produced by the National Centers
for Environmental Prediction [@mesinger2006]. The NARR model assimilates
observational data to produce a long-term picture of weather over North America.
Numerous weather variables are made available across the region 8 times daily.
For this study, NARR weather values were subset to the extent of our study area
over the Bering and Chukchi seas at 3-hr intervals based on the native grid
resolution of 32 km (1024 sq. km). The following meteorological variables were
interpolated and assigned to seal locations using a bilinear method: 1) air
temperature at 2m above the earth's surface, 2) wind consisting of northerly and
easterly vector components converted to wind speed using the Euclidean norm, 3)
barometric pressure at sea level, and 4) precipitation (Table
\@ref(tab:tblCovariates)).

Models for all species include the following effects: day-of-year, solar hour,
temperature, wind speed, barometric pressure, precipitation, wind chill
(represented by a *wind:temperature* interaction [@udevitz2009]), and
day-of-year and time-of-day (solar hour) interactions to permit diurnal patterns
to change from March to July. Ribbon and spotted seal models included age-sex
class and interactions between day-of-year and age-sex class, but we omitted
these from bearded seal models due to poor representation of age-sex classes
(Table \@ref(tab:tblDeploy)). Bearded seal models included a latitudinal effect
(and an interaction with day-of-year), since bearded seals occupy a substantial
range and we were interested in possible differences in the timing of haul-out
behavior along a latitudinal gradient. We omitted the latitudinal effect from
ribbon and spotted seal models since, during the spring, these species are most
prevalent near the southern ice edge in the Bering Sea [@conn2014a].

Notably missing from this list of explanatory variables is any spatial-temporal
representation of sea ice concentration, area, or extent. This may seem
counterintuitive when modeling the haul-out behavior of seal species with such a
close association to sea ice; seals haul out in the presence of sea ice, and we
could assess the local concentration of sea ice during these events (see
[@olnes2020]). However, a major focus of this study is to develop models
applicable for aerial survey correction factors and using sea ice as a covariate
would almost certainly bias haul-out predictions towards those seals that are on
or near ice and therefore more likely to haul out. Since aerial surveys can only
detect seals on ice, abundance estimates would be missing a correction for those
seals that are away from ice (e.g., on foraging trips). Additionally, many of
the deployments consisted of a single device attached to the rear flipper of the
seal which do not provide at-sea locations, limiting our ability to fully
evaluate fine-scale habitat preferences related to sea-ice. Lastly, our study
was limited to the spring season when seal haul-out tendencies are strongly
influenced by pupping, nursing, breeding behavior, and molt and these drivers
are likely more influential than specific sea-ice concentration. Crawford et al
[-@crawford2019] compared haul-out probability models for ringed seals and found
those that only included season (and not sea-ice concentration) were the most
parsimonious. For these reasons, we have elected not to use sea ice
concentration as a predictor for haul-out probability in the present study
(note, however, that habitat selection analyses incorporating sea-ice
concentration are a focus of current and future research).

We assessed whether the annual variation in maximum spring sea ice extent in the
Bering Sea influences the seasonal peak of seal haul-out behavior. In
particular, we used sea ice concentration data from the Nimbus-7 SMMR and DMSP
SSM/I-SSMIS Passive Microwave Dataset, Version 1 [@cavalieri1996] to calculate
maximum sea ice extent. All sea ice concentration grid cells (25 km^2^) in the
study area with greater than 15% concentration were counted daily to get the total sea
ice extent for each day between 15 February and 15 July across all years.
Maximum spring sea ice extent was simply the largest daily count of grid cells
with greater than 15 percent concentration for each year.

```{r tblCovariates, tab.id = "tblCovariates", include=TRUE, tab.cap = "Explanatory covariates used in analyses of binary haul-out records for bearded, spotted, and ribbon seals. Note that we also considered select interactions (see article text) between these primary covariates.  For instance, wind chill was represented by the interaction _temperature:wind_."}

covariate_tbl <- tibble::tribble(
  ~Covariate, ~Type, ~Source, ~Description,
  "Age-sex class",   "Categorical", "Field Assessment", 
  "young-of-the-year, subadult, adult male and adult female",
  "Hour", "Continuous; Fourier basis", "Bio-logger", 
  "local solar hour using 6 variables of a Fourier-series basis",
  "Day",   "Continuous", "Bio-logger", 
  "linear, quadratic, and cubic effects of day-of-year",
  "Precip", "Continuous", "NARR", 
  "convective precipitation (kg/m2)",
  "Pressure", "Continuous", "NARR", 
  "atmospheric pressure at sea level (kPa)",
  "Temp", "Continuous", "NARR",
  "air temperatures at 2m above the earth’s surface",
  "Wind", "Continuous", "NARR", 
  "northerly and easterly vector components for wind converted into a single wind speed via the Euclidean norm",
  "Northing", "Continuous", "Bio-logger","latitude divided by the mean latitude across all locations (for bearded seals only)",
  "Year", "Continuous", "Bio-logger", "For the set of models examining inter-annual variation in sea ice use, we fitted models with the addition of year by day-of-year interactions." 
)

covariate_tbl %>% 
  flextable() %>% 
  font(fontname = "Source Serif Pro Light", part = "all") %>% 
  fontsize(size = 10) %>% 
  hline(i=8) %>% 
  set_table_properties(width = .95, layout = "autofit")
```

## Haul-out modeling

```{r modelfits}
tar_load(bearded_fit, store = here::here("_targets"))
tar_load(ribbon_fit, store = here::here("_targets"))
tar_load(spotted_fit, store = here::here("_targets"))
tar_load(spotted_year_fit, store = here::here("_targets"))
tar_load(ribbon_year_fit, store = here::here("_targets"))
```

Haul-out records for seals are often characterized by sequential hours spent
basking on ice alternating with long periods in the water (Figure
\@ref(fig:examplePlot)). Commonly used statistical models for binary data (e.g.
logistic regression) assume independence among responses, an assumption that is
clearly violated if hourly responses are modeled. Any analysis that ignores
temporal autocorrelation in responses will thus have overstated precision
[@betts2006].

To properly account for temporal dependence within a computationally tractable
framework, we used generalized linear mixed pseudo-models (GLMPMs;
[@verhoef2010a]) to model variation in haul-out behavior as a function of (1)
covariate predictors, (2) temporally autocorrelated random effects, and (3)
individual random effects representing heterogeneity in individual behavior. We
used the glmmLDTS package [@verhoef2010a] to implement GLMPMs. We explored two
different model formulations for our data, and owing to the large number of
records, we fit separate models to bearded, ribbon, and spotted seal data sets.
In our first model formulation, for each species, we fitted a year-independent
model that predicted average haul-out behavior as a function of demographic,
environmental, seasonal, and diurnal effects. Second, for ribbon and spotted
seals (which had considerably more data than bearded seals), we fitted models
that included all the effects from the first model, but also permitted annual
variation in haul-out timing. This second class of models was used to examine
whether haul-out patterns varied by year and to determine the annual timing of
apparent peaks in haul-out behavior. For both models, we assumed an hourly
Bernoulli response (i.e., whether tags were mostly dry or mostly wet) where
the linear predictor was modeled on the logit scale. This is consistent with
previous approaches [@verhoef2014a, @london2012] and only
`r (1 - (portion_10(analysis_data) + portion_90(analysis_data))) * 100`% of our
observations fell between 10% and 90% hourly percent dry.

We followed Ver Hoef et al. [-@verhoef2014a] in using linear, quadratic, and
cubic effects of day-of-year to represent temporal changes in behavior. However,
unlike previous models for harbor seals [@london2012] and ice-associated seals
[@verhoef2014a], which treated hour-of-day as a 24-level categorical variable to
capture diurnal cycles, we adopted a continuous formulation based on Fourier
series that provides a flexible model while preserving the inherent circularity
needed for time-of-day effects (i.e., hour 0 should be equal to hour 24). It
also represents hour-of-day with 6 parameters, which is a considerable reduction
when compared to a 24 parameter variable, especially when fitting models with
interactions between hour-of-day and other variables (e.g., age-sex class,
day-of-year). According to this approach, we used the following specification
for hour-of-day effects:

$$
H_t=\alpha_1 \cos(\frac{\pi t}{4}) + \alpha_2 \sin(\frac{\pi t}{4}) + \alpha_3 \cos(\frac{\pi t}{6}) + \alpha_4 \sin(\frac{\pi t}{6}) + \alpha_5 \cos(\frac{\pi t}{12}) + \alpha_6 \sin(\frac{\pi t}{12})
$$ 
where $H_t$ gives the effect for solar hour $t$ and $α_{i}$ are
estimated parameters (regression coefficients).

For the second set of models examining inter-annual variation in sea ice use, we
fitted models with year by day-of-year interactions. However, in this case we
only included *year:day* and *year:day^2^*, omitting the main effects of year as
well as *year:day^3^* interactions because models with the latter effects were
numerically unstable. However, the modeled interactions were sufficient to allow
shifts in haul-out distribution, as one can show mathematically that a simple
horizontal shift in timing of haul-out distributions does not affect the main
effects or cubic terms in a polynomial regression model. Bearded seals were
not included in this examination of inter-annual variation because of limited
data across many years in the study.

A typical model fitting exercise would also include a model selection process.
However, AIC (and similar criteria) is not suitable when using
pseudo-likelihoods, because pseudo-data generated in the model fitting process
[@verhoef2010a] differ between models [@teneyck2018]. After fitting GLMPM
models, we instead used "type III" $F$-tests to calculate $p$-values
[@verhoef2010a] to evaluate model performance and important terms. We also
produced predictions of haul-out behavior as a function of influential
predictors (e.g. solar hour, day-of-year, age-sex). Weather covariates for these
predictions were based on daily or hourly smoothed weather covariate values
across the study region. Such predictions were then used to develop haul-out
probability surfaces, explore conditional effects of weather covariates, and
determine annual peaks in haul-out activity. The timing of peak haul-out
behavior was further used to regress against the annual maximum sea ice extent
in the study region.

Visualizing the marginal or conditional effect of an individual weather
covariate on haul-out probability is difficult in this analysis because of the
collinearity between covariates as well as the spatial and temporal variation
across such a large region. The relationship of each weather covariate with
haul-out probability, averaged over the other weather conditions, is more
variable than simply showing model coefficients would imply. To elucidate
underlying patterns between the model's predicted haul-out probability and
specific weather covariates, we explored a subset of predictions during three
separate time windows. The same set of predictions used to create the haul-out
probability surfaces was reduced to include only local solar hours between 06:00
and 18:00 during three 7-day time windows. The time windows were centered on the
day of maximum haul-out probability and 25 days before and 25 days after peak
haul out. While this approach does not entirely remove patterns of collinearity
from the visualization (e.g. temperature increases with day of year), by
limiting our range of days and hours we gain some insight into how haul-out
probability varies across different weather covariate values. Figures
\@ref(fig:beardedHOwx), @\ref(fig:ribbonHOwx), and @\ref(fig:spottedHOwx)
present the predicted haul-out probability with respect to age and sex class
across the range of temperature and wind conditions encountered in the three
time windows. The visualizations also include vertical lines representing 95%
confidence intervals around the predicted haul-out probability to better
communicate the variation in model uncertainty. Additionally, simple linear fits
are shown to assist interpretation of overall patterns.

# Results

Models omitting year effects suggested that day-of-year, solar hour, age-sex
class, temperature, and wind substantially influenced haul-out behavior of all
three species, with $F$ tests producing $p$-values less than 0.05 for variables
embodying these effects and/or their interactions. Haul-out probabilities
typically increased throughout March and April, reaching a peak in May and early
June before declining again. Diurnal patterns were present, with maximum
haul-out behavior centered around local solar noon.

```{r type3}
ribbon_type3 <- tibble(
  ribbon_fit$typeIII.hypoth
) %>% 
  mutate(Prob.F = scales::pvalue(Prob.F),
         Effect = janitor::make_clean_names(Effect)) %>% 
  column_to_rownames(var = "Effect") 
ribbon_type3 <- setNames(split(ribbon_type3, 
                               seq(nrow(ribbon_type3))), 
                         rownames(ribbon_type3))

spotted_type3 <- tibble(
  spotted_fit$typeIII.hypoth
) %>% 
  mutate(Prob.F = scales::pvalue(Prob.F),
         Effect = janitor::make_clean_names(Effect)) %>%  
  column_to_rownames(var = "Effect")  
spotted_type3 <- setNames(split(spotted_type3, 
                               seq(nrow(spotted_type3))), 
                         rownames(spotted_type3))

bearded_type3 <- tibble(
  bearded_fit$typeIII.hypoth
) %>% 
  mutate(Prob.F = scales::pvalue(Prob.F),
         Effect = janitor::make_clean_names(Effect)) %>%  
  column_to_rownames(var = "Effect")  
bearded_type3 <- setNames(split(bearded_type3, 
                               seq(nrow(bearded_type3))), 
                         rownames(bearded_type3))
```

## Bearded Seals

Age and sex class were not included in the model for bearded seals due to our
lower sample size for adult and young-of-year age classes. As such,
results are shown for all ages. Bearded seals had a bi-modal
distribution of haul-out probability across the day (Figure
\@ref(fig:beardedHOCal)). In addition to a peak around local solar noon, the
bearded seal model predicts additional haul-out activity around local midnight.
The haul-out behavior is also more protracted throughout the spring season
compared to ribbon and spotted seals.

```{r ebnewdata}
targets::tar_load(bearded_newdata, store = here::here("_targets"))
```

```{r beardedHOCal, fig.height = 3.5, include=TRUE, fig.id = "beardedHOCal", fig.cap="Predicted haul-out probability of bearded seals (all ages and sex classes) from 1 March to 15 July for all and sex classes."}

plot_df <- bearded_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label=TRUE),
         day = lubridate::day(date)) %>%
  filter(month != "Aug")

p <- ggplot(plot_df,aes(day,solar_hour,fill = ho_prob))+
  geom_tile(color= "white",size = 0) +
  scale_fill_viridis_c(name = "haul-out probability", aesthetics = "fill",
                       guide = guide_colorbar(title.position = "bottom", barwidth = 15,
                                              barheight = 0.5, title.hjust = 0.5)
  )
p <- p + facet_grid(age_sex~month)
p <- p + scale_x_continuous(breaks = c(1,10,20,30)) +
  scale_y_continuous(breaks = c(4,12,20))
p <- p + theme(legend.position = "bottom") +
  theme(strip.background = element_rect(colour="white")) +
  theme(axis.ticks=element_blank()) +
  xlab("day of month") + ylab("local solar hour") +
  ggtitle("Bearded seals rest on sea ice around solar noon and solar midnight")
p
```

When exploring the influence of weather, Bearded seal haul-out probability appears most influenced by wind
($F_{`r paste(bearded_type3$wind$Num.df, bearded_type3$wind$Den.df, sep=",")`}$
= `r bearded_type3$wind$F.value`; $p$ = `r bearded_type3$wind$Prob.F`)
and temperature
($F_{`r paste(bearded_type3$temp2$Num.df, bearded_type3$temp2$Den.df, sep=",")`}$
= `r bearded_type3$temp2$F.value`; $p$ =
`r bearded_type3$temp2$Prob.F`). Additionally, wind chill was also a
significant influence
($F_{`r paste(bearded_type3$temp2_wind$Num.df, bearded_type3$temp2_wind$Den.df, sep=",")`}$
= `r bearded_type3$temp2_wind$F.value`; $p$ =
`r bearded_type3$temp2_wind$Prob.F`). Any influence of barometric
pressure or precipitation was less apparent.


```{r beardedHOwx,fig.height = 5.5, include=TRUE, fig.id = "beardedHOwx", fig.cap="Variability in predicted haul-out probability of bearded seals across the range of weather conditions encountered in the observed data. Transparent vertical lines represent the 95% confidence interval around the predicted haul-out probability."}

plot_df <- bearded_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label = TRUE),
         day = lubridate::day(date)) %>% 
  filter(age_sex != "YOUNG OF YEAR",
         between(solar_hour, 8,16)) %>% 
  group_by(age_sex)

plot_df_early <- plot_df %>% tidyr::nest() %>% 
  rowwise() %>% 
  mutate(peak_idx = which.max(data$ho_prob),
         peak_day = data$yday[peak_idx]) %>% ungroup() %>% 
  mutate(peak_avg = as.integer(mean(peak_day))) %>% 
  rowwise() %>% 
  mutate(data = list(data %>% filter(between(yday,(peak_avg-25)-3, (peak_avg-25)+3))),
         season = "early") %>% 
  unnest(cols = c(data))

plot_df_peak <- plot_df %>% tidyr::nest() %>% 
  rowwise() %>% 
  mutate(peak_idx = which.max(data$ho_prob),
         peak_day = data$yday[peak_idx]) %>% ungroup() %>% 
  mutate(peak_avg = as.integer(mean(peak_day))) %>% 
  rowwise() %>% 
  mutate(data = list(data %>% filter(between(yday,(peak_avg)-3, (peak_avg)+3))),
         season = "peak") %>% 
  unnest(cols = c(data))

plot_df_late <- plot_df %>% tidyr::nest() %>% 
  rowwise() %>% 
  mutate(peak_idx = which.max(data$ho_prob),
         peak_day = data$yday[peak_idx]) %>% ungroup() %>% 
  mutate(peak_avg = as.integer(mean(peak_day))) %>% 
  rowwise() %>% 
  mutate(data = list(data %>% filter(between(yday,(peak_avg+25)-3, (peak_avg+25)+3))),
         season = "late") %>% 
  unnest(cols = c(data))

plot_df <- bind_rows(list(plot_df_early, plot_df_peak, plot_df_late)) %>% 
  mutate(date_start = case_when(
    season == "peak" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") - 3, "%d %b"),
    season == "early" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") - 28, "%d %b"),
    season == "late" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") + 22, "%d %b")
  )) %>% 
  mutate(date_end = case_when(
    season == "peak" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") + 3, "%d %b"),
    season == "early" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") - 22, "%d %b"),
    season == "late" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") + 28, "%d %b")
  )) %>% 
  mutate(season = forcats::fct_relevel(season, "early", "peak", "late"),
         season = forcats::fct_recode(season, "peak haul out - 25 days" = "early",
                             "peak haul out" = "peak",
                             "peak haul out + 25 days" = "late"))


p_temp <- ggplot(plot_df, 
                 aes(temp2*27, ho_prob, color = age_sex, fill = age_sex)) +
  geom_pointrange(aes(ymin = lower95, ymax = upper95), alpha = 0.1, stroke = 0) +
  geom_smooth(method = "lm", formula = y ~ x, size = 0.3, alpha = 0.1,
              show.legend = FALSE) +
  scale_fill_d3() +
  scale_color_d3(guide = guide_legend(override.aes = list(alpha = 1),
                                      direction = "horizontal")) +
  theme(legend.title = element_blank(),
        legend.position = "none") +
  facet_wrap(. ~ season + date_start + date_end, scales = "free_x",
             labeller = label_glue('{season}\n{date_start} - {date_end}')) +
  xlab("temperature (C)") + ylab("haul-out probability")

p_wind <- ggplot(plot_df, aes(wind*10, ho_prob, color = age_sex, fill = age_sex)) +
  geom_pointrange(aes(ymin = lower95, ymax = upper95), alpha = 0.1, stroke = 0) +
  geom_smooth(method = "lm", formula = y ~ x, size = 0.3, alpha = 0.1,
              show.legend = FALSE) +
  scale_fill_d3() +
  scale_color_d3(guide = guide_legend(override.aes = list(alpha = 0.75),
                                      direction = "horizontal")) +
  facet_wrap(. ~ season + date_start + date_end, scales = "free_x",
             labeller = label_glue('{season}\n{date_start} - {date_end}')) +
  theme(legend.title = element_blank(),
        legend.position = "bottom") +
  xlab("total wind (m/s)") + ylab("haul-out probability") 


library(patchwork)

p_temp / p_wind +
  plot_annotation(
    title = 'The influence of temperature and wind on predicted bearded seal \nhaul-out behavior varies within season',
    subtitle = 'data are subset to only include local solar hours between 0800 and 1600',
    caption = 'Solid lines represent linear fits to the predicted values and are \nprovided to better indicate marginal patterns.')
```

## Ribbon Seals

```{r hfnewdata}
targets::tar_load(ribbon_newdata, store = here::here("_targets"))
```

Ribbon seals show a pattern of gradually increasing haul-out probability
in April that peaks in late May for subadults and in early June for
adults (Figure \@ref(fig:ribbonHOCal)). The behavior is clearly centered
around local solar noon and expands to other hours later in the season
as seals enter their molting period. Subadults showed an earlier start
and more intense haul-out activity in April and May. The
young-of-the-year records begin after weaning and the model predictions
demonstrate the ontogeny of in-water activities (e.g. diving, foraging)
in May. Adult females have a more protracted haul-out season compared to
males, and more time spent resting in June and July. The model suggests
adult male ribbon seals complete their molt by the end of June. Lastly,
for adults of both sexes there is some indication for a shift to a
crepuscular haul-out pattern in late June and July.

```{r ribbonHOCal, fig.height = 5.5, include=TRUE, fig.id = "ribbonHOCal", fig.cap="Predicted haul-out probability of ribbon seals from 1 March to 15 July for each age and sex class used in the model. Adult females are indicated by 'ADULT.F' and 'ADULT.M' indicates adult males. 'SUBADULT' and 'YOUNG OF YEAR' age classes include both sexes."}

plot_df <- ribbon_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label = TRUE),
         day = lubridate::day(date)) %>%
  filter(month != "Aug")

p <- ggplot(plot_df, aes(day,solar_hour,fill = ho_prob)) +
  geom_tile(color = "white",size = 0) +
  scale_fill_viridis_c(name = "haul-out probability", aesthetics = "fill",
                       guide = guide_colorbar(title.position = "bottom", barwidth = 15,
                                              barheight = 0.5, title.hjust = 0.5)
  )
p <- p + facet_grid(age_sex~month)
p <- p + scale_x_continuous(breaks = c(1,10,20,30)) +
  scale_y_continuous(breaks = c(4,12,20))
p <- p + theme(legend.position = "bottom") +
  theme(strip.background = element_rect(colour = "white")) +
  theme(axis.ticks = element_blank()) +
  xlab("day of month") + ylab("local solar hour") +
  ggtitle("Ribbon seals rest on sea ice in late spring and around solar noon.")
p
```

The haul-out probability for ribbon seals was strongly influenced by
each of the weather covariates included within the model except
precipitation. The impacts of temperature
($F_{`r paste(ribbon_type3$temp2$Num.df, ribbon_type3$temp2$Den.df, sep=",")`}$
= `r ribbon_type3$temp2$F.value`; $p$ = `r ribbon_type3$temp2$Prob.F`),
wind
($F_{`r paste(ribbon_type3$wind$Num.df, ribbon_type3$wind$Den.df, sep=",")`}$
= `r ribbon_type3$wind$F.value`; $p$ = `r ribbon_type3$wind$Prob.F`),
and barometric pressure
($F_{`r paste(ribbon_type3$pressure$Num.df, ribbon_type3$pressure$Den.df, sep=",")`}$
= `r ribbon_type3$pressure$F.value`; $p$ =
`r ribbon_type3$pressure$Prob.F`) were especially noticeable as ribbon
seals were less likely to haul out at higher winds and lower pressure
values and more likely to haul out when temperatures were
relatively warm. Wind chill
($F_{`r paste(ribbon_type3$temp2_wind$Num.df, ribbon_type3$temp2_wind$Den.df, sep=",")`}$
= `r ribbon_type3$temp2_wind$F.value`; $p$ =
`r ribbon_type3$temp2_wind$Prob.F`) showed a moderately negative
influence on haul-out probability. As with bearded seals, Figure
\@ref(fig:ribbonHOwx) presents the predicted haul-out probability of
ribbon seals across the range of weather conditions encountered in the
observed data. Because our ribbon seal model included age and sex class, we can
visualize the different influences of weather covariates those classes. Of note,
there is an indication that sub-adult ribbon seals are more likely to haul-out
at lower temperatures. But, this may also be simply reflective of their
tendency to haul-out earlier in the season compared to adults.

```{r ribbonHOwx, fig.height = 5.5, include=TRUE, fig.id = "ribbonHOwx", fig.cap="Variability in predicted haul-out probability of ribbon seals across the range of weather conditions encountered in the observed data. Transparent vertical lines represent the 95% confidence interval around the predicted haul-out probability."}

plot_df <- ribbon_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label = TRUE),
         day = lubridate::day(date)) %>% 
  filter(age_sex != "YOUNG OF YEAR",
         between(solar_hour, 8,16)) %>% 
  group_by(age_sex)

plot_df_early <- plot_df %>% tidyr::nest() %>% 
  rowwise() %>% 
  mutate(peak_idx = which.max(data$ho_prob),
         peak_day = data$yday[peak_idx]) %>% ungroup() %>% 
  mutate(peak_avg = as.integer(mean(peak_day))) %>% 
  rowwise() %>% 
  mutate(data = list(data %>% filter(between(yday,(peak_avg-25)-3, (peak_avg-25)+3))),
         season = "early") %>% 
  unnest(cols = c(data))

plot_df_peak <- plot_df %>% tidyr::nest() %>% 
  rowwise() %>% 
  mutate(peak_idx = which.max(data$ho_prob),
         peak_day = data$yday[peak_idx]) %>% ungroup() %>% 
  mutate(peak_avg = as.integer(mean(peak_day))) %>% 
  rowwise() %>% 
  mutate(data = list(data %>% filter(between(yday,(peak_avg)-3, (peak_avg)+3))),
         season = "peak") %>% 
  unnest(cols = c(data))

plot_df_late <- plot_df %>% tidyr::nest() %>% 
  rowwise() %>% 
  mutate(peak_idx = which.max(data$ho_prob),
         peak_day = data$yday[peak_idx]) %>% ungroup() %>% 
  mutate(peak_avg = as.integer(mean(peak_day))) %>% 
  rowwise() %>% 
  mutate(data = list(data %>% filter(between(yday,(peak_avg+25)-3, (peak_avg+25)+3))),
         season = "late") %>% 
  unnest(cols = c(data))

plot_df <- bind_rows(list(plot_df_early, plot_df_peak, plot_df_late)) %>% 
  mutate(date_start = case_when(
    season == "peak" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") - 3, "%d %b"),
    season == "early" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") - 28, "%d %b"),
    season == "late" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") + 22, "%d %b")
  )) %>% 
  mutate(date_end = case_when(
    season == "peak" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") + 3, "%d %b"),
    season == "early" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") - 22, "%d %b"),
    season == "late" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") + 28, "%d %b")
  )) %>% 
  mutate(season = forcats::fct_relevel(season, "early", "peak", "late"),
         season = forcats::fct_recode(season, "peak haul out - 25 days" = "early",
                             "peak haul out" = "peak",
                             "peak haul out + 25 days" = "late"))


p_temp <- ggplot(plot_df, 
                 aes(temp2*27, ho_prob, color = age_sex, fill = age_sex)) +
  geom_pointrange(aes(ymin = lower95, ymax = upper95), alpha = 0.1, stroke = 0) +
  geom_smooth(method = "lm", formula = y ~ x, size = 0.3, alpha = 0.1,
              show.legend = FALSE) +
  scale_fill_d3() +
  scale_color_d3(guide = guide_legend(override.aes = list(alpha = 1),
                                      direction = "horizontal")) +
  theme(legend.title = element_blank(),
        legend.position = "none") +
  facet_wrap(. ~ season + date_start + date_end, scales = "free_x",
             labeller = label_glue('{season}\n{date_start} - {date_end}')) +
  xlab("temperature (C)") + ylab("haul-out probability")

p_wind <- ggplot(plot_df, aes(wind*10, ho_prob, color = age_sex, fill = age_sex)) +
  geom_pointrange(aes(ymin = lower95, ymax = upper95), alpha = 0.1, stroke = 0) +
  geom_smooth(method = "lm", formula = y ~ x, size = 0.3, alpha = 0.1,
              show.legend = FALSE) +
  scale_fill_d3() +
  scale_color_d3(guide = guide_legend(override.aes = list(alpha = 0.75),
                                      direction = "horizontal")) +
  facet_wrap(. ~ season + date_start + date_end, scales = "free_x",
             labeller = label_glue('{season}\n{date_start} - {date_end}')) +
  theme(legend.title = element_blank(),
        legend.position = "bottom") +
  xlab("total wind (m/s)") + ylab("haul-out probability") 


library(patchwork)

p_temp / p_wind +
  plot_annotation(
    title = 'The influence of temperature and wind on predicted ribbon seal \nhaul-out behavior varies within season',
    subtitle = 'data are subset to only include local solar hours between 0800 and 1600',
    caption = 'Solid lines represent linear fits to the predicted values and are \nprovided to better indicate marginal patterns.')
```

## Spotted Seals

```{r plnewdata}
targets::tar_load(spotted_newdata, store = here::here("_targets"))
```

Compared to ribbon seals, spotted seals showed a longer spring haul-out season
that is less intensely centered on solar noon (Figure \@ref(fig:spottedHOCal)).
Adults of both sexes spend considerable time in April, May and June hauled out.
In contrast to ribbon seals, adult spotted seal males have a more protracted
haul-out season compared to females, and more time out of the water in June and
July (Figures \@ref(fig:ribbonHOCal) and \@ref(fig:spottedHOCal)). As with
ribbon seals, the young-of-the-year records begin after weaning and the model
predictions demonstrate the ontogeny of in-water activities (e.g. diving,
foraging) in May.

```{r spottedHOCal, fig.height = 5.5, include=TRUE, fig.id = "spottedHOCal", fig.cap="Predicted haul-out probability of spotted seals from 1 March to 15 July for each age and sex class used in the model. Adult females are indicated by 'ADULT.F' and 'ADULT.M' indicates adult males. 'SUBADULT' and 'YOUNG OF YEAR' age classes include both sexes."}

plot_df <- spotted_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label=TRUE),
         day = lubridate::day(date)) %>%
  filter(month != "Aug")

p <- ggplot(plot_df,aes(day,solar_hour,fill=ho_prob))+
  geom_tile(color= "white",size = 0) +
  scale_fill_viridis_c(name = "haul-out probability", aesthetics = "fill",
                       guide = guide_colorbar(title.position = "bottom", barwidth = 15,
                                              barheight = 0.5, title.hjust = 0.5)
  )
p <- p + facet_grid(age_sex~month)
p <- p + scale_x_continuous(breaks = c(1,10,20,30)) +
  scale_y_continuous(breaks = c(4,12,20))
p <- p + theme(legend.position = "bottom") +
  theme(strip.background = element_rect(colour="white")) +
  theme(axis.ticks=element_blank()) +
  xlab("day of month") + ylab("local solar hour") +
  ggtitle("Spotted seals rest on sea ice in late spring and around solar noon.")
p
```

Spotted seal haul-out behavior appears most strongly influenced by
temperature
($F_{`r paste(spotted_type3$temp2$Num.df, spotted_type3$temp2$Den.df, sep=",")`}$
= `r spotted_type3$temp2$F.value`; $p$ = `r spotted_type3$temp2$Prob.F`)
and wind
($F_{`r paste(spotted_type3$wind$Num.df, spotted_type3$wind$Den.df, sep=",")`}$
= `r spotted_type3$wind$F.value`; $p$ = `r spotted_type3$wind$Prob.F`)
with barometric pressure having a moderate influence
($F_{`r paste(spotted_type3$pressure$Num.df, spotted_type3$pressure$Den.df, sep=",")`}$
= `r spotted_type3$pressure$F.value`; $p$ =
`r spotted_type3$pressure$Prob.F`). Spotted seals were less likely to
haul out at higher winds and more likely to be on the ice when
temperatures were relatively warm. Wind chill (*temperature:wind*) and
precipitation were not as influential as the other covariates.
Differences in the magnitude of response between the age-sex classes are
present and consistent across each of the weather covariates (Figure
\@ref(fig:spottedHOwx)). There is a consistent ranking of adult males being the most
likely to haul out, followed by adult females, and, then, subadults.

```{r spottedHOwx,fig.height = 5.5, include=TRUE, fig.id = "spottedHOwx", fig.cap="Variability in the predicted haul-out probability of spotted seals across the range of weather conditions encountered in the observed data. Transparent vertical lines represent the 95% confidence interval around the predicted haul-out probability."}

plot_df <- spotted_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label = TRUE),
         day = lubridate::day(date)) %>% 
  filter(age_sex != "YOUNG OF YEAR",
         between(solar_hour, 8,16)) %>% 
  group_by(age_sex)

plot_df_early <- plot_df %>% tidyr::nest() %>% 
  rowwise() %>% 
  mutate(peak_idx = which.max(data$ho_prob),
         peak_day = data$yday[peak_idx]) %>% ungroup() %>% 
  mutate(peak_avg = as.integer(mean(peak_day))) %>% 
  rowwise() %>% 
  mutate(data = list(data %>% filter(between(yday,(peak_avg-25)-3, (peak_avg-25)+3))),
         season = "early") %>% 
  unnest(cols = c(data))

plot_df_peak <- plot_df %>% tidyr::nest() %>% 
  rowwise() %>% 
  mutate(peak_idx = which.max(data$ho_prob),
         peak_day = data$yday[peak_idx]) %>% ungroup() %>% 
  mutate(peak_avg = as.integer(mean(peak_day))) %>% 
  rowwise() %>% 
  mutate(data = list(data %>% filter(between(yday,(peak_avg)-3, (peak_avg)+3))),
         season = "peak") %>% 
  unnest(cols = c(data))

plot_df_late <- plot_df %>% tidyr::nest() %>% 
  rowwise() %>% 
  mutate(peak_idx = which.max(data$ho_prob),
         peak_day = data$yday[peak_idx]) %>% ungroup() %>% 
  mutate(peak_avg = as.integer(mean(peak_day))) %>% 
  rowwise() %>% 
  mutate(data = list(data %>% filter(between(yday,(peak_avg+25)-3, (peak_avg+25)+3))),
         season = "late") %>% 
  unnest(cols = c(data))

plot_df <- bind_rows(list(plot_df_early, plot_df_peak, plot_df_late)) %>% 
  mutate(date_start = case_when(
    season == "peak" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") - 3, "%d %b"),
    season == "early" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") - 28, "%d %b"),
    season == "late" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") + 22, "%d %b")
  )) %>% 
  mutate(date_end = case_when(
    season == "peak" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") + 3, "%d %b"),
    season == "early" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") - 22, "%d %b"),
    season == "late" ~ format(lubridate::as_date(peak_avg, origin = "2015-01-01") + 28, "%d %b")
  )) %>% 
  mutate(season = forcats::fct_relevel(season, "early", "peak", "late"),
         season = forcats::fct_recode(season, "peak haul out - 25 days" = "early",
                             "peak haul out" = "peak",
                             "peak haul out + 25 days" = "late"))


p_temp <- ggplot(plot_df, 
                 aes(temp2*27, ho_prob, color = age_sex, fill = age_sex)) +
  geom_pointrange(aes(ymin = lower95, ymax = upper95), alpha = 0.1, stroke = 0) +
  geom_smooth(method = "lm", formula = y ~ x, size = 0.3, alpha = 0.1,
              show.legend = FALSE) +
  scale_fill_d3() +
  scale_color_d3(guide = guide_legend(override.aes = list(alpha = 1),
                                      direction = "horizontal")) +
  theme(legend.title = element_blank(),
        legend.position = "none") +
  facet_wrap(. ~ season + date_start + date_end, scales = "free_x",
             labeller = label_glue('{season}\n{date_start} - {date_end}')) +
  xlab("temperature (C)") + ylab("haul-out probability")

p_wind <- ggplot(plot_df, aes(wind*10, ho_prob, color = age_sex, fill = age_sex)) +
  geom_pointrange(aes(ymin = lower95, ymax = upper95), alpha = 0.1, stroke = 0) +
  geom_smooth(method = "lm", formula = y ~ x, size = 0.3, alpha = 0.1,
              show.legend = FALSE) +
  scale_fill_d3() +
  scale_color_d3(guide = guide_legend(override.aes = list(alpha = 0.75),
                                      direction = "horizontal")) +
  facet_wrap(. ~ season + date_start + date_end, scales = "free_x",
             labeller = label_glue('{season}\n{date_start} - {date_end}')) +
  theme(legend.title = element_blank(),
        legend.position = "bottom") +
  xlab("total wind (m/s)") + ylab("haul-out probability") 


library(patchwork)

p_temp / p_wind +
  plot_annotation(
    title = 'The influence of temperature and wind on predicted spotted seal \nhaul-out behavior varies within season',
    subtitle = 'data are subset to only include local solar hours between 0800 and 1600',
    caption = 'Solid lines represent linear fits to the predicted values and are \nprovided to better indicate marginal patterns.')
```


## Annual variation in haul-out

```{r hfpvyear}
targets::tar_load(ribbon_newdata_year, store = here::here("_targets"))
targets::tar_load(spotted_newdata_year, store = here::here("_targets"))
```

```{r type3_year}
ribbon_year_type3 <- tibble(
  ribbon_year_fit$typeIII.hypoth
) %>% 
  mutate(# Prob.F = ifelse(Prob.F<0.001, "<0.01",Prob.F),
         Prob.F = scales::pvalue(Prob.F),
         Effect = janitor::make_clean_names(Effect)) %>% 
  column_to_rownames(var = "Effect") 
ribbon_year_type3 <- setNames(split(ribbon_year_type3, 
                               seq(nrow(ribbon_year_type3))), 
                         rownames(ribbon_year_type3))

spotted_year_type3 <- tibble(
  spotted_year_fit$typeIII.hypoth
) %>% 
  mutate(# Prob.F = ifelse(Prob.F<0.001, "<0.01",Prob.F),
         Prob.F = scales::pvalue(Prob.F),
         Effect = janitor::make_clean_names(Effect)) %>%  
  column_to_rownames(var = "Effect")  
spotted_year_type3 <- setNames(split(spotted_year_type3, 
                               seq(nrow(spotted_year_type3))), 
                         rownames(spotted_year_type3))
```

The second set of models that included annual variation in haul-out
patterns uncovered significant contributions for linear and quadratic
interactions between day and year in both ribbon seals (day:year,
$F_{`r paste(ribbon_year_type3$day_year$Num.df, ribbon_year_type3$day_year$Den.df, sep=",")`}$
= `r ribbon_year_type3$day_year$F.value`; $p$ =
`r ribbon_year_type3$day_year$Prob.F`; day^2^:year,
$F_{`r paste(ribbon_year_type3$day2_year$Num.df, ribbon_year_type3$day2_year$Den.df, sep=",")`}$
= `r ribbon_year_type3$day2_year$F.value`; $p$ =
`r ribbon_year_type3$day2_year$Prob.F`) and spotted seals (day:year,
$F_{`r paste(spotted_year_type3$day_year$Num.df, spotted_year_type3$day_year$Den.df, sep=",")`}$
= `r spotted_year_type3$day_year$F.value`; $p$ =
`r spotted_year_type3$day_year$Prob.F`; day^2^:year,
$F_{`r paste(spotted_year_type3$day2_year$Num.df, spotted_year_type3$day2_year$Den.df, sep=",")`}$
= `r spotted_year_type3$day2_year$F.value`; $p$ =
`r spotted_year_type3$day2_year$Prob.F`). Predicted distributions of
haul-out activity were largely unimodal, but varied some among and
within years with respect to the timing and magnitude of haul-out peaks
(Figure \@ref(fig:annualHO)). It is important to note that predicted
variation in annual haul-out patterns likely reflects both process error
and sampling variability. While we did remove any years where only one
deployment in a species + age-sex group was present, there are still
some years where the pattern shown is informed by a small number of
individuals that may not represent population level processes.

```{r annualHO, fig.height = 5.5, include=TRUE, fig.id = "annualHO", fig.cap="Annual variability in the timing of peak haul-out probability for ribbon and spotted seals across 10 years. Predictions are shown for local solar noon and under smoothed weather conditions. Only those groups (age-sex + year) that included observations from more than one seal are shown. Additionally, any groups where the underlying data started after 1 June or ended before 1 May are not included."}

select_groups <- ribbon_year_fit$dataset %>%
  filter(age_sex != "YOUNG OF YEAR") %>%
  group_by(age_sex, year) %>%
  summarise(n = n_distinct(speno), group_id = paste0(age_sex,year)) %>%
  filter(n >1) %>% pull(group_id)

plot_df <- ribbon_newdata_year %>%
  mutate(species = "Ribbon seal",
         date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label=TRUE),
         day = lubridate::day(date)) %>%
  filter(month != "Aug", paste0(age_sex,year) %in% select_groups)

peak_ho_df <- plot_df %>% filter(age_sex != "YOUNG OF YEAR",
                                 yday > 100) %>%
  group_by(species, age_sex, year) %>% slice_max(ho_prob)

select_groups <- spotted_year_fit$dataset %>%
  filter(age_sex != "YOUNG OF YEAR") %>%
  group_by(age_sex, year) %>%
  summarise(n = n_distinct(speno), group_id = paste0(age_sex,year)) %>%
  filter(n >1) %>% pull(group_id)

plot_df2 <- spotted_newdata_year %>%
  mutate(species = "Spotted seal",
         date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label=TRUE),
         day = lubridate::day(date)) %>%
  filter(month != "Aug", paste0(age_sex,year) %in% select_groups)

peak_ho_df2 <- plot_df2 %>% filter(age_sex != "YOUNG OF YEAR",
                                 yday > 100) %>%
  group_by(species, age_sex, year) %>% slice_max(ho_prob)

plot_df <- plot_df %>% 
  bind_rows(plot_df2) %>% 
  mutate(year = forcats::fct_relevel(.$year, sort))
peak_ho_df <- peak_ho_df %>% 
  bind_rows(peak_ho_df2) %>% ungroup() %>% 
  mutate(year = forcats::fct_relevel(.$year, sort))

pal <- c(RColorBrewer::brewer.pal(12, "Paired"), "black")

p <- ggplot(plot_df %>% filter(age_sex != "YOUNG OF YEAR"), aes(yday, ho_prob)) +
  geom_pointrange(aes(ymin = lower95, ymax = upper95), alpha = 0.25, 
                  stroke = 0, color = "grey80") +
  geom_pointrange(data = peak_ho_df,
                  mapping = aes(yday, ho_prob, ymin = 0, ymax = ho_prob, color = year),
                  shape = 15) +
  scale_color_discrete(type = pal) +
  scale_x_continuous(breaks = c(74,105,135,166),
                     labels = c("15-Mar", "15-Apr", "15-May", "15-Jun")) +
  facet_grid(age_sex~species) +
  theme(legend.position = "bottom") +
  xlab("") + ylab("haul-out probability") +
  ggtitle("Annual variability in the timing of peak haul-out probability")
 p
```

```{r}
load(here::here('data/seaice_extent.Rdata'))

extent_max <- extent_df %>% 
  group_by(year) %>% 
  slice_max(area_km2_epsg3571) %>% 
  ungroup() %>% 
  rename(max_extent_km2 = area_km2_epsg3571,
         max_extent_yday = yday) %>% 
  dplyr::select(-fdate)

extent_lookup <- extent_df %>% 
  dplyr::select(fdate, area_km2_epsg3571) %>% 
  rename(extent_km2 = area_km2_epsg3571)

peak_ho_df <- peak_ho_df %>% left_join(extent_max, 
                         by = "year") %>% 
  left_join(extent_lookup, by = c("date" = "fdate")) %>% 
  mutate(peak_diff_days = yday - max_extent_yday) %>% 
  distinct() %>% 
  mutate(max_extent_km2 = max_extent_km2/1000)

models <- peak_ho_df %>% 
  group_by(species, age_sex) %>%  
  nest() %>% 
  mutate(model = map(data, ~ lm(max_extent_km2 ~ yday, data = .x))) %>% 
  mutate(glance = map(model, broom::glance)) %>% 
  unnest(glance)

hf_adultF <- models %>% filter(species == "Ribbon seal" & age_sex == "ADULT.F") %>% 
  dplyr::select(r.squared, statistic, p.value)
hf_adultM <- models %>% filter(species == "Ribbon seal" & age_sex == "ADULT.M") %>% 
  dplyr::select(r.squared, statistic, p.value)
hf_subadult <- models %>% filter(species == "Ribbon seal" & age_sex == "SUBADULT") %>% 
  dplyr::select(r.squared, statistic, p.value)
pl_adultF <- models %>% filter(species == "Spotted seal" & age_sex == "ADULT.F") %>% 
  dplyr::select(r.squared, statistic, p.value)
pl_adultM <- models %>% filter(species == "Spotted seal" & age_sex == "ADULT.M") %>% 
  dplyr::select(r.squared, statistic, p.value)
pl_subadult <- models %>% filter(species == "Spotted seal" & age_sex == "SUBADULT") %>% 
  dplyr::select(r.squared, statistic, p.value)

```

The timing of peak haul-out probability for ribbon and spotted seals
appeared to have a limited to no relationship with the amount of
yearly maximum sea ice extent. Adult female and subadult spotted seals
show a negative trend line, but there is no indication that the observed
trend is meaningful (spotted seal adult female: $R^{2}$ =
`r pl_adultF$r.squared`, $p$ = `r pl_adultF$p.value`; spotted seal
subadults: $R^{2}$ = `r pl_subadult$r.squared`, $p$ =
`r pl_subadult$p.value`). For ribbon seals and adult male spotted seals,
$p$-values were substantially larger than 0.05 (ribbon seal adult
females; $R^{2}$ = `r hf_adultF$r.squared`, $p$ = `r hf_adultF$p.value`;
ribbon seal adult males: $R^{2}$ = `r hf_adultM$r.squared`, $p$ =
`r hf_adultM$p.value`; ribbon seal subadults: $R^{2}$ =
`r hf_subadult$r.squared`, $p$ = `r hf_subadult$p.value`; spotted seals
adult males: $R^{2}$ = `r pl_adultM$r.squared`, $p$ =
`r pl_adultM$p.value`).

```{r maxextentHO, fig.height = 5.5, include=FALSE, fig.id = "maxextent", fig.cap="Annual timing of peak haul-out behavior analyzed against the yearly maximum area of sea ice extent in the study area. While spotted seal adult females and subadults show a negative trend line, none of the relationships were determined to be significant."}

ggplot(data = peak_ho_df, aes(y = yday, x = max_extent_km2, color = species)) + 
  geom_smooth(method = "lm", alpha = 0.2, aes(fill = species)) +
  geom_point() +
  facet_grid(age_sex~.) +
  scale_y_continuous(breaks = c(125,135,145, 156),
                     labels = c("05-May", "15-May", "25-May", "05-Jun")) +
  scale_color_manual(values = c('#E66100','#5D3A9B'), name = "") +
  scale_fill_manual(values = c('#E66100','#5D3A9B'), name = "") +
  theme(legend.position = "top",
        legend.justification = "right") +
  labs(y = "date of peak haul-out", x = "maximum sea ice extent (km<sup>2</sup> / 1000)",
       title = "The connection between yearly maximum sea ice extent and the \ntiming of peak haul-out probability is limited") +
  theme(axis.title.x = element_markdown())
  
```

# Discussion

We modeled data from bio-loggers deployed on bearded, ribbon, and spotted seals
to examine factors affecting haul-out behavior on sea ice in the Bering and
Chukchi seas. Our analysis shows all three species of seal haul out
progressively more through the spring and peak near mid-May to early June before
declining again. This pattern aligns well with what has been previously
documented and confirms our haul-out data are likely capturing population-level
behavioral patterns. Seals preferentially haul out on ice shortly after solar
noon, which allows seals to maximize absorption of solar radiation thought to
facilitate the molting process [@feltz1966]. Interestingly, bearded seals appear
to have two peaks in haul-out activity within a day, one shortly after solar
noon, and one centered near solar midnight. This, of course, could be an
artifact of our limited sample size for bearded seal deployments across all age
classes. However, a similar bi-modal pattern has been seen in ringed seals
[@vonduyke2020] and suggests that bearded and ringed seals may be operating
under different constraints than ribbon and spotted seals. Bearded and ringed
seals are distributed across higher latitudes and the extended daylight hours
may allow more flexibility in optimizing resting periods with foraging. Other
factors such as predation by polar bears (which is rare for ribbon and spotted
seals in the Bering Sea) may also explain differing haul-out patterns. Bearded
seals also showed a more protracted season of haul-out behavior compared to
ribbon and spotted seals. This aligns with findings from Thometz et al.
[@thometz2021] who observed a mean molting period of 119&pm;2 days and a
relatively stable resting metabolic rate during that time. While ribbon seals
were not considered in the same study, spotted and ringed seals underwent molt
periods of 33&pm;4 and 28&pm;6 days and exhibited increased resting metabolic
rates.

Unlike previous analyses of seal haul-out behavior (e.g. [@verhoef2010a],
[@conn2014a]), we also investigated the influence of sex-age class on haul-out
probabilities for all species except bearded seals because of low sample size.
Although ribbon and spotted seals exhibited a unimodal diel haul-out pattern
generally centered around local solar noon, there were key differences across
species, age, and sex that match expectations given what we know of their
ecological behavior. Spotted seals are known to form triads during the breeding
season [@burns1973] where a female and dependent pup are accompanied on the ice
by a suitor male. The male waits for the female to wean the pup and enter
estrus, and fends off any other potential suitor males. Triad formation results
in both males and females spending a large portion of the day hauled out on ice
and a protracted spring haul-out season for both sexes. Because mating occurs in
the water, females may also be less inclined to interrupt their haul-out with
foraging trips while still nursing the pup. We see this reflected in the
predicted haul-out behavior, with both males and females exhibiting a broad
distribution of time out of the water throughout the solar day and the
season.Ribbon seals are not known to form triads and our model predicts a
progression of increased haul-out behavior with females starting earlier in the
season than males. Notably, female ribbon seals spend a large portion of the day
in the water during the pupping period, aligning with the hypothesis that ribbon
seal females continue foraging while nursing.  In the case of both ribbon and
spotted seals, subadults are the first to begin consistent haul-out behavior and
follow a typical phocid pattern where subadults molt first as they do not have
any reproductive constraints.

We also investigated the influence of weather on haul-out probabilities,
including wind speed, temperature, barometric pressure, precipitation, and wind
chill. These have been investigated for walruses (e.g. Udevitz et al.
[-@udevitz2009]) and a few select studies of ice-associated seals
[@hamilton2018, @perry2017]. Ribbon seals seemed to be the most influenced by
weather, with wind, temperature, barometric pressure, and precipitation all
being important components of the model. Spotted seals were most affected by
wind and barometric pressure. And, for bearded seals, the model indicated wind
and temperature had the greatest impact. In general, and as might be expected,
seals were more likely to haul-out when daily temperatures were warmer, winds
speeds were lower, barometric pressure was higher, and precipitation was lower.
These weather conditions are general indicators of increased solar radiation
which provides energetic benefits. Low winds and precipitation may also
provide an optimal situation for predator detection. Our results highlight the
importance of incorporating weather covariates when analyzing haul-out 
behavior and calculating availability corrections for aerial surveys.

Our models detected small deviations in the timing and magnitude of annual peaks
in haul-out behavior for ribbon and spotted seals. The timing of peak haul-out
activity appears to fall within a relatively narrow time window of 3-4 weeks in
late May and early June. This consistency across 15 years is likely a reflection
of the relationship between a critical photoperiod and the timing of important
life history stages [@bronson2009; @temte1994]. However, along with a critical
photoperiod, ribbon and spotted seals are dependent upon the presence of sea ice
for pupping and molt. We didn't find any support in our models for a
relationship between the timing of peaks in haul-out behavior and the amount of
yearly maximum sea ice. This could indicate that, while the extent of spring sea
ice in the Bering sea varied widely during our study period, seals were still
able to locate sea ice and haul out. We should expect, however, that some
minimal threshold in the spatial extent or density of sea ice will have a
meaningful impact on the timing of peak haul-out behavior -- if there is no sea
ice, seals will not haul out. Additionally, while from an ecological perspective
the haul-out behavior appears consistent, the interannual differences in timing
and magnitude are large enough to have important ramifications on calculations
of abundance and trend. Those ramifications will only be exacerbated if climate
variability amplifies interannual differences.

Previous attempts to estimate the abundance of phocid seals from aerial survey
data in the Bering and Chukchi seas (e.g. [@bengtson2005a], [@conn2014a],
[@verhoef2014a]) have used estimated haul-out probabilities to correct for the
proportion of animals that are in the water and thus unavailable to be counted.
Although several of these studies allowed haul-out probabilities to vary by
day-of-year and time-of-day, they have not accounted for variability among
years, in weather conditions, and in the age-sex class of the sample. In this
paper, we have shown that there can be considerable differences in the number of
seals hauled out on ice based on these factors. We recommend that future
abundance analyses employ availability models that account for these factors. For
instance, it is relatively straightforward to obtain weather reanalysis products
for times and locations that are surveyed and to construct a relevant correction
factor based on predictions of GLMPMs. The most challenging element in
developing availability correction factors is with annual variability. It can be
difficult to get a sufficient sample size to estimate year-specific correction
factors, particularly because research teams would likely need to tag seals and
conduct aerial surveys concurrently which requires considerably more personnel
and money. One possible suggestion is to estimate a "shift" parameter within
models for aerial survey counts that allow the peak of haul-out distributions to
be adjusted earlier or later in the year based on the frequency of counts
observed over time. Regardless, researchers should anticipate there being some
unmodeled heterogeneity in availability probability present in abundance
estimates obtained from aerial surveys. This may make trend detection difficult,
as one will not know if moderate differences in abundance estimates are
attributable to changes in abundance or changes in haul-out behavior.

Predictions of absolute haul-out probability in this paper were somewhat
different than those previously reported for these species, especially for
bearded seals. For instance, Ver Hoef et al. [-@verhoef2014a)] and Conn et al.
[-@conn2014a] used haul-out correction factors with maximums of 0.66 for bearded
seals, 0.62 for ribbon seals, and 0.54 for spotted seals, where maximums
corresponded to times near solar noon in mid-late May. Applying models that
ignore age, sex, and year effects, these probabilities were 0.38, 0.72, and
0.60, respectively, under the current analysis framework. Our current estimates
of haul-out probability reflect increased sample sizes in terms of
number of animals, but also improvements to the way data were prepared prior to
analysis.

We focused this paper on haul-out behavior of bearded, ribbon, and spotted
seals. Ringed seals are also present in the Bering and Chukchi seas but exhibit
a unique complicating factor. Adult ringed seals build subnivean lairs in the
snow on top of the sea ice, where they haul out and pup until snow melt causes
their lairs to collapse [@kelly1990]. Thus, the wet-dry sensor on a bio-logger
could indicate that an animal is hauled out, but if it is within a lair, it is
not available to be detected during an aerial survey. We hope to address
availability of ringed seals using data from satellite tags, replicate survey
tracks, and auxiliary information about snow depth and timing of melt in a
future study.

# Author Contributions

**Josh M. London**: investigation, conceptualization, methodology,
formal analysis, validation, software, writing: original draft, writing:
review and editing, visualization, and data curation

**Paul B. Conn**: conceptualization, methodology, formal analysis,
software, validation, writing: original draft, writing: review and
editing

**Stacie K. Hardy**: investigation, data curation, methodology,
validation, writing: review and editing

**Erin L. Richmond**: data curation, investigation, methodology,
validation, writing: review and editing

**Jay M. Ver Hoef**: conceptualization, methodology, software, writing:
review and editing

**Michael F. Cameron**: investigation, project administration, writing:
review and editing

**Justin Crawford**: investigation, methodology, validation, data curation, 
writing: review and editing

**Lori T. Quakenbush**: investigation, methodology, supervision, project
administration, writing: review and editing

**Andrew L. Von Duyke**: investigation, methodology, validation, data curation,
writing: review and editing

**Peter L. Boveng**: investigation, conceptualization, supervision,
project administration, writing: review and editing

# Data Availability

This manuscript was developed as a reproducible research compendium. Data and
code are available on GitHub (https://github.com/jmlondon/berchukHaulout) and
major versions archived at Zenodo (https://doi.org/10.5281/zenodo.4638221).
Original data sources for telemetry are archived at the United States Animal
Telemetry Network.

# Acknowledgements

We recognize that the species and ecosystems studied in this paper are within
the traditional range of the Inpuiaq and Yupik people. And, we would like to
acknowledge and thank them as the original stewards of these ecosystems. The
deployment of bio-logging devices used in this study were often done in
collaboration with Alaska Native seal hunters and their communities. We would
like to especially acknowledge the communities of Kotzebue, Koyuk, Utqiaġvik,
and Ulguniq (Wainwright) and the following individuals: James Adams, Jeff
Barger, David Barr, Wendell Booth, Cyrus Harris, Nereus 'Doc' Harris, Grover
Harris, Lee Harris, Tom Jones, Frank Garfield, Brenda Goodwin, Henry Goodwin,
John Goodwin, Pearl Goodwin, Willie Goodwin, Brett Kirk, Noah Naylor, Virgil
Naylor Jr., Virgil Naylor Sr., Dan Savetilik, Allen Stone, and Randy Toshavik
from Kotzebue, Alaska; Merlin Henry from Koyuk, Alaska; Billy Adams, Mary-Ellen
Ahmaogak, James Aiken, Tim Aiken, Sarah Coburn, Jason Herreman, Howard Kittick,
Gilbert Leavitt, Isaac Leavitt, J.R. Leavitt, Enoch Oktollik, Shawn Oktollik,
Stacey Osborn, Fred Rexford, Chuck Schaeffer, Ross Schaeffer, Bob Shears, and
Joe Skin from the North Slope Borough, Alaska;

We are grateful for the assistance in catching and sampling seals by
James Bailey, Michelle Barbieri, John Bengtson, Gavin Brady, Vladamir
Burkanov, Cynthia Christman, Shawn Dahle, Rob Delong, Stacy DiRocco, Deb
Fauquier, Shannon Fitzgerald, Kathy Frost, Scott Gende, Tracey
Goldstein, Jeff Harris, Markus Horning, John Jansen, Shawn Johnson,
Charles Littnan, Lloyd Lowry, Erin Moreland, Mark Nelson, Lorrie Rea, Gay Sheffield,
Brent Stewart, and Dave Withrow. We also appreciate the commitment to
science and safety by all officers and crew of the NOAA Ship Oscar
Dyson, the NOAA Ship MacArthur II, and the RV Thomas G. Thompson.

Telemetry data from the Alaska Department of Fish and Game (ADFG) and the North
Slope Borough Department of Wildlife Management (NSB) were important
contributions to the findings presented here. Both agencies collaborate closely
with Alaska Native communities and the contributions of local hunters to the
successful capture, deployment, and understanding of seal ecology are
invaluable. Deployments in the western Bering Sea were done in collaboration
with Russian colleagues and North Pacific Wildlife.

The findings and conclusions in the paper are those of the author(s) and do not
necessarily represent the views of the National Marine Fisheries Service, NOAA.
Any use of trade, product, or firm names does not imply an endorsement by the
U.S. Government. Funding for this study was provided by the U.S. National
Oceanic and Atmospheric Administration. The field work was conducted under the
authority of Marine Mammal Protection Act Research Permits Nos. 782-1676,
782-1765, 15126, and 19309 issued by the National Marine Fisheries Service, and
Letters of Assurance of Compliance with Animal Welfare Act regulations, Nos.
A/NW 2010-3 and A/NW 2016-1 from the Alaska Fisheries Science Center/Northwest
Fisheries Science Center Institutional Animal Care and Use Committee (IACUC). ).
Funding to ADFG for tagging seals was provided by the Bureau of Ocean Energy
Management (No. M13PC0015) and the Office of Naval Research (No.
N00014-16-1-3019). ADFG and NSB field work was covered by Research Permits Nos.
358-1585, 358-1787, 15324, and 20466 and by ADF&G IACUC permits Nos. 06-16,
09-21, 2014-03, 2015-25, 2016-23, 0027-2017-27, 0027-2018-29, 0027-2019-041.

# References

::: {#refs}
:::
