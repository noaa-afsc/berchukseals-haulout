---
title: Spring haul-out behavior of seals in the Bering and Chukchi seas
preprint: false
author: 
  - name: Josh M. London
    email: josh.london@noaa.gov
    affiliation: 1
    corresponding: true
  - name: Paul B. Conn
    affiliation: 1
  - name: Stacie M. Koslovsky
    affiliation: 1
  - name: Erin L. Richmond
    affiliation: 1
  - name: Jay M. Ver Hoef
    affiliation: 1
  - name: Michael F. Cameron
    affiliation: 1
  - name: Justin A. Crawford
    affiliation: 2
  - name: Andrew L. Von Duyke
    affiliation: 3
  - name: Lori T. Quakenbush
    affiliation: 2
  - name: Peter L. Boveng
    affiliation: 1
affiliation:
  - code: 1
    address: Marine Mammal Laboratory, Alaska Fisheries Science Center, National Marine Fisheries Service, NOAA, Seattle, Washington, USA
  - code: 2
    address: Arctic Marine Mammals Program, Alaska Department of Fish and Game, Fairbanks, Alaska, USA
  - code: 3
    address: Department of Wildlife Management, North Slope Borough, Utqiaġvik, Alaska, USA
abstract: >
  Ice-associated seals rely on sea ice for a variety of activities, including
  breeding, molting, pupping, and resting. In the Arctic, many of these activities
  occur in spring (April -- June) as sea ice begins to melt and retreat northward.
  Rapid acceleration of climate change in Arctic ecosystems is therefore of
  concern as the quantity and quality of suitable habitat is forecast to decrease.
  Improved estimates of seal population abundance are needed to properly monitor
  the impacts of these changes over time. In this paper, we use hourly
  percent-dry data from satellite-linked bio-loggers deployed
  between 2005 and 2021 to quantify the proportion of seals hauled out on ice.
  This information is needed to accurately estimate abundance from aerial survey counts of
  ice-associated seals (i.e., to correct for the proportion of animals that
  are in the water while surveys are conducted). In addition to providing
  essential data for survey 'availability' calculations, our analysis also provides 
  insights into the seasonal timing and environmental
  factors affecting haul-out behavior by ice-associated seals. We specifically
  focused on bearded (_Erignathus barbatus_), ribbon (_Histriophoca fasciata_),
  and spotted seals (_Phoca largha_) in the Bering and Chukchi seas. Because
  ringed seals (_Phoca hispida_) can be out of the water but hidden from view in
  snow lairs, they were not included in this analysis. Using generalized linear mixed
  pseudo-models to properly account for temporal autocorrelation, we fit models
  with covariates of interest (e.g., day-of-year, solar hour, age-sex class, wind
  speed, barometric pressure, temperature, precipitation) to examine their ability
  to explain variation in haul-out probability. We found evidence for
  strong diel and within-season patterns in haul-out behavior, as well as
  strong weather effects (particularly wind and temperature). In general, seals
  were more likely to haul out on ice in the middle of the day and when wind speed
  was low and temperatures were higher. Haul-out probability increased through
  March and April, peaking in May and early June before declining again. The
  timing and frequency of haul-out events also varied based on species and age-sex
  class. For ribbon and spotted seals, models with year effects were highly
  supported, indicating that the timing and magnitude of haul-out behavior varied
  among years. However, we did not find broad evidence that haul-out timing was linked
  to annual sea ice extent. Our analysis emphasizes the importance of accounting
  for seasonal and temporal variation in haul-out behavior, as well as associated
  environmental covariates, when interpreting the number of seals counted in
  aerial surveys.
output:
  bookdown::pdf_book:
    base_format: rticles::peerj_article # for using bookdown features like \@ref()
header-includes:
  - \usepackage{stix2}
  - \usepackage {booktabs}
  - \usepackage {setspace}
  - \onehalfspacing
  - \usepackage [T1]{fontenc}
  - \usepackage [semibold]{sourcesanspro}
  - \usepackage {hyperref}
  - \hypersetup {colorlinks, linkcolor={red!50!black}, citecolor={blue!50!black},urlcolor={blue!80!black}}
  - \usepackage {pdflscape}
  - \newcommand {\blandscape}{\begin{landscape}}
  - \newcommand {\elandscape}{\end{landscape}}
  - \usepackage {caption}
  - \captionsetup{font={normalsize,onehalfspacing}}
  - \newcommand{\beginsupplement}{\setcounter{table}{0}\renewcommand{\thetable}{S\arabic{table}}\setcounter{figure}{0}\renewcommand{\thefigure}{S\arabic{figure}}}
bibliography: references.json
csl: peerj.csl
---

```{r setup, include = FALSE}
library(targets)
library(conflicted)
library(tidyverse)
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
library(lubridate)
conflict_prefer("month","lubridate")
library(glue)
library(scales)
library(DBI)
library(dbplyr)
library(RPostgres)
library(pingr)
library(sf)
library(flextable)
library(gt)
library(patchwork)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggspatial)
library(ggsci)
library(ggrepel)
library(gghighlight)
library(ggtext)
library(glmmLDTS)
library(mgcv)
library(ragg)
library(MetBrewer)
library(terra)

knitr::opts_chunk$set(dev = "ragg_png")

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  include = FALSE,
  fig.path = "../figures/",
  dpi = 300,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "100%",
  tab.topcaption = TRUE
)

options(scipen = 3, digits = 3)

theme_set(theme_minimal(base_family = 'Spline Sans',
                        base_size = 9))
theme_update(
  plot.title.position = "plot",
  # left-align title
  plot.caption.position = "plot",
  # right-align caption
  plot.title = element_text(face = "bold"),
  # larger, bold title
  plot.subtitle = element_textbox_simple(
    color = "grey30",
    margin = ggplot2::margin(t = 0, b = 12, r = 60)
  ),
  plot.caption = element_markdown(color = "grey30"),
  # change color of caption
  panel.grid.minor = element_blank() # no minor grid lines
)

# use a named vector for explicit matching
species_colors <- c(
  'Spotted seal' = "#52BCA3",
  'Bearded seal' = "#E58606",
  'Ribbon seal' = "#5D69B1"
)

age_sex_labels <- c(
  "ADULT.F" = "adult female",
  "ADULT.M" = "adult male",
  "SUBADULT" = "subadult",
  "YOUNG OF YEAR" = "young of year",
  "ALL AGES" = "all ages"
)

```

# Introduction {-}

The global climate disruption is causing considerable reduction in Arctic sea
ice extent, volume, and seasonal presence [@kwok2018;
@meier2014; @overland2021; @wang2018]. These changes have tangible effects on
Arctic organisms, ecosystems, and the human communities who live in the region
[@huntington2020]. Such disruptions are a particular cause of concern for the
ice-associated seals that depend on spring and early summer sea ice (March-June)
in the Bering and Chukchi seas as a platform for important life history
functions, such as pupping, nursing, breeding behavior, and molting
[@boveng2009; @boveng2013a; @cameron2010; @kelly2010]. Limited data and large
knowledge gaps complicate predictions about the ultimate effects of changes in
sea ice on the behavior, health, abundance, and distribution of these seals. To
date, indices of seal health sampled during periods of declining sea ice differ
regionally [@crawford2015; @harwood2020]. Knowledge about evolutionary
constraints on the timing of reproductive and molting behavior is generally
lacking, so it is difficult to predict how or if ice-associated seal species
adapt to future changes (e.g., by adjusting pupping or molting schedules to
earlier dates or different locales). This is further complicated by the
spatio-temporal variation in the phenology of these life history events within
regions and throughout their full ranges. Additionally, trends in abundance of
these species are unknown, so it is difficult to assess the effect, if any,
declines in sea ice habitat have had, or will have, on seal demography.

Statutory requirements (e.g., United States Marine Mammal Protection Act (MMPA),
United States Endangered Species Act (ESA)) for timely estimates of population
abundance and trend of these species mean improved aerial survey effort is
needed -- and, must be paired with improved knowledge of haul-out behavior to
ensure appropriate survey design, robust methods, and accurate estimates.
Several studies have contributed estimates of the distribution and abundance of
ice-associated seal species in the Arctic using aerial surveys (e.g.,
@bengtson2005a, @conn2014a, and @verhoef2014a) and more recent efforts
have significantly expanded on previous survey effort. Such abundance studies
are conducted over very large areas and estimation of absolute abundance
requires making inference about numerous issues affecting the observation of
seals on ice. These include availability (only seals on ice are available to
be counted), detection probability (observers or automated detection systems may
miss some seals on ice), species misclassification, and possible
disturbance of seals by aircraft [@conn2014a; @verhoef2014a]. Refining these
inferences will improve the accuracy of abundance estimates and, hopefully,
allow credible predictions about the effects of climate disruptions on the
abundance and distribution of Arctic seal populations.

How ice-associated seals use sea ice as a haul-out platform varies between species.
Ribbon seals (_Histriophoca fasciata_) haul out of the water almost exclusively
on sea ice and are mostly pelagic outside the spring pupping, breeding, and
molting season [@boveng2018a]. While spotted (_Phoca largha_) and bearded
(_Erignathus barbatus_) seals rest on coastal features, they strongly prefer sea
ice as a haul-out platform during the spring and early summer [@frost2018].
Ringed seals (_Phoca hispida_) --- not included in this study --- haul out on
sea-ice but also within snow lairs during winter and spring. 

The remoteness of the Bering and Chukchi seas means direct scientific
observation of seal behavior is impractical. Thus, bio-logging devices are
especially useful tools for collecting key information on movement and haul-out
behavior for these species. Bio-logging records of time spent out of the water
provide valuable data for identifying covariates that explain variation in
haul-out behavior. For instance,Von Duyke et al. [-@vonduyke2020] used
satellite-linked bio-loggers to corroborate seasonal changes between diurnal and
nocturnal haul-out behavior of ringed seals previously described by Kelly and
Quakenbush [-@kelly1990c] using VHF radio tags and direct observation. Bengtson
et al. [-@bengtson2005a] documented a higher propensity for ringed seal basking
near solar noon, as did Ver Hoef et al. [-@verhoef2014a] in an analysis of
bearded, ribbon, and spotted seals using much larger sample sizes. Olnes et al.
[-@olnes2020] showed that the proportion of time bearded seals spent hauled out
progressively increased through spring and summer, and Ver Hoef et al.
[-@verhoef2014a] found haul-out probabilities increased gradually starting in
March and peaked in May and June for bearded, ribbon, and spotted seals. Recent
Such
analyses have not been limited to the Arctic. In the Antarctic, Bengtson and
Cameron [-@bengtson2004] relied on bio-logging data to demonstrate greater
haul-out propensity in juvenile crabeater seals (_Lobodon carcinophaga_) than
adults, with highest probabilities in February and at times close to solar noon.

Knowledge of haul-out patterns is not only important for understanding natural
history and ecology, but also for developing "availability" correction factors
for aerial surveys. Specifically, researchers need to know the fraction of seals
hauled out (versus in the water) when aerial surveys are conducted. Studies
estimating availability correction factors for seals typically use logistic
regression-style analyses to estimate the time-specific probability of being
hauled out based on 'wet/dry' data relayed by bio-loggers. In these models,
haul-out probabilities were expressed as a function of predictive covariates,
such as time-of-day, day-of-year, sex, age class, and environmental conditions
(e.g., @reder2003, @bengtson2004, @bengtson2005a, @udevitz2009, @lonergan2013,
@verhoef2014a, @southwell2008, and @niemi2023). However, sample sizes have often been
insufficient to permit strong inference about demographic and/or seasonal
variation in haul-out probabilities. For instance, Bengtson and Cameron's
[-@bengtson2004] study included 5 adult and 2 juvenile crabeater seals, while
Bengtson et al.'s [-@bengtson2005a] study was based on 6 ringed seals in the
Chukchi and Beaufort seas. These studies were often further limited by
logistical constraints on fieldwork and the attachment duration or operational
life of bio-loggers. In this study, we addressed some of these limitations by
deploying small bio-loggers designed for longer-term attachment on rear flippers
of a subset of the study individuals. These devices are designed to collect data
through the molt period (when those adhered to the hair would fall off) and, in
some situations, provide multiple years of data.

In this study, we used 16 years of bio-logging data to investigate the haul-out
behavior of bearded, ribbon, and spotted seals in the Bering and Chukchi seas.
Our goals were threefold. First, we wished to establish baseline estimates for
the chronology of haul-out behavior in the critical spring season for each
species across different age and sex classes. Second, we sought to refine
estimates of haul-out availability corrections for aerial surveys in order to
improve estimates of seal abundance. Previously estimated availability
correction factors (e.g., @bengtson2005a, @conn2014a, and @verhoef2014a)
accounted for variables such as the time-of-day and day-of-year, but did not
investigate meteorological variables that have been shown to influence haul-out
behavior of walruses [@udevitz2009]. Third, we aimed to assess the annual
variability in haul-out timing and possible linkage to changes in the extent of
seasonal sea ice between 2005 and 2020. Our work extends the scope of previous
haul-out analyses, includes the influence of meteorological variability, and
investigates the potential impact of changing sea-ice extent on the behavior of
these species.

# Methods {-}

## Data collection {-}

```{r getdata}
targets::tar_load(analysis_data, store = here::here("_targets"))
targets::tar_load(grid, store = here::here("_targets"))
targets::tar_load(deploy_table, store = here::here("_targets"))
```

For this study we used haul-out behavior data and location estimates from
bio-loggers deployed on bearded, ribbon, and spotted seals in the Bering,
Chukchi, and western Beaufort seas by multiple organizations as part of
collaborative investigations from 2005 through 2021. Seals were captured using
nets and bio-loggers were attached during studies based in coastal communities
or on research ships. Ship-based capture events occurred during spring near the
southern ice edge in the Bering Sea between 2005 and 2018. Land-based capture
events occurred between 2005 and 2020 from May to October, generally between the
coastal communities of Scammon Bay, Alaska in the Bering Sea, Utqiaġvik, Alaska
in the Chukchi Sea, and Nuiqsut in the Beaufort Sea. Data from additional
deployments along the Kamchatka peninsula in the western Bering Sea are also
included. We refer readers to Figure \@ref(fig:deployplot) and the primary literature
for detailed capture and bio-logger attachment methods (see Supplemental
Material, [S1](#s1)).

(ref:deployMapCaption) Initial deployment areas for each seal species (bearded, ribbon, and spotted seals) in the study between 2005 and 2020. Solid regions shown for each species are minimum concave polygons buffered by 60 km for enhanced visibility. The larger, shaded region indicates the spatial extent of aerial survey effort to date in US waters of the Bering and Chukchi seas. Deployments were initiated across a range of months but only data from 1 March to 15 July were included in the analysis. See Figure \@ref(fig:dataMap) for the spatial distribution of observed data used in the study and Supplemental Materials \@ref(tab:deploymentTable) for additional deployment details.

```{r deployplot, include=TRUE, fig.asp = 0.45, fig.cap = "(ref:deployMapCaption)"}
targets::tar_load(deploy_details, store = here::here("_targets"))
targets::tar_load(survey_area, store = here::here("_targets"))

deploy_sf <- deploy_details %>% 
  sf::st_as_sf(coords = c('longitude','latitude'), crs = 4326) %>% 
  sf::st_transform(3571) %>% 
  dplyr::group_by(species,location, region) %>% 
  dplyr::group_modify(~ concaveman::concaveman(., concavity = 4),.keep=TRUE) %>% 
  sf::st_sf(crs = 3571) %>% 
  sf::st_buffer(60*1000) 

world <- ne_countries(scale = "medium", returnclass = "sf") %>% 
  sf::st_transform(st_crs(deploy_sf))

survey_area <- survey_area %>% 
  sf::st_transform(st_crs(deploy_sf))


species_labels <- c("Bearded seal" = paste0("<span style = 'color:",
                                            species_colors['Bearded seal'],
                                            ";'>Bearded seal</span>"),
                    "Ribbon seal" = paste0("<span style = 'color:",
                                           species_colors['Ribbon seal'],
                                           ";'>Ribbon seal</span>"),
                    "Spotted seal" = paste0("<span style = 'color:",
                                            species_colors['Spotted seal'],
                                            ";'>Spotted seal</span>")
) %>% as_labeller()

label_coords_bering <- st_sfc(st_point(c(178.5,57)), crs = 4326) %>%
  st_transform(st_crs(deploy_sf))
label_coords_chukchi <- st_sfc(st_point(c(-176,73)), crs = 4326) %>%
  st_transform(st_crs(deploy_sf))
label_coords_beaufort <- st_sfc(st_point(c(-146.5,72.25)), crs = 4326) %>%
  st_transform(st_crs(deploy_sf))

p <- ggplot() +
  layer_spatial(survey_area, color = "#A26E7C", 
                fill = "#A26E7C", 
                alpha = 0.15,
                linewidth = 0.35) +
  layer_spatial(deploy_sf, aes(fill=species),
                linewidth=0) +
  annotation_spatial(world,
                     linewidth=0,
                     fill = "grey80") +
  geom_sf_text(data = label_coords_bering, aes(label = "Bering sea"), size = 1.65, color = "grey30") +
  geom_sf_text(data = label_coords_chukchi, 
               aes(label = "Chuckchi \nsea"), size = 1.65, lineheight = .85, color = "grey30") +
  geom_sf_text(data = label_coords_beaufort, 
               aes(label = "Beaufort \nsea"), size = 1.65, lineheight = .85, color = "grey30") +
  facet_grid(cols = vars(species), labeller = species_labels,
             switch="x") +
  scale_fill_manual(values = species_colors,
                    aesthetics = "fill", 
                    name = "species") + 
  labs(title = "Initial bio-logger deployment locations by species",
          subtitle = 
                 paste0("Bio-loggers were initially deployed on ",
                "<span style = 'color:",species_colors['Bearded seal'],";'>bearded,</span> ", 
                "<span style = 'color:",species_colors['Ribbon seal'],";'>ribbon,</span> ",  
                "and ", 
                "<span style = 'color:",species_colors['Spotted seal'],";'>spotted</span> seals ", 
                "across multiple regions within the Bering, Chukchi, and western Beaufort seas."),
       caption = "<span style = 'color: #A26E7C;'><span style = 'font-family: \"Font Awesome 6 Free Regular\";'>&#xf0c8;</span> spatial extent of aerial survey effort in US waters</span>") +
  theme(legend.position = "none",
        axis.title = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text.x = element_markdown(face = "bold")
  )

p
```


```{r deploystats}
species_n <- deploy_table %>% 
  group_by(species) %>% 
  distinct(speno) %>% 
  count(species)
```


We subset haul-out behavior data from 
`r species_n %>% .$n %>% sum()` bio-loggers deployed on 
`r species_n %>% filter(species == "Bearded seal") %>% .$n` bearded, 
`r species_n %>% filter(species == "Ribbon seal") %>% .$n` ribbon, and 
`r species_n %>% filter(species == "Spotted seal") %>% .$n` spotted seals 
to include only records from 1 March to 15 July between 
`r min(lubridate::year(analysis_data$haulout_dt))` and 
`r max(lubridate::year(analysis_data$haulout_dt))`. Bio-loggers were of the
'SPLASH' or 'SPOT' family of tags developed by Wildlife Computers (Redmond,
Washington, USA) and we either adhered them to the hair on the seal or attached
them through the rear flipper inter-digital webbing. The use of bio-loggers
adhered to the back or head provides some benefits over flipper mounted devices
(e.g. increased satellite transmittal rates, locations at sea) but these are
lost during the following annual molt, which, depending on deployment date,
limits the duration of haul-out data they provide. Additionally, bio-loggers
attached to the head or dorsal region are often dry while the seal is floating
at the surface, inducing a slight positive bias in the hourly percent-dry values
reported by the bio-logger. For this study, in cases where both bio-logger types
were deployed, we preferred hourly percent-dry observations from the flipper tag. 

Sex as well as age class (non-dependent _young-of-the-year_, sexually immature
_subadults_, and mature _adults_) were estimated at the time of deployment by
various combinations of length, claw growth ridges [@mclaren1958a], and pelage
characteristics for some species. Seals determined to be less than one year were
classified as young-of-the-year. For those bio-loggers deployed on
young-of-the-year and transmitting into the next year, the age class was
advanced to subadult on 1 March of the following year. Subadults are those seals
likely greater than one year of age but less than four years. Adults are
individuals that are likely older than four years. Table \@ref(tab:tblDeploy)
provides a summary of these deployments and data received from them.

```{r tblDeploy, include=TRUE, tab.cap = "Summary of bio-logger data across seal species and age classification from 1 March to 15 July 2005-2020. Total seal hours represents the sum of hourly observations across all seals used in the analysis. Because young-of-the-year are advanced to subadult on 1 March of the following year, some individual seals are represented in both columns in this table"}

deploy_table %>%
  dplyr::group_by(species, sex, age) %>%
  dplyr::summarise(
    n = n(),
    seal_hours = sum(n_hours)
  ) %>%
  dplyr::mutate(
    deploy_stats = glue::glue('{n} ({format(seal_hours, big.mark=",")} seal hours)')
  ) %>%
  dplyr::select(-c("n","seal_hours")) %>%
  tidyr::pivot_wider(names_from = age, values_from = c(deploy_stats)) %>%
  dplyr::ungroup() %>%
  dplyr::rename(Species = species, Sex = sex, `Young-of-the-Year` = `YOUNG OF YEAR`,
                `Subadult` = SUBADULT, Adult = ADULT) %>%
  flextable() %>%
  add_header(`Young-of-the-Year` = "Age Class",
   Subadult = "Age Class", Adult = "Age Class",
   top = TRUE ) %>%
  merge_h(part = "header") %>%
  flextable::align(align = "left", part = "header") %>% 
  flextable::align(i = 1, align = "center", part = "header") %>% 
  fontsize(size = 9, part = "all") %>% 
  flextable::width(width = 1.35) %>% 
  flextable::width(j = ~ Species, width = 0.9) %>% 
  flextable::width(j = ~ Sex, width = 0.4)

```

```{r seal-hours}
# create_yday_groups <- function(analysis_data) {
#   d <- analysis_data %>%
#     tibble::as_tibble() %>%
#     dplyr::mutate(yday = lubridate::yday(haulout_dt)) %>%
#     dplyr::select(yday) %>%
#     dplyr::distinct() %>%
#     dplyr::arrange(yday)
#   
#   d <- split(d$yday, ceiling(seq_along(d$yday) / 8)) %>%
#     dplyr::as_tibble() %>%
#     tidyr::pivot_longer(
#       cols = 1:15,
#       names_to = "col_group",
#       values_to = "yday",
#       names_transform = list(col_group = as.integer),
#       values_transform = list(yday = as.integer)
#     ) %>%
#     dplyr::arrange(yday) %>% 
#     transform(row_group = letters[1:8])
#   return(d)
# }
# 
# yday_groups <- create_yday_groups(analysis_data)

seal_hours_tbl <- analysis_data %>% 
  tibble::as_tibble() %>% 
  dplyr::mutate(yday = lubridate::yday(haulout_dt)) %>% 
  dplyr::group_by(species, yday) %>% 
  dplyr::count()
```

Tags that fall off due to molt, attachment failure, or seal mortality and remain
on ice or land may continue to send data to satellites; i.e., a detached
bio-logger that is dry (either on ice or land) will record and transmit data
suggesting the seal is hauled out. Therefore, end times of each deployment were
identified by examining bio-logger locations, percent-dry records, and dive
behavior (if available) to determine when bio-loggers ceased providing data
consistent with seal behavior. For example, a data record that ends with several
consecutive days (~10+ days) of 100% dry observations and with locations
indicating the tag was on land would be truncated to not include the final
stretch of 100% dry observations. The vast majority of deployments end with the
device detaching in the water and the deployment end date is obvious. There is
no perfect algorithm for identifying deployment end dates and each deployment in
question must be considered separately. While not perfect, we are confident our
reliance on expert opinion and examination of multiple data streams provides the
best option. Data outside of the deployment start and end times were discarded
prior to analysis. 

Haul-out behavior data were recorded in a manner standard across Wildlife Computers
bio-loggers and transmitted via the Argos satellite
network as hourly percent-dry timelines. For each hour of a day, the wet/dry
sensor was polled by the tag firmware every few seconds and the percent of the
hour in the dry state was calculated (Figure \@ref(fig:examplePlot)). On board
the bio-logger, hourly percent-dry calculations were rounded to the nearest 10%
inclusive of 0% and 100% along with additional values at 3% and 98%. This
compression resulted in additional data transmission as each message consisted
of two complete 24-hour records. Memory capacity allowed caching of percent-dry
records for several weeks or months and each message was transmitted several
times to ensure reception at the satellite. Bio-loggers were, typically,
deployed and programmed in a manner to maximize data transmission during the
spring pupping and molting period, though hourly percent-dry data were not
always successfully transmitted. This is due to a variety of factors including
satellite coverage, tag availability (e.g., tags mounted to the rear flipper
often do not transmit while at sea), tag performance, duty cycling, and
atmospheric interference. Fortunately, missing records do not substantially bias
inference about haul-out probabilities [@conn2012c].

```{r examplePlot, include=TRUE, fig.id="examplePlot", fig.cap="Haul-out behavior observations recorded by a bio-logger deployed on a ribbon seal over two years during the months of March, April, and May. This actogram plot represents the transmitted hourly percent-dry values. Not all data during a deployment are reliably transmitted from the bio-logger and since data are transmitted in 24-hour chunks occasional missing days are present in the record. Here, missing data that were not successfully recieved from the device are represented as empty rectangles."}

d <- analysis_data %>% 
  filter(speno == "HF2016_1002") %>% 
  dplyr::select(speno, haulout_dt, percent_dry) %>% 
  arrange(haulout_dt) %>% st_drop_geometry() %>% 
  mutate(year = lubridate::year(haulout_dt),
         month = lubridate::month(haulout_dt,label=TRUE),
         day = lubridate::day(haulout_dt),
         hour = lubridate::hour(haulout_dt)) %>% 
  filter(month != 'Jun')

d_deploy <- analysis_data %>% 
  sf::st_drop_geometry() %>% 
  filter(speno == "HF2016_1002") %>% 
  dplyr::select(speno,deploy_dt,haulout_dt,percent_dry) %>% 
  mutate(year = lubridate::year(deploy_dt),
         month = lubridate::month(deploy_dt, label = TRUE),
         day = lubridate::day(deploy_dt),
         hour = lubridate::hour(deploy_dt))

missing_hours <- tibble(haulout_dt = seq(min(d_deploy$haulout_dt),
              max(d_deploy$haulout_dt),by = "hour")) %>% 
  filter(!haulout_dt %in% d_deploy$haulout_dt) %>% 
  filter(lubridate::month(haulout_dt) %in% c(3,4,5)) %>% 
  mutate(percent_dry = 0) %>% 
  mutate(year = lubridate::year(haulout_dt),
         month = lubridate::month(haulout_dt,label=TRUE),
         day = lubridate::day(haulout_dt),
         hour = lubridate::hour(haulout_dt))

p <- ggplot(d,aes(day,hour,fill=percent_dry))+
  geom_tile(linewidth = 0.1, color = "grey75") + 
  scico::scale_fill_scico(palette = "nuuk", direction = 1,
                       name = "hourly percent dry", aesthetics = "fill",
    guide = guide_colorbar(title.position = "bottom", barwidth = 15,
                           barheight = 0.5, title.hjust = 0.5)
    ) +
  geom_tile(data = missing_hours, fill = NA, color = "grey30", linewidth = 0.2) +
  coord_cartesian(clip = "off")

label_df <- data.frame(year = 2016, month = "Apr",day = 1, hour = 12,
                       percent_dry = 0,
                       lab = "**Missing Data**<br>not all data are reliably received from the bio-logger") |> 
  mutate(month = forcats::fct_relevel(month,c("Mar","Apr","May","Jun")))

curve_df <- data.frame(year = 2016, 
                       month = "Apr", 
                       day = 1, day_end = 2, 
                       hour = 8, hour_end = 0,
                       percent_dry = 0) |> 
  mutate(month = forcats::fct_relevel(month,c("Mar","Apr","May","Jun")))


p <- p +
  geom_textbox(
    data = label_df,
    mapping = aes(day, hour, label = lab),
    width = grid::unit(0.65, "npc"), # 65% of plot panel width
    halign = 0, valign = 0.5,
    nudge_y = 2,
    size = 2.75, box.size = NA,
    lineheight = .9,
    fill = NA, 
    label.color = NA,
  ) +
  geom_curve(
    data = curve_df,
    mapping = aes(x = day, y = hour, xend = day_end, yend = hour_end),
    curvature = 0
  )

p <- p + facet_grid(year~month, scales = "free_x")
p <- p + scale_x_continuous(breaks = c(5,15,25), expand = c(0,0)) +
  scale_y_continuous(breaks = c(4,12,20), labels = c("04:00","12:00","20:00"))

p <- p + theme(legend.position = "bottom") +
  theme(strip.background = element_rect(colour="white")) +
  theme(axis.ticks=element_blank()) +
  theme(panel.spacing = unit(0,"line")) +
  ggtitle("Example percent-dry actogram from bio-logger data",
          subtitle = "Observation records shown are from a single ribbon seal across a two year deployment.") +
  xlab("day of month") + ylab("hour (UTC)")

p
```

Of key interest in this study was the relationship between haul-out behavior and
weather covariates that vary with time and seal location. We explored the use
of a continuous-time correlated random walk [@johnson2008a] movement model
to predict locations at specific times. However, the sparse nature of data from
some bio-loggers, especially those mounted to the rear flipper, resulted in poor
modeling performance or convergence issues. For this study, we calculated a
weighted average daily location where the inverse of the estimated Argos or
FastLoc GPS location error was used for the weight. Each Argos location estimate
was assigned an error radius based on either the categorical location quality (
_3_ = 250 m, _2_ = 500 m, _1_ = 1500 m, _0_ = 2500 m [@lopez2013]; we chose 2500 m for
location classes _A_ and _B_) or, when available, the estimated error radius
from the Argos Kalman filter algorithm. Location estimates from FastLoc GPS were
all assigned an error radius of 50 m. On days when haul-out observations were
present but location data were missing we used the seal's last calculated weighted
average daily location; days when the location intersected with land
were removed from the seal's record. We recognize that bearded and spotted
seals haul out on land. However, assessing the relationship between haul-out
behavior and weather covariates and seals' availability for aerial surveys on
land was outside the scope of this study. Additionally, any daily locations on
land were likely more reflective of coordinate averaging and measurement error,
rather than actual use of coastal features. 

## Explanatory variables {-}

In addition to sex and age class, we analyzed variables that might help explain
variation in haul-out probabilities. These included day-of-year (for seasonal
effects) and local solar hour (for diurnal effects). We calculated local solar
hour using the {solaR} package [@perpinan2012] within the R statistical
environment [@rcoreteam2021] based on the weighted daily average locations. We
also linked the weighted average daily locations to weather values from the
North American Regional Reanalysis (NARR) model produced by the National Centers
for Environmental Prediction [@mesinger2006a]. The NARR model assimilates
observational data to produce a long-term picture of weather over North America
and portions of the surrounding seas. Weather variables are made available
across the region 8 times daily. For this study, NARR weather values were subset
to the extent of our study area over the Bering and Chukchi seas at 3-hr
intervals based on the native grid resolution of 32 km (1024 km^2^). The
following meteorological variables are known to affect haul-out behavior in
other Arctic pinnipeds [@reder2003; @udevitz2009; @perry2017] and were
interpolated and assigned to daily seal locations using a bilinear method: 1)
air temperature at 2 m above the Earth's surface, 2) wind consisting of
northerly and easterly vector components converted to wind speed using the
Euclidean norm, 3) barometric pressure at sea level, and 4) precipitation 
(Table \@ref(tab:tblCovariates)).

For all seal species, we considered the following variables when modeling the
hourly haul-out behavior: day-of-year, solar hour, temperature, wind speed,
barometric pressure, precipitation, and wind chill (represented by a
*wind:temperature* interaction [@udevitz2009]). Ribbon and spotted seal models
included age-sex class and interactions between day-of-year and age-sex class,
but we omitted these from bearded seal models due to poor representation of
age-sex classes (Table \@ref(tab:tblDeploy)). Bearded seal models included a
latitudinal effect (and an interaction with day-of-year), since bearded seals
occupy a substantial range during the spring and we were interested in possible
differences in the timing of haul-out behavior along a latitudinal gradient. We
omitted the latitudinal effect from ribbon and spotted seal models because,
during the spring, these species are most prevalent near the southern ice edge
in the Bering Sea [@conn2013b].

We did assess whether the annual variation in maximum spring sea ice extent in the
Bering Sea influenced the seasonal peak of seal haul-out probability. In
particular, we used sea ice concentration data from the Nimbus-7 SMMR and DMSP
SSM/I-SSMIS Passive Microwave Dataset, Version 1 [@cavalieri1996] to calculate
maximum sea ice extent. All sea ice concentration grid cells (25 km^2^) in the
study area with greater than 15% concentration were counted daily to get the total sea
ice extent for each day between 15 February and 15 July across all years.
Maximum spring sea ice extent was simply the largest daily count of grid cells
with greater than 15% concentration for each year.

(ref:kgm2) kg/m^2^

```{r tblCovariates, include=TRUE, tab.cap = "Explanatory covariates used in analyses of binary haul-out records for bearded, spotted, and ribbon seals. Note that we also considered select interactions (see article text) between these primary covariates.  For instance, wind chill was represented by the interaction temperature:wind."}

covariate_tbl <- tibble::tribble(
  ~Covariate, ~Type, ~Description,
  "Age-sex class","Categorical","young-of-the-year, subadult, adult male and adult female",
  "Hour", "Continuous; Fourier basis", "local solar hour using 6 variables of a Fourier-series basis",
  "Day",   "Continuous", "linear, quadratic, and cubic effects of day-of-year",
  "Precip", "Continuous", "convective precipitation (ref:kgm2) (NARR)",
  "Pressure", "Continuous", "atmospheric pressure at sea level (kPa) (NARR)",
  "Temp", "Continuous", "air temperature (C) at 2m above the earth’s surface (NARR)",
  "Wind", "Continuous",
  "northerly and easterly vector components for wind (NARR) converted into a single wind speed via the Euclidean norm",
  "Northing", "Continuous", "latitude divided by the mean latitude across all locations (for bearded seals only)",
  "Year", "Continuous", "For the set of models examining inter-annual variation in sea ice use, we fitted models with the addition of year by day-of-year interactions." 
)

covariate_tbl %>% 
  flextable() %>% 
  fontsize(size = 9, part = "all") %>% 
  hline(i=8) %>% 
  flextable::width(width = 1.0) %>% 
  flextable::width(j = ~ Description, width = 2.5)
```

## Haul-out modeling {-}

```{r modelfits}
tar_load(bearded_fit, store = here::here("_targets"))
tar_load(ribbon_fit, store = here::here("_targets"))
tar_load(spotted_fit, store = here::here("_targets"))
tar_load(spotted_year_fit, store = here::here("_targets"))
tar_load(ribbon_year_fit, store = here::here("_targets"))
```

Haul-out records for seals are often characterized by sequential hours spent
basking on ice alternating with long periods in the water (Figure
\@ref(fig:examplePlot)). Commonly used statistical models for binary data (e.g.
logistic regression) assume independence among responses, an assumption that is
clearly violated if hourly responses are modeled. Any analysis that ignores
temporal autocorrelation in responses will thus have overstated precision
[@betts2006].

```{r binomialdata}

portion_10 <- function(d) {
  n <- nrow(d)
  f <- d %>% dplyr::filter(percent_dry <= 10) %>% 
    nrow()
  p10 <- f/n
  return(p10)
}

portion_90 <- function(d) {
  n <- nrow(d)
  f <- d %>% dplyr::filter(percent_dry >= 90) %>% 
    nrow()
  p90 <- f/n
  return(p90)
}

```

To properly account for temporal dependence and to take advantage of computational
efficiency, we used generalized linear mixed pseudo-models (GLMPMs;
[@verhoef2010a]) to model variation in haul-out behavior as a function of (1)
covariate predictors, (2) temporally autocorrelated random effects, and (3)
individual random effects representing heterogeneity in individual behavior. We
used the glmmLDTS package [@verhoef2010a] to implement GLMPMs. We explored two
different model formulations for our data and we fit separate models to bearded, 
ribbon, and spotted seal data sets as we expected differing behavior by species. 
Separate models for each species were also
needed because a single, very large data set proved computationally intractable.
In our first model formulation and for each species, we fitted a year-independent
model that predicted average haul-out behavior as a function of demographic,
environmental, seasonal, and diurnal effects. Second, for ribbon and spotted
seals (which had considerably more data than bearded seals), we fitted models
that included all the effects from the first model, but also permitted annual
variation in haul-out timing. This second class of models was used to examine
whether haul-out patterns varied by year and to determine the annual timing of
apparent peaks in haul-out behavior. For both models, we assumed an hourly
Bernoulli response (i.e., whether tags were mostly dry or mostly wet) where
the linear predictor was modeled on the logit scale. This is consistent with
previous approaches [@verhoef2014a, @london2012] and only
`r (1 - round((portion_10(analysis_data) + portion_90(analysis_data))) * 100)`% of our
observations fell between 10% and 90% hourly percent-dry.

We followed Ver Hoef et al. [-@verhoef2014a] in using linear, quadratic, and cubic
effects of day-of-year to represent temporal changes
in behavior during the season. However, unlike previous models for harbor seals
[@london2012] and ice-associated seals [@verhoef2014a], which treated
hour-of-day as a 24-level categorical variable to capture diurnal cycles, we
adopted a continuous formulation based on Fourier series that provides a
flexible model while preserving the inherent circularity needed for time-of-day
effects (i.e., hour 0 should be equal to hour 24). It also represents
hour-of-day with 6 parameters, which is a considerable reduction when compared
to a 24-parameter variable. According to this approach, we used the following
specification for hour-of-day effects:

$$
H_t=\alpha_1 \cos(\frac{\pi t}{4}) + \alpha_2 \sin(\frac{\pi t}{4}) + \alpha_3 \cos(\frac{\pi t}{6}) + \alpha_4 \sin(\frac{\pi t}{6}) + \alpha_5 \cos(\frac{\pi t}{12}) + \alpha_6 \sin(\frac{\pi t}{12})
$$ 
where $H_t$ gives the effect for solar hour $t$ and $\alpha_{i}$ are
estimated parameters (regression coefficients).

For the second set of models examining inter-annual variation in sea ice use, we
fitted models with year by day-of-year interactions. However, in this case we
only included *year:day* and *year:day^2^*, omitting the main effects of year as
well as *year:day^3^* interactions because models with the latter effects were
numerically unstable. However, the modeled interactions were sufficient to allow
shifts in haul-out distribution, as one can show mathematically that a simple
horizontal shift in timing of haul-out distributions does not affect the main
effects or cubic terms in a polynomial regression model. Bearded seals were
not included in this examination of inter-annual variation because of limited
data across many years in the study.

A typical model fitting exercise would also include a model selection process.
However, AIC (and similar criteria) is not suitable when using
pseudo-likelihoods, because pseudo-data generated in the model fitting process
[@verhoef2010a] differ between models [@teneyck2018]. After fitting GLMPM
models, we instead used "type III" $F$-tests to calculate $p$-values
[@verhoef2010a] to evaluate model performance and important terms. We also
produced predictions of haul-out behavior as a function of three influential
predictors (e.g. solar hour, day-of-year, age-sex). Weather covariates for these
predictions were based on daily or hourly smoothed weather covariate values
across the study region. Such predictions were then used to develop haul-out
probability surfaces, explore conditional effects of weather covariates, and
determine annual peaks in haul-out activity. The timing of peak haul-out
behavior was further used to regress against the annual maximum sea ice extent
in the study region. Predictions before 15 March and after 30 June were not
included in visualizations or other evaluations to avoid spurious model
predictions at the edge of the data range.

Visualizing the marginal or conditional effect of an individual weather
covariate on haul-out probability was difficult in this analysis because of the
collinearity between covariates as well as the spatial and temporal variation
across such a large region. The relationship of each weather covariate with
haul-out probability, averaged over the other weather conditions, was more
variable than model coefficients would imply. That said,
important insights can be gained from plots of marginal effects. To create these
plots, we predicted haul-out probability across the full range
of weather covariate values while fixing hour of the day at local solar noon and
day-of-year at 15 May. The
visualizations also include vertical lines representing 95% confidence intervals
around the predicted haul-out probability to better communicate the variation in
model uncertainty.

# Results {-}


Figure \@ref(fig:dataMap) shows the
spatial distribution of weighted locations with available haul-out behavior data
used for analysis of each species across the study area.

```{r locs-count-mapdata}
haulout_locs <- analysis_data %>% 
  filter(lubridate::hour(haulout_dt) == 12)
         

hexgrid <- sf::st_make_grid(st_bbox(haulout_locs) %>% st_as_sfc(), cellsize = 50*1000,
                            what = "polygons", square = FALSE) 
hexgrid <- st_sf(index = 1:length(lengths(hexgrid)), hexgrid)

hexbin <- st_join(haulout_locs, hexgrid, join = st_intersects)

locs_count <- hexgrid %>%
  left_join(
    count(hexbin, index, species) %>%
      as_tibble() %>%
      dplyr::select(species, index, ct=n)
  ) %>% drop_na()
```

(ref:mapCaption) Spatial distribution of haul-out records during the months of March through July 15 for each of the three species. Linking location estimates with haul-out records in space and time allows for inclusion of weather covariates in the final model. For this visualization, data were collated across all years between 2005 and 2020 and each hexagonal cell represents an area of 50 km^2^

```{r dataMap, include=TRUE, fig.cap="(ref:mapCaption)"}

world <- ne_countries(scale = "medium", returnclass = "sf") %>% 
  sf::st_transform(st_crs(locs_count))

ggplot() +
  annotation_spatial(world,
                     linewidth = 0,
                     fill = "grey80") +
  layer_spatial(
    data = locs_count,
    aes(fill = ct),
    linewidth = 0.1,
    color = "grey75"
  ) +
  scico::scale_fill_scico(
    palette = "imola",
    trans = "log10",
    aesthetics = "fill",
    name = "number of locations",
    guide = guide_colorbar(
      title.position = "bottom",
      barwidth = 15,
      barheight = 0.5,
      title.hjust = 0.5
    )
  ) +
  facet_grid( ~ species) +
  labs(
    title = "Spatial distribution of haul-out behavior records",
    subtitle = "Location estimates were linked by time with haul-out records. 
    Data are shown collated across 2005-2020 between 01 March-15 July
    for each of the three species.",
    caption = "One hexagonal cell represents 50 km^2^"
  ) +
  theme(
    legend.position = "bottom"
  )
```


Figure \@ref(fig:dataCal) shows the temporal distribution of all
haul-out data across the study season for each species. Observations for ribbon
and spotted seals were concentrated in the months of May and June due to the
timing of deployment (April and May) and the timing of molt (May and June).
During molt, seals (and their attached bio-loggers) spend more time out of the
water and more data are transmitted. Molt timing also impacts when many
deployments end as any bio-loggers adhered to the hair will fall off. Relative
to the other species in the study, there were fewer deployments of bio-loggers
on bearded seals. This resulted in fewer data observations overall and
noticeably lower in numbers May and June. The majority of bearded seal
deployments started later in the summer and, by May, bio-loggers had either
fallen off or their batteries were depleted.

```{r dataCal, include=TRUE, fig.cap = "Distribution of hourly percent-dry bio-logger data from 1 March to 15 July for each species. Data are grouped by day-of-year and presented in seal-hours collated across all years between 2005 and 2020. The higher density of data from May and June in ribbon and spotted seals coincides with peak molting when seals (and their attached bio-loggers) are more likely hauled out. Additionally, many bio-logger deployments started in April and May. The overall reduced quantity of observations from bearded seals is reflective of the lower number of bio-logger deployments in the study."}

ggplot(data = seal_hours_tbl, aes(x = yday, y = n, fill = n))+
  geom_col() +
        scico::scale_fill_scico(palette = "oslo", direction = -1) +
        scale_x_continuous(breaks = c(60, 91, 121, 152, 182),
                           labels = c("01 March", "01 April", "01 May", "01 June", "01 July"),
                           expand = expansion(mult = c(0, 0))) +
        scale_y_continuous(expand = expansion(mult = c(0, 0))) +
  guides(fill = guide_colorbar(title.position = "bottom", 
                               title.hjust = 0.5, barwidth = 15,
                               barheight = 0.5)) +
  facet_grid(species ~ .) + 
  labs(fill = "seal-hours of bio-logger data",
       title = "Seasonal density of haul-out behavior observations by species",
       subtitle = "Data are grouped by day-of-year and presented in seal-hours collated across 
       years (2005-2020) from March through July.") +
  theme(axis.text.x = element_text(hjust = 0),
        axis.text.y = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        legend.position = "bottom",
        plot.subtitle = element_textbox_simple(
          color = "grey30",
          margin = ggplot2::margin(t = 0, b = 0, r = 60)
        )
  )

```

Models omitting year effects suggested that day-of-year, solar hour, age-sex
class, temperature, and wind substantially influenced haul-out behavior of all
three species, with $F$ tests producing $p$-values less than 0.05 for variables
embodying these effects and/or their interactions. Haul-out probabilities
typically increased throughout March and April, reaching a peak in May and early
June before declining again. Diurnal patterns were present, with maximum
haul-out behavior centered around local solar noon.



```{r type3}
ribbon_type3 <- tibble(
  ribbon_fit$typeIII.hypoth
) %>% 
  mutate(Prob.F = scales::pvalue(Prob.F),
         Effect = janitor::make_clean_names(Effect)) %>% 
  column_to_rownames(var = "Effect") 
ribbon_type3 <- setNames(split(ribbon_type3, 
                               seq(nrow(ribbon_type3))), 
                         rownames(ribbon_type3))

spotted_type3 <- tibble(
  spotted_fit$typeIII.hypoth
) %>% 
  mutate(Prob.F = scales::pvalue(Prob.F),
         Effect = janitor::make_clean_names(Effect)) %>%  
  column_to_rownames(var = "Effect")  
spotted_type3 <- setNames(split(spotted_type3, 
                               seq(nrow(spotted_type3))), 
                         rownames(spotted_type3))

bearded_type3 <- tibble(
  bearded_fit$typeIII.hypoth
) %>% 
  mutate(Prob.F = scales::pvalue(Prob.F),
         Effect = janitor::make_clean_names(Effect)) %>%  
  column_to_rownames(var = "Effect")  
bearded_type3 <- setNames(split(bearded_type3, 
                               seq(nrow(bearded_type3))), 
                         rownames(bearded_type3))
```

## Bearded Seals {-}

Age and sex class were not included in the model for bearded seals due to our
lower sample size for adult and young-of-year age classes. As such, results are
shown for all ages (Figure \@ref(fig:beardedHOCal); see also 
\@ref(fig:beardedPredSE)). Additionally, after
approximately 9 months, 7 devices deployed on the rear flipper of bearded seals
reported implausible hourly percent-dry data (100% dry for several weeks but
indicative of movement and increasing transmission rates (see @boveng2013)). All
data after the first instance of unrealistic values were censored from this
analysis. Overall, bearded seals were less likely to haul out and had a bi-modal
distribution of haul-out probability across the day. In addition to a peak
around local solar noon, the bearded seal model predicted additional haul-out
activity around local midnight. In concert with the lower magnitude of haul-out
probability, bearded seal haul-out behavior was also more protracted throughout
the spring season compared to ribbon and spotted seals.

```{r ebnewdata}
targets::tar_load(bearded_newdata, store = here::here("_targets"))
```

```{r beardedHOCal, include=TRUE, fig.cap="Predicted hourly haul-out probability of bearded seals (all ages and sex classes) from 1 March to 30 June for all age and sex classes combined. Predictions in July and before 15 March were not included to avoid spurious model predictions at the edge of the data range."}

plot_df <- bearded_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label = TRUE),
         day = lubridate::day(date)) %>%
  filter(!month %in% c("Jul","Aug"),
         lubridate::yday(date) >73)

p <- ggplot(plot_df, aes(day,solar_hour,fill = ho_prob, color = ho_prob)) +
  geom_tile(linewidth = 0.15) +
  scico::scale_fill_scico(palette = "navia", direction = 1,
                          begin = 0.1, end = 1,
                       name = "haul-out probability", 
                       limits = c(0,1), breaks = c(0.25, 0.50, 0.75),
                       guide = guide_colorbar(title.position = "bottom", barwidth = 15,
                                              barheight = 0.5, title.hjust = 0.5)
  ) +
  scico::scale_color_scico(palette = "navia", direction = 1,
                           begin = 0.1, end = 1,
                           limits = c(0,1)) +
  guides(col = FALSE)


p <- p + facet_grid(age_sex~month,
                    scales = "free_x",
                    space = "free_x",
                    labeller = labeller(
                      age_sex = age_sex_labels
                    ))
p <- p + scale_x_continuous(breaks = c(5,10,15,20,25)) +
  scale_y_continuous(breaks = c(4,12,20), labels = c("04","12", "20")) +
  coord_cartesian(expand=FALSE)
p <- p + theme(panel.spacing = unit(0.1, "lines"),
               legend.position = "bottom",
               strip.background = element_rect(colour="white"),
               axis.ticks=element_blank()) +
  xlab("day of month") + ylab("local solar hour") +
  labs(title = "Bearded seal predicted haul-out probability",
       subtitle = "Our model predicts lower haul-out probability for bearded seals overall 
       compared to ribbon and spotted seals. Highest probability is associated with solar noon and midnight.")
p
```

When exploring the influence of weather, bearded seal haul-out probability
was strongly affected by wind
($F_{`r paste(bearded_type3$wind$Num.df, bearded_type3$wind$Den.df, sep=",")`}$
= `r bearded_type3$wind$F.value`; $p$ = `r bearded_type3$wind$Prob.F`)
and temperature
($F_{`r paste(bearded_type3$temp2m$Num.df, bearded_type3$temp2m$Den.df, sep=",")`}$
= `r bearded_type3$temp2m$F.value`; $p$ =
`r bearded_type3$temp2m$Prob.F`) with much higher haul-out probability during 
periods of higher temperatures and low wind speeds (Figure \@ref(fig:beardedHOwx)). 
Not surprisingly, wind chill 
($F_{`r paste(bearded_type3$temp2m_wind$Num.df, bearded_type3$temp2m_wind$Den.df, sep=",")`}$
= `r bearded_type3$temp2m_wind$F.value`; $p$ =
`r bearded_type3$temp2m_wind$Prob.F`) was also important. Barometric
pressure ($F_{`r paste(bearded_type3$pressure$Num.df, bearded_type3$pressure$Den.df, sep=",")`}$
= `r bearded_type3$pressure$F.value`; $p$ =
`r bearded_type3$pressure$Prob.F`) was also significant factor although less 
apparent (Figure \@ref(fig:beardedHOwx)). Any effect of precipitation 
was not a significant influence on haul-out probability 
($F_{`r paste(bearded_type3$precip$Num.df, bearded_type3$precip$Den.df, sep=",")`}$
= `r bearded_type3$precip$F.value`; $p$ =
`r bearded_type3$precip$Prob.F`).


```{r beardedHOwx, fig.asp = 1, include=TRUE, fig.cap="Marginal effects of temperature, wind, pressure, and precipitation on the predicted haul-out probability of bearded seals combined across all age and sex classifications. Hour of the day was fixed at local solar noon and day-of-year fixed at 15 May. Vertical lines represent the 95\\% confidence interval around the predicted haul-out probability."}

targets::tar_load(bearded_wx_plot, store = here::here("_targets"))

bearded_wx_plot
```

## Ribbon Seals {-}

```{r hfnewdata}
targets::tar_load(ribbon_newdata, store = here::here("_targets"))
```

Ribbon seals exhibited a pattern of gradually increasing haul-out probability
in April that peaks in late May for subadults and in early June for
adults (Figure \@ref(fig:ribbonHOCal); see also 
@\ref(fig:ribbonPredSE)). The behavior was clearly centered
around local solar noon and expanded to other hours later in the spring
as seals entered their molting period. Subadults showed an earlier start
and more intense haul-out activity in April and May. The
young-of-the-year records begin after weaning and the model predictions
demonstrated the ontogeny of in-water activities (e.g. swimming, foraging)
in May. Adult females had a more protracted haul-out season compared to
males, and more time was spent hauled out in June compared to adult males and
subadults.

```{r ribbonHOCal, fig.asp = 0.9, include=TRUE, fig.cap="Predicted hourly haul-out probability of ribbon seals from 15 March to 30 June for each age and sex class used in the model. There is an apparent seasonal progression with subadults hauling out earlier in the season followed by adult males and, then, adult females. Predictions for young of the year show their transition from newly weaned pups resting on the ice to more in-water activities. Predictions in July and before 15 March were not included to avoid spurious model predictions at the edge of the data range."}

plot_df <- ribbon_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label = TRUE),
         day = lubridate::day(date)) %>%
  filter(!month %in% c("Jul","Aug"),
         lubridate::yday(date) >73)

p <- ggplot(plot_df, aes(day,solar_hour,fill = ho_prob, color = ho_prob)) +
  geom_tile(linewidth = 0.15) +
  scico::scale_fill_scico(palette = "navia", direction = 1,
                          begin = 0.1, end = 1,
                       name = "haul-out probability", 
                       limits = c(0,1), breaks = c(0.25, 0.50, 0.75),
                       guide = guide_colorbar(title.position = "bottom", barwidth = 15,
                                              barheight = 0.5, title.hjust = 0.5)
  ) +
  scico::scale_color_scico(palette = "navia", direction = 1,
                           begin = 0.1, end = 1,
                           limits = c(0,1)) +
  guides(col = FALSE)

p <- p + facet_grid(age_sex~month,
                    scales = "free_x",
                    space = "free_x",
                    labeller = labeller(
                      age_sex = age_sex_labels
                    ))
p <- p + scale_x_continuous(breaks = c(5,10,15,20,25)) +
  scale_y_continuous(breaks = c(4,12,20), labels = c("04","12", "20")) +
  coord_cartesian(expand=FALSE)
p <- p + theme(panel.spacing = unit(0.1, "lines"),
               legend.position = "bottom",
               strip.background = element_rect(colour="white"),
               axis.ticks=element_blank()) +
  xlab("day of month") + ylab("local solar hour") +
  ggtitle("Ribbon seal predicted haul-out probability",
          subtitle = "Our model predicts increased haul-out probability 
          for ribbon seals centered on solar noon and a sequential 
          seasonal pattern linked to age and sex classifications.")
p
```

The haul-out probability for ribbon seals was mostly influenced by
temperature
($F_{`r paste(ribbon_type3$temp2m$Num.df, ribbon_type3$temp2m$Den.df, sep=",")`}$
= `r ribbon_type3$temp2m$F.value`; $p$ = `r ribbon_type3$temp2m$Prob.F`) and wind
($F_{`r paste(ribbon_type3$wind$Num.df, ribbon_type3$wind$Den.df, sep=",")`}$
= `r ribbon_type3$wind$F.value`; $p$ = `r ribbon_type3$wind$Prob.F`) with barometric pressure
($F_{`r paste(ribbon_type3$pressure$Num.df, ribbon_type3$pressure$Den.df, sep=",")`}$
= `r ribbon_type3$pressure$F.value`; $p$ =
`r ribbon_type3$pressure$Prob.F`) having a milder impact.
Ribbon seals were less likely to haul out at higher winds and lower pressure
values and more likely to haul out when temperatures were
relatively warm (Figure \@ref(fig:ribbonHOwx)). Neither wind chill
($F_{`r paste(ribbon_type3$temp2m_wind$Num.df, ribbon_type3$temp2m_wind$Den.df, sep=",")`}$
= `r ribbon_type3$temp2m_wind$F.value`; $p$ =
`r ribbon_type3$temp2m_wind$Prob.F`) nor precipitation 
($F_{`r paste(ribbon_type3$precip$Num.df, ribbon_type3$precip$Den.df, sep=",")`}$
= `r ribbon_type3$precip$F.value`; $p$ =
`r ribbon_type3$precip$Prob.F`) were a significant
influence on haul-out probability. Compared with bearded seals, the effect of
weather covariates on the predicted haul-out probability for
ribbon seals was less striking. Because our ribbon seal model included age and sex class, we can
visualize the different influences of weather covariates on those classes and see
that subadults separate out from adult males and females (Figure \@ref(fig:ribbonHOwx)). 

```{r ribbonHOwx, fig.asp = 0.9, include=TRUE, fig.cap="Marginal effects of temperature, wind, pressure, and precipitation on the predicted haul-out probability of ribbon seals within each age and sex classification. Hour of the day was fixed at local solar noon and day-of-year fixed at 15 May. Vertical lines represent the 95\\% confidence interval around the predicted haul-out probability."}

targets::tar_load(ribbon_wx_plot, store = here::here("_targets"))

ribbon_wx_plot
```

## Spotted Seals {-}

```{r plnewdata}
targets::tar_load(spotted_newdata, store = here::here("_targets"))
```

Compared to ribbon seals, spotted seals showed a longer spring haul-out season
that was less intensely centered on solar noon (Figure \@ref(fig:spottedHOCal);
see also \@ref(fig:spottedPredSE)). Adults of both sexes spent considerable time
in April, May and June hauled out. In contrast to ribbon seals, adult spotted
seal males had a more protracted haul-out season compared to females, and more
time out of the water in June (Figures \@ref(fig:ribbonHOCal) and
\@ref(fig:spottedHOCal)). As with ribbon seals, the young-of-the-year records
began after weaning and the model predictions demonstrated the development of
in-water activities (e.g. swimming, foraging) in May.

```{r spottedHOCal, fig.asp = 0.9, include=TRUE, fig.cap="Predicted hourly haul-out probability of spotted seals from 1 March to 30 June for each age and sex class used in the model. Compared to ribbon seals, the period of increased haul-out behavior is broader and there is more alignment in the seasonal timing of haul-out behavior across age and sex classifications. This likely reflects the triad behavior in spotted seals when suitor males haul out with nursing females. As with ribbon seals, redictions for young of the year show their transition from newly weaned pups resting on the ice to more in-water activities. Predictions in July and before 15 March were not included to avoid spurious model predictions at the edge of the data range."}

plot_df <- spotted_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label = TRUE),
         day = lubridate::day(date)) %>%
  filter(!month %in% c("Jul","Aug"),
         lubridate::yday(date) >73)

p <- ggplot(plot_df, aes(day,solar_hour,fill = ho_prob, color = ho_prob)) +
  geom_tile(linewidth = 0.15) +
  scico::scale_fill_scico(palette = "navia", direction = 1,
                          begin = 0.1, end = 1,
                       name = "haul-out probability", 
                       limits = c(0,1), breaks = c(0.25, 0.50, 0.75),
                       guide = guide_colorbar(title.position = "bottom", barwidth = 15,
                                              barheight = 0.5, title.hjust = 0.5)
  ) +
  scico::scale_color_scico(palette = "navia", direction = 1,
                           begin = 0.1, end = 1,
                           limits = c(0,1)) +
  guides(col = FALSE)

p <- p + facet_grid(age_sex~month,
                    scales = "free_x",
                    space = "free_x",
                    labeller = labeller(
                      age_sex = age_sex_labels
                    ))
p <- p + scale_x_continuous(breaks = c(5,10,15,20,25)) +
  scale_y_continuous(breaks = c(4,12,20), labels = c("04","12", "20")) +
  coord_cartesian(expand=FALSE)
p <- p + theme(panel.spacing = unit(0.1, "lines"),
               legend.position = "bottom",
               strip.background = element_rect(colour="white"),
               axis.ticks=element_blank()) +
  xlab("day of month") + ylab("local solar hour") +
  ggtitle("Spotted seal predicted haul-out probability",
          subtitle = "Our model predicts increased haul-out probability 
          for spotted seals centered on solar noon with general alignment in the
          seasonal timing across age and sex classifications.")
p
```

Spotted seal haul-out behavior was less affected by the weather covariates 
compared to ribbon and bearded seals but their influence on the model was still
significant in some cases.
Temperature
($F_{`r paste(spotted_type3$temp2m$Num.df, spotted_type3$temp2m$Den.df, sep=",")`}$
= `r spotted_type3$temp2m$F.value`; $p$ = `r spotted_type3$temp2m$Prob.F`), wind
($F_{`r paste(spotted_type3$wind$Num.df, spotted_type3$wind$Den.df, sep=",")`}$
= `r spotted_type3$wind$F.value`; $p$ = `r spotted_type3$wind$Prob.F`),
and barometric pressure
($F_{`r paste(spotted_type3$pressure$Num.df, spotted_type3$pressure$Den.df, sep=",")`}$
= `r spotted_type3$pressure$F.value`; $p$ =
`r spotted_type3$pressure$Prob.F`) were all significant. Spotted seals were less likely to
haul out at higher winds and more likely to be on the ice when
temperatures were relatively warm. Wind chill 
($F_{`r paste(spotted_type3$temp2m_wind$Num.df, spotted_type3$temp2m_wind$Den.df, sep=",")`}$
= `r spotted_type3$temp2m_wind$F.value`; $p$ =
`r spotted_type3$temp2m_wind$Prob.F`) and
precipitation 
($F_{`r paste(spotted_type3$precip$Num.df, spotted_type3$precip$Den.df, sep=",")`}$
= `r spotted_type3$precip$F.value`; $p$ =
`r spotted_type3$precip$Prob.F`)
were not as influential as the other covariates.
Differences in the magnitude of response between the age-sex classes were
present and consistent across each of the weather covariates (Figure
\@ref(fig:spottedHOwx)). There was a consistent ranking of adult males being the most
likely to haul out, followed by adult females, and, then, subadults. This differs
from ribbon seals which showed more overlap between adult males and adult females
and that subadults were most likely to haul out across the presented range of weather
covariates.

```{r spottedHOwx,fig.asp = 0.9, include=TRUE, fig.cap="Marginal effects of temperature, wind, pressure, and precipitation on the predicted haul-out probability of spotted seals within each age and sex classification. Hour of the day was fixed at local solar noon and day-of-year fixed at 15 May. Vertical lines represent the 95\\% confidence interval around the predicted haul-out probability."}

targets::tar_load(spotted_wx_plot, store = here::here("_targets"))

spotted_wx_plot
```


## Annual variation in haul-out timing {-}

```{r hfpvyear}
targets::tar_load(ribbon_newdata_year, store = here::here("_targets"))
targets::tar_load(spotted_newdata_year, store = here::here("_targets"))
```

```{r type3_year}
ribbon_year_type3 <- tibble(
  ribbon_year_fit$typeIII.hypoth
) %>% 
  mutate(# Prob.F = ifelse(Prob.F<0.001, "<0.01",Prob.F),
         Prob.F = scales::pvalue(Prob.F),
         Effect = janitor::make_clean_names(Effect)) %>% 
  column_to_rownames(var = "Effect") 
ribbon_year_type3 <- setNames(split(ribbon_year_type3, 
                               seq(nrow(ribbon_year_type3))), 
                         rownames(ribbon_year_type3))

spotted_year_type3 <- tibble(
  spotted_year_fit$typeIII.hypoth
) %>% 
  mutate(# Prob.F = ifelse(Prob.F<0.001, "<0.01",Prob.F),
         Prob.F = scales::pvalue(Prob.F),
         Effect = janitor::make_clean_names(Effect)) %>%  
  column_to_rownames(var = "Effect")  
spotted_year_type3 <- setNames(split(spotted_year_type3, 
                               seq(nrow(spotted_year_type3))), 
                         rownames(spotted_year_type3))
```

The second set of models, which included annual variation in haul-out
patterns, uncovered significant contributions for linear and quadratic
interactions between day and year in both ribbon seals (day:year,
$F_{`r paste(ribbon_year_type3$day_year$Num.df, ribbon_year_type3$day_year$Den.df, sep=",")`}$
= `r ribbon_year_type3$day_year$F.value`; $p$ =
`r ribbon_year_type3$day_year$Prob.F`; day^2^:year,
$F_{`r paste(ribbon_year_type3$day2_year$Num.df, ribbon_year_type3$day2_year$Den.df, sep=",")`}$
= `r ribbon_year_type3$day2_year$F.value`; $p$ =
`r ribbon_year_type3$day2_year$Prob.F`) and spotted seals (day:year,
$F_{`r paste(spotted_year_type3$day_year$Num.df, spotted_year_type3$day_year$Den.df, sep=",")`}$
= `r spotted_year_type3$day_year$F.value`; $p$ =
`r spotted_year_type3$day_year$Prob.F`; day^2^:year,
$F_{`r paste(spotted_year_type3$day2_year$Num.df, spotted_year_type3$day2_year$Den.df, sep=",")`}$
= `r spotted_year_type3$day2_year$F.value`; $p$ =
`r spotted_year_type3$day2_year$Prob.F`). Predicted distributions of
haul-out activity were largely unimodal, but varied some among and
within years with respect to the timing and magnitude of haul-out peaks
(Figure \@ref(fig:annualHO)). It is important to note that predicted
variation in annual haul-out patterns likely reflected both process error
and sampling variability. While we did remove any years where only one
deployment in a species + age:sex group was present, there were still
some years where the pattern shown was informed by a small number of
individuals that may not represent population-level patterns.

```{r annualHO, fig.asp = 0.75, include=TRUE, fig.cap="Annual variability in the timing of peak haul-out probability (colored markers) for ribbon and spotted seals across 14 years. The full seasonal range of annual predictions along with uncertainty are shown as grey lines. Covariates were fixed at local solar noon and under smoothed weather conditions. Only those groups (age:sex + year) that included observations from more than one seal are shown. Additionally, any groups where data were only available after 1 June or before 1 May are not included."}

select_groups <- ribbon_year_fit$dataset %>%
  filter(age_sex != "YOUNG OF YEAR") %>%
  group_by(age_sex, year) %>%
  summarise(n = n_distinct(speno), group_id = paste0(age_sex,year)) %>%
  filter(n >1) %>% pull(group_id)

plot_df <- ribbon_newdata_year %>%
  mutate(species = "Ribbon seal",
         date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label=TRUE),
         day = lubridate::day(date)) %>%
  filter(month != "Aug", paste0(age_sex,year) %in% select_groups)

peak_ho_df <- plot_df %>% filter(age_sex != "YOUNG OF YEAR",
                                 yday > 100) %>%
  group_by(species, age_sex, year) %>% slice_max(ho_prob)

select_groups <- spotted_year_fit$dataset %>%
  filter(age_sex != "YOUNG OF YEAR") %>%
  group_by(age_sex, year) %>%
  summarise(n = n_distinct(speno), group_id = paste0(age_sex,year)) %>%
  filter(n >1) %>% pull(group_id)

plot_df2 <- spotted_newdata_year %>%
  mutate(species = "Spotted seal",
         date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label=TRUE),
         day = lubridate::day(date)) %>%
  filter(month != "Aug", paste0(age_sex,year) %in% select_groups)

peak_ho_df2 <- plot_df2 %>% filter(age_sex != "YOUNG OF YEAR",
                                 yday > 100) %>%
  group_by(species, age_sex, year) %>% slice_max(ho_prob)

plot_df <- plot_df %>% 
  bind_rows(plot_df2) %>% 
  mutate(year = forcats::fct_relevel(.$year, sort))
peak_ho_df <- peak_ho_df %>% 
  bind_rows(peak_ho_df2) %>% ungroup() %>% 
  mutate(year = forcats::fct_relevel(.$year, sort))

pal <- c(rcartocolor::carto_pal(12,'Bold')[1:11],
         rcartocolor::carto_pal(12,'Antique')[1:11])

p <-
  ggplot(plot_df %>% filter(age_sex != "YOUNG OF YEAR"), aes(yday, ho_prob)) +
  geom_pointrange(
    aes(ymin = lower95, ymax = upper95),
    alpha = 0.25,
    stroke = 0,
    color = "grey80"
  ) +
  geom_pointrange(
    data = peak_ho_df,
    mapping = aes(
      yday,
      ho_prob,
      ymin = 0,
      ymax = ho_prob,
      color = year
    ),
    shape = 15
  ) +
  scale_color_discrete(type = pal) +
  scale_x_continuous(
    breaks = c(74, 105, 135, 166),
    labels = c("15-Mar", "15-Apr", "15-May", "15-Jun")
  ) +
  scale_y_continuous(breaks = c(0.2,0.4,0.6,0.8), labels = c("0.2","0.4", "0.6", "0.8")) +
  guides(col = guide_legend(ncol = 7)) +
  facet_grid(age_sex ~ species,
             labeller = labeller(
                      age_sex = age_sex_labels
                    )) +
  ylab("haul-out probability") +
  labs(title = "Annual variability in the timing of peak haul-out probability",
       subtitle = "Predictions of maximum annual haul-out probability for ribbon and spotted seals are indicated by the colored squares with grey lines showing the individual seasonal trajectories and uncertainty.",
       caption = "predictions are shown for local solar noon and under smoothed weather conditions") +
  theme(legend.position = "bottom",
        axis.title.x = element_blank()) 
  
  p
```

```{r}
targets::tar_load(sea_ice_extent, store = here::here("_targets"))
extent_max <- sea_ice_extent %>%
  dplyr::bind_rows() %>%
  dplyr::mutate(year = lubridate::year(fdate) %>% forcats::as_factor(),
                yday = lubridate::yday(fdate)) %>% 
  dplyr::filter(area_km2_epsg3571 > 345609.6) %>%
  slice_max(area_km2_epsg3571, by=year) %>% 
  rename(max_extent_km2 = area_km2_epsg3571,
         max_extent_yday = yday) %>% 
  dplyr::select(-fdate)

extent_lookup <- sea_ice_extent %>%
  dplyr::bind_rows() %>% 
  rename(extent_km2 = area_km2_epsg3571)

peak_ho_df <- peak_ho_df %>% left_join(extent_max, 
                                       by = "year") %>% 
  left_join(extent_lookup, by = c("date" = "fdate")) %>% 
  mutate(peak_diff_days = yday - max_extent_yday) %>% 
  distinct() %>% 
  mutate(max_extent_km2 = max_extent_km2/1000)

models <- peak_ho_df %>% 
  group_by(species, age_sex) %>%  
  nest() %>% 
  mutate(model = map(data, ~ lm(max_extent_km2 ~ yday, data = .x))) %>% 
  mutate(glance = map(model, broom::glance)) %>% 
  unnest(glance)

hf_adultF <- models %>% filter(species == "Ribbon seal" & age_sex == "ADULT.F") %>% 
  dplyr::select(r.squared, statistic, p.value)
hf_adultM <- models %>% filter(species == "Ribbon seal" & age_sex == "ADULT.M") %>% 
  dplyr::select(r.squared, statistic, p.value)
hf_subadult <- models %>% filter(species == "Ribbon seal" & age_sex == "SUBADULT") %>% 
  dplyr::select(r.squared, statistic, p.value)
pl_adultF <- models %>% filter(species == "Spotted seal" & age_sex == "ADULT.F") %>% 
  dplyr::select(r.squared, statistic, p.value)
pl_adultM <- models %>% filter(species == "Spotted seal" & age_sex == "ADULT.M") %>% 
  dplyr::select(r.squared, statistic, p.value)
pl_subadult <- models %>% filter(species == "Spotted seal" & age_sex == "SUBADULT") %>% 
  dplyr::select(r.squared, statistic, p.value)

```

The annual timing of peak haul-out probability for ribbon seals and adult
male spotted seals appeared to have
no relationship with the amount of yearly maximum sea ice extent in the
study area. For ribbon seals and adult male spotted seals,
$p$-values were substantially larger than 0.05 (ribbon seal adult
females; $R^{2}$ = `r hf_adultF$r.squared`, $p$ = `r hf_adultF$p.value`;
ribbon seal adult males: $R^{2}$ = `r hf_adultM$r.squared`, $p$ =
`r hf_adultM$p.value`; ribbon seal subadults: $R^{2}$ =
`r hf_subadult$r.squared`, $p$ = `r hf_subadult$p.value`; spotted seals
adult males: $R^{2}$ = `r pl_adultM$r.squared`, $p$ =
`r pl_adultM$p.value`). Adult female and subadult spotted seals both
showed a negative trend (peak haul-out occurs later in years with less
sea ice) with a significant relationship for adult female spotted seals 
(spotted seal adult female: $R^{2}$ =
`r pl_adultF$r.squared`, $p$ = `r pl_adultF$p.value`; spotted seal
subadults: $R^{2}$ = `r pl_subadult$r.squared`, $p$ =
`r pl_subadult$p.value`). 

```{r maxextentHO, fig.height = 5.5, include=FALSE, fig.cap="Annual timing of peak haul-out behavior analyzed against the yearly maximum area of sea ice extent in the study area. While spotted seal adult females and subadults show a negative trend line, none of the relationships were determined to be significant."}

ggplot(data = peak_ho_df, aes(y = max_extent_km2, x = yday, color = species)) + 
  geom_smooth(method = "lm", alpha = 0.2, aes(fill = species)) +
  geom_point() +
  facet_grid(age_sex~.) +
  scale_x_continuous(breaks = c(125,135,145, 156),
                     labels = c("05-May", "15-May", "25-May", "05-Jun")) +
  scale_color_manual(values = c('#E66100','#5D3A9B'), name = "") +
  scale_fill_manual(values = c('#E66100','#5D3A9B'), name = "") +
  theme(legend.position = "top",
        legend.justification = "right") +
  labs(x = "date of peak haul-out", y = "maximum sea ice extent (km<sup>2</sup> / 1000)",
       title = "The relationship between yearly maximum sea ice extent and the \nannual timing of peak haul-out probability") +
  theme(axis.title.y = element_markdown())
  
```

# Discussion {-}

We modeled data from bio-loggers deployed on bearded, ribbon, and spotted seals
to examine factors affecting haul-out behavior on sea ice in the Bering and
Chukchi seas. Our analysis shows all three species of seal haul out
progressively more through the spring and peak near mid-May to early June before
declining again. This pattern aligns well with what has been previously
documented qualitatively [@boveng2009; @boveng2013; @cameron2010] and confirms
our haul-out data are likely quantifying population-level behavioral patterns.
Seals preferentially haul out on ice shortly after solar noon, which allows
seals to maximize absorption of solar radiation thought to facilitate the
molting process [@feltz1966]. Interestingly, bearded seals appear to have two
peaks in haul-out activity within a day, one shortly after solar noon, and one
centered near solar midnight. This, of course, could be an artifact of our
limited sample size for bearded seal deployments across all age classes.
However, a similar bi-modal pattern has been seen in ringed seals
[@vonduyke2020] and suggests that bearded and ringed seals may be operating
under different constraints than ribbon and spotted seals. Bearded and ringed
seals are distributed across higher latitudes and the extended daylight hours
may allow more flexibility in optimizing resting periods with foraging. Other
factors such as predation by polar bears (which is rare for ribbon and spotted
seals in the Bering Sea) may also explain differing haul-out patterns. The
change in haul-out behavior during the season was less pronounced in bearded
seals compared to ribbon and spotted seals. This aligns with findings from
Thometz et al. [@thometz2021] who observed a mean molting period of 119&pm;2
days and a relatively stable resting metabolic rate during that time. While
ribbon seals were not considered in that same study, spotted and ringed seals
underwent molt periods of just 33&pm;4 and 28&pm;6 days and had increased
resting metabolic rates.

Unlike previous analyses of seal haul-out behavior in spotted and ribbon seals
(e.g. [@verhoef2010a], [@conn2013b]), we also investigated the influence of
sex-age class on haul-out probabilities for both species (not for bearded seals
because of low sample size). Field identification of age class can be inexact,
particularly when differentiating subadults from adults. In the case of ribbon
seals, subadults often have less distinct ribbons than adults. Spotted seal
pelage cannot be used to reliably discern adults from subadults. Despite these
challenges, we feel the age classifications used in this analysis are useful in
testing for age-related effects on haul-out behavior.

Although ribbon and spotted seals exhibited a
unimodal diel haul-out pattern generally centered around local solar noon, there
were key differences across species, age, and sex that match our understanding
from natural history descriptions of their ecological behavior. Spotted seals
are known to form triads during the breeding season where a female and dependent
pup are accompanied on the ice by a suitor male [@frost2018]. The male waits for
the female to wean the pup and enter estrus, and fends off any other potential
suitor males. Triad formation results in both males and females spending a large
portion of the day hauled out on ice and a protracted spring haul-out season for
both sexes. While females are still nursing the pup and not yet in estrus they
may be less inclined to interrupt their haul out and enter the water where the
suitor male would attempt mating. We see this reflected in the predicted
haul-out patterns, with both males and females exhibiting a broad distribution
of time out of the water throughout the solar day and the season. Ribbon seals
are not known to form triads and our model predicts a progression of increased
haul-out behavior with females starting earlier in the season than males.
Notably, female ribbon seals spend a large portion of the day in the water
during the pupping period, aligning with the hypothesis that ribbon seal females
continue foraging while nursing. Subadult ribbon and spotted seals begin
elevated haul-out behavior earlier in the spring and follow a pattern seen in
other phocids where yearlings and subadults molt first followed by adult females
and males [@reder2003, @thompson1987, @kirkman2003].

We also investigated the influence of weather on haul-out probabilities,
including wind speed, temperature, barometric pressure, precipitation, and wind
chill. These have been investigated for walruses (e.g. Udevitz et al.
[-@udevitz2009]) and a few select studies of ice-associated seals
[@hamilton2018, @perry2017]. In our study, ribbon seals seemed to be the most
influenced by weather, with wind, temperature, and barometric pressure all being
important components of the model. Spotted seals were most affected by wind and
barometric pressure. For bearded seals, the model indicated wind and
temperature had the greatest impact. In general, and as might be expected, seals
were more likely to haul-out when daily temperatures were warmer, winds speeds
were lower, barometric pressure was higher, and precipitation was lower. Those
weather conditions are general indicators of increased solar radiation and lower
convective heat loss, both of which provides energetic benefits. Low winds and
precipitation could also enhance predator detection. Our results highlight the
importance of incorporating weather covariates when analyzing haul-out behavior
and calculating availability corrections for aerial surveys.

Notably missing from our list of explanatory variables is any spatial-temporal
representation of sea ice concentration, area, or extent. This may seem
counterintuitive when modeling the haul-out behavior of seal species with such a
close association to sea ice; seals haul out in the presence of sea ice, and we
could assess the local concentration of sea ice during these events (see
[@olnes2020]). This, however, expands the scope of our analysis into the realm
of habitat selection and many of our deployments consisted of a single device
attached to the rear flipper of the seal which did not provide at-sea locations,
limiting our ability to fully evaluate fine-scale habitat preferences related to
sea-ice. Insight into how seals use and interact with sea-ice during an extended
period when the availability and characteristics of sea-ice is rapidly changing
is important but ancillary to the focus of this analysis. The focus of this
study was to develop models applicable for aerial survey correction factors and
using sea ice as a covariate would almost certainly bias haul-out predictions
towards those seals that are on or near ice and therefore more likely to haul
out. Since aerial surveys can only detect seals on ice, abundance estimates
would be missing a correction for those seals that are away from ice. 

Consider
the case of employing haul-out probabilities as an aerial survey correction in a
population inhabiting two areas: an ice-free region and a region with sea ice.
Further, assume that half of the population is in each area on average, and that
the probability of hauling out is 1.0 in the ice covered region and 0.0 in the
region without ice.  Denoting the total population as $N$, let us examine what
happens when we use (1) population level availability, and (2) ice-specific
availability as a correction factor.  We'll further assume, for sake of this
example, that detection probability of seals on ice is 1.0, and that the
entirety of the ice covered region is censused. In case (1), our aerial survey
count is $C = 0.5 \cdot N$, with a population-level availability probability of
$\hat{a} = 0.5$. A Horvitz-Thompson-type estimator for abundance is simply 
$\hat{N} = C \div \hat{a}$, which has expectation 
$\mathbb{E}(\hat{a}) = \frac{0.5 \cdot N}{0.5} = N$, as desired.  Now
consider case (2).  In this case, the probability of hauling out is 1.0 for
seals in the ice-covered area, so we have 
$\mathbb{E}(\hat{N}) = \frac{0.5 \cdot N}{1.0} = 0.5N$. That
is, we bias abundance because we are not accounting for seals that are away from
ice, and therefore have a zero chance of hauling out. The same logic holds for
any other covariate, such as distance from the ice edge, that has different
values in the surveyed and unsurveyed habitat of the seals (assuming distance
from ice edge is coded with opposite signs inside and outside the pack ice).

Lastly, our study was limited to the spring season when seal haul-out behaviors
are strongly influenced by pupping, nursing, breeding behavior, and molt and
these drivers are likely more influential than specific sea-ice concentration.
Crawford et al. [-@crawford2019] compared haul-out probability models for ringed
seals and found those that only included season (and not sea-ice concentration)
were the most parsimonious. For these reasons, we have elected not to use sea
ice concentration _as a predictor for haul-out probability_ in the present
study.

Our models detected small deviations in the timing and magnitude of annual peaks
in haul-out behavior for ribbon and spotted seals. The timing of peak haul-out
activity appears to fall within a relatively narrow time window of 3-4 weeks in
late May and early June. This consistency across 15 years is likely a reflection
of the relationship between a critical photoperiod and the timing of important
life history stages [@bronson2009; @temte1994]. However, along with a critical
photoperiod, ribbon and spotted seals are dependent upon the presence of sea ice
for pupping and molt. We did not find large support in our models for a
relationship between the timing of peaks in haul-out behavior and the amount of
yearly maximum sea ice. This could indicate that, while the extent of spring sea
ice in the Bering Sea varied widely during our study period, seals were still
able to locate sea ice and haul out. Only a small portion of our data was from
2018 – 2019, years of extreme low spring ice extent in the Bering Sea that
appeared to impact body condition of ribbon and spotted seals [@boveng2020], so we may
currently lack sufficient contrast in ice extent to characterize an effect on
haul-out probability. We should expect, however, that some minimal threshold in
the spatial extent or density of sea ice will have a meaningful impact on the
timing of peak haul-out behavior --- if there is no sea ice, seals will not haul
out or be forced to use terrestrial haul-out sites which were not part of the
evolution of their normal behaviors. Additionally, while from an
ecological perspective the haul-out behavior appears consistent, the interannual
differences in timing and magnitude are large enough to have important
ramifications on calculations of abundance and trend. Those ramifications will
only be exacerbated if climate variability amplifies interannual differences.

Previous attempts to estimate the abundance of phocid seals from aerial survey
data in the Bering and Chukchi seas (e.g. @bengtson2005a, @conn2014a,
proportion of animals that are in the water and thus unavailable to be counted.
Although several of these studies allowed haul-out probabilities to vary by
day-of-year and time-of-day, they have not accounted for variability among
years, in weather conditions, and in the age-sex class of the sample. In this
paper, we have shown that there can be considerable differences in the number of
seals hauled out on ice based on these factors. We recommend that future
abundance analyses employ availability models that account for them. For
instance, it is relatively straightforward to obtain weather reanalysis products
for times and locations that are surveyed and to construct a relevant correction
factor based on predictions of GLMPMs. The most challenging element in
developing availability correction factors is with annual variability. It can be
difficult to get a sufficient sample size to estimate year-specific correction
factors, particularly because research teams would likely need to tag seals and
conduct aerial surveys concurrently, requiring considerably more personnel
and money. One possible suggestion is to estimate a "shift" parameter within
models for aerial survey counts that allow the peak of haul-out distributions to
be adjusted earlier or later in the year based on the frequency of counts
observed over time. Regardless, researchers should anticipate there being some
unmodeled heterogeneity in availability when using aerial surveys to estimate
Arctic seal abundance. This may require consideration in trend estimation,
as one will not know if moderate differences in abundance estimates are
attributable to changes in abundance or changes in haul-out behavior.

Predictions of absolute haul-out probability in this paper were somewhat
different than those previously reported for these species, especially for
bearded seals. For instance, Ver Hoef et al. [-@verhoef2014a] and Conn et al.
[-@conn2014a] used haul-out correction factors with maximums of 0.66 for bearded
seals, 0.62 for ribbon seals, and 0.54 for spotted seals, where these maximums
corresponded to times near solar noon in mid-late May. Our current estimates
of haul-out probability reflect increased sample sizes in terms of
number of individuals, inclusion of weather covariates, and improvements to the 
way data were prepared prior to analysis.

We focused this paper on haul-out behavior of bearded, ribbon, and spotted
seals. Ringed seals are also present in the Bering and Chukchi seas but exhibit
a unique complicating factor. Adult ringed seals build subnivean lairs under the
snow on top of the sea ice, where they haul out and where females rear pups
until conditions are good for basking [@frost2004]. Thus, the wet-dry sensor on
a bio-logger could indicate that an animal is hauled out, but if it is within a
lair, it is not available to be detected during an aerial survey. We hope to
address availability of ringed seals using data from satellite tags, replicate
survey tracks, and auxiliary information about snow depth and timing of melt in
a future study.

# Author Contributions {-}

* **Josh M. London**: investigation, conceptualization, methodology,
formal analysis, validation, software, writing: original draft, writing:
review and editing, visualization, and data curation
* **Paul B. Conn**: conceptualization, methodology, formal analysis,
software, validation, writing: original draft, writing: review and
editing
* **Stacie K. Hardy**: investigation, data curation, methodology,
validation, writing: review and editing
* **Erin L. Richmond**: data curation, investigation, methodology,
validation, writing: review and editing
* **Jay M. Ver Hoef**: conceptualization, methodology, software, writing:
review and editing
* **Michael F. Cameron**: investigation, project administration, writing:
review and editing
* **Justin A. Crawford**: investigation, methodology, validation, data curation, 
writing: review and editing
* **Lori T. Quakenbush**: investigation, methodology, supervision, project
administration, writing: review and editing
* **Andrew L. Von Duyke**: investigation, methodology, validation, data curation,
writing: review and editing
* **Peter L. Boveng**: investigation, conceptualization, supervision,
project administration, writing: review and editing

# Data Availability {-}

This manuscript was developed as a reproducible research compendium. All data and
code are available on GitHub (https://github.com/noaa-afsc/berchukseals-haulout) and
major versions archived at Zenodo (https://doi.org/10.5281/zenodo.4638221).
Original data sources for telemetry are archived
at the United States Animal Telemetry Network, archived at Movebank, or
associated with other published manuscripts (see supplemental 
material \@ref(tab:deploymentTable)). Collated and cleaned data products
needed to replicate the analysis are available in a separate GitHub
repository (https://github.com/noaa-afsc/berchukseals-data) and archived at 
Zenodo. Similarly, all model fits are available on 
GitHub (https://github.com/noaa-afsc/berchukseals-fits) and archived at Zenodo.

# Acknowledgments {-}

We recognize that the species and ecosystems we studied are within the ancestral
and present-day environs of the Inpuiat and Yup'ik people who, through many
uncredited contributions of traditional knowledge, provided early western
naturalists and scientists with much of what gets described as the ‘basic
biology’ of Arctic seals. The deployment of bio-logging devices used in this
study were often done in collaboration with Alaska Native seal hunters near
their communities. We would like to especially acknowledge the communities of
Kotzebue, Koyuk, Nome, Nuiqsut, Scammon Bay, St. Michael, Utqiaġvik, and Ulguniq
(Wainwright) and the following individuals: James Adams, Jeff Barger, David
Barr, Wendell Booth, Cyrus Harris, Nereus 'Doc' Harris, Grover Harris, Lee
Harris, Tom Jones, Frank Garfield, Brenda Goodwin, Henry Goodwin, John Goodwin,
Pearl Goodwin, Willie Goodwin, Brett Kirk, Noah Naylor, Virgil Naylor Jr.,
Virgil Naylor Sr., Dan Savetilik, Chuck Schaeffer, Ross Schaeffer, Allen Stone,
and Randy Toshavik from Kotzebue, Alaska; Merlin Henry from Koyuk, Alaska; Tom
Gray from Nome; Vernon Long and Richard Tukle from Nuiqsuit, Alaska; Morgan
Simon, River Simon, and Al Smith from Scammon Bay, Alaska; Alex Niksik Jr. from
St. Michael, Alaska; Billy Adams, James Aiken, Tim Aiken, Howard Kittick,
Gilbert Leavitt, Isaac Leavitt, J.R. Leavitt, and Joe Skin from Utqiaġvik,
Alaska; Mary Ellen Ahmaogak, Enoch Oktollik, Shawn Oktollik, Stacey Osborn, and
Fred Rexford from Ulguniq, Alaska.

We are grateful for the assistance in catching and sampling seals by Ryan Adam,
James Bailey, Michelle Barbieri, John Bengtson, Gavin Brady, Vladamir Burkanov,
Cynthia Christman, Sarah Coburn, Shawn Dahle, Rob Delong, Stacy DiRocco, Deb
Fauquier, Shannon Fitzgerald, Kathy Frost, Scott Gende, Tracey Goldstein, Jeff
Harris, Jason Herreman, Markus Horning, John Jansen, Shawn Johnson, Charles
Littnan, Lloyd Lowry, Brett McClintock, Erin Moreland, Mark Nelson, Justin
Olnes, Lorrie Rea, Bob Shears, Gay Sheffield, Brent Stewart, Dave Withrow, and
Heather Ziel. We also appreciate the commitment to science and safety by all
officers and crew of the NOAA ship _Oscar Dyson_, the NOAA ship _MacArthur II_, and
the RV _Thomas G. Thompson_.

Telemetry data from the Alaska Department of Fish and Game (ADFG) and the North
Slope Borough Department of Wildlife Management (NSB) were important
contributions to the findings presented here. Deployments in the western Bering
Sea were done in collaboration with Russian colleagues and North Pacific
Wildlife.

The findings and conclusions in the paper are those of the author(s) and do not
necessarily represent the views of the National Marine Fisheries Service, NOAA.
Any use of trade, product, or firm names does not imply an endorsement by the
U.S. Government. Funding for this study was provided by the U.S. National
Oceanic and Atmospheric Administration. The field work was conducted under the
authority of Marine Mammal Protection Act Research Permits Nos. 782-1676,
782-1765, 15126, and 19309 issued by the National Marine Fisheries Service, and
Letters of Assurance of Compliance with Animal Welfare Act regulations, Nos.
A/NW 2010-3 and A/NW 2016-1 from the Alaska Fisheries Science Center/Northwest
Fisheries Science Center Institutional Animal Care and Use Committee (IACUC). ).
Funding to ADFG for tagging seals was provided by the Bureau of Ocean Energy
Management (No. M13PC0015) and the Office of Naval Research (No.
N00014-16-1-3019). ADFG and NSB field work was covered by Research Permits Nos.
358-1585, 358-1787, 15324, and 20466 and by ADF&G IACUC permits Nos. 06-16,
09-21, 2014-03, 2015-25, 2016-23, 0027-2017-27, 0027-2018-29, 0027-2019-041.

# References {-}

::: {#refs}
:::

\newpage
\beginsupplement
\blandscape
# Supplemental Material {-} 

## Additional Bio-logger Deployment Details

```{r deploymentTable, include=TRUE, tab.cap="The following table provides additional details about the timing, location, and institutions responsible for the bio-logger deployments used in this study along with research permits and any associated publications."}
library(gt)
library(googlesheets4)
library(glue)

options(
  gargle_oauth_cache = here::here(".secrets"),
  gargle_oauth_email = "josh.london@noaa.gov"
)

gs4_auth()

deploy_tbl <- read_sheet("1MpCiyAKWLBXufwnzW8QTnb2SsTkrKSuPlWdpWMnqoto")


deploy_tbl <- deploy_tbl %>% 
  dplyr::select(species, agency, deploy_year, permit, location, speno, sex, age, publications) %>% 
  dplyr::mutate(deploy_year = forcats::as_factor(deploy_year)) %>%
  dplyr::group_by(species, agency, deploy_year, location, publications) %>% 
  dplyr::mutate(agency = 
                  case_when(
                    agency %in% c('ADFG') ~ "ADFG",
                    agency %in% c('NSB') ~ "NSB",
                    agency %in% c('PEP') ~ "NMFS",
                    agency %in% c('NPWC') ~ "NPWC"
                  )) %>% 
  dplyr::summarise(permits = toString(unique(permit)),
                   n_seals = n(),
                   sex = toString(unique(sex)),
                   age_class = tolower(toString(unique(age)))) %>% 
  dplyr::arrange(species, agency, deploy_year)
  
  deploy_tbl <- as_grouped_data(deploy_tbl,groups="species") %>% 
  flextable::as_flextable(hide_grouplabel = TRUE) %>% 
    flextable::width(j = c('agency','deploy_year','location','publications','permits',
                'n_seals', 'sex', 'age_class'), 
          width = c(1, 0.8, 1.5, 1.5, 0.8, 0.8, 0.8, 1.5)) %>%
    flextable::align(j = 'n_seals', align = 'left', part = 'all') %>%
  set_header_labels(
    agency = "Institution",
    deploy_year = "Year Deployed",
    location = "Location",
    publications = "Publication(s)",
    permits = "Permits",
    n_seals = "No. Seals",
    sex = "Sex",
    age_class = "Age_Class"
  ) %>%
  bold(j = 1, i = ~ !is.na(species), bold = TRUE, part = "body") %>%
  bold(part = "header", bold = TRUE) %>%
  add_footer_lines(as_paragraph(
    as_b("ADFG"),"=Alaska Department of Fish and Game; ", as_b("NSB"),"=North Slope Borough; ", as_b("NMFS"),"=NOAA National Marine Fisheries Service; ", as_b("NPWC"),"=North Pacific Wildlife Consortium"
  )) %>%
    fontsize(size = 10, part ="header") %>%
    fontsize(size = 9, part = "body") %>%
    fontsize(size = 8, part = "footer") %>%
  set_table_properties(layout = "fixed",
                       opts_pdf = list('caption_repeat' = FALSE))

deploy_tbl
  
```
\elandscape

## Supplemental Figures Showing Confidence Intervals Associated with Predictions

The following series of figures (\@ref(fig:beardedPredSE), \@ref(fig:ribbonPredSE),
and \@ref(fig:spottedPredSE)) show the seasonal variability in predicted haul-out
probability and the associated 95% confidence intervals for bearded, ribbon, and
spotted seals. The predictions shown are based on the same data used in
\@ref(fig:beardedHOCal), \@ref(fig:ribbonHOCal), and \@ref(fig:spottedHOCal) but
selected for three to local solar hours (07:00, 12:00, and 17:00) so the 
confidence intervals can also be shown and comparisons can be made.

```{r}
local_solar_labels <- c(
  '7' = '07:00',
  '12' = '12:00',
  '17' = '17:00'
)
```



```{r beardedPredSE,fig.asp = 0.5, include = TRUE, fig.cap="Seasonal variability in haul-out probability and the associated 95\\% confidence intervals (shaded area) for bearded seals. Model predictions are shown for three local solar hours (07:00, 12:00, and 17:00) with smoothed weather covariates. Age and sex classes are combined into a single 'all ages' category."}
plot_df <- bearded_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label = TRUE),
         day = lubridate::day(date)) %>%
  filter(!month %in% c("Jul","Aug"),
         lubridate::yday(date) >73,
         solar_hour %in% c(7,12,17))

bearded_predse <- ggplot(plot_df, aes(date,ho_prob)) +
  geom_ribbon(aes(ymin=lower95,ymax=upper95), 
              fill = species_colors['Bearded seal'], alpha = 0.3) +
  geom_line(aes(date,ho_prob),
            color = species_colors['Bearded seal']) +
  facet_grid(age_sex ~ solar_hour,
             scales = "free_x",
                    space = "free_x",
                    labeller = labeller(
                      age_sex = age_sex_labels,
                      solar_hour = local_solar_labels
                    )) +
  scale_y_continuous(breaks = c(0.2,0.4,0.6,0.8), labels = c("0.2","0.4", "0.6", "0.8"), limits = c(0,1)) +
  xlab("day of year") +
  ylab("haul-out probability") +
  labs(title = "Bearded seal predicted haul-out probability with uncertainty",
       subtitle = "predictions and associated 95% confidence intervals are shown for three **local solar** times and with smoothed weather covariates") +
  theme(legend.position = "none")

bearded_predse
```

```{r ribbonPredSE,fig.asp = 0.7, include = TRUE, fig.cap="Seasonal variability in haul-out probability and the associated 95\\% confidence intervals (shaded area) for ribbon seals. Model predictions are shown for three local solar hours (07:00, 12:00, and 17:00) with smoothed weather covariates. Age and sex classes are separated to allow comparisons."}
plot_df <- ribbon_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label = TRUE),
         day = lubridate::day(date)) %>%
  filter(!month %in% c("Jul","Aug"),
         lubridate::yday(date) >73,
         solar_hour %in% c(7,12,17))

ribbon_predse <- ggplot(plot_df, aes(date,ho_prob)) +
  geom_ribbon(aes(ymin=lower95,ymax=upper95), 
              fill = species_colors['Ribbon seal'], alpha = 0.3) +
  geom_line(aes(date,ho_prob),
            color = species_colors['Ribbon seal']) +
  facet_grid(age_sex ~ solar_hour,
             scales = "free_x",
                    space = "free_x",
                    labeller = labeller(
                      age_sex = age_sex_labels,
                      solar_hour = local_solar_labels
                    )) +
  scale_y_continuous(breaks = c(0.2,0.4,0.6,0.8), labels = c("0.2","0.4", "0.6", "0.8"), limits = c(0,1)) +
  xlab("day of year") +
  ylab("haul-out probability") +
  labs(title = "Ribbon seal predicted haul-out probability with uncertainty",
       subtitle = "predictions and associated 95% confidence intervals are shown for three **local solar** times and with smoothed weather covariates") +
  theme(legend.position = "none")

ribbon_predse
```

```{r spottedPredSE,fig.asp = 0.7, include = TRUE, fig.cap="Seasonal variability in haul-out probability and the associated 95\\% confidence intervals (shaded area) for spotted seals. Model predictions are shown for three local solar hours (07:00, 12:00, and 17:00) with smoothed weather covariates. Age and sex classes are separated to allow comparisons."}
plot_df <- spotted_newdata %>%
  mutate(date = lubridate::as_date(yday, origin = "2015-01-01"),
         month = lubridate::month(date,label = TRUE),
         day = lubridate::day(date)) %>%
  filter(!month %in% c("Jul","Aug"),
         lubridate::yday(date) >73,
         solar_hour %in% c(7,12,17))

spotted_predse <- ggplot(plot_df, aes(date,ho_prob)) +
  geom_ribbon(aes(ymin=lower95,ymax=upper95), 
              fill = species_colors['Spotted seal'], alpha = 0.3) +
  geom_line(aes(date,ho_prob),
            color = species_colors['Spotted seal']) +
  facet_grid(age_sex ~ solar_hour,
             scales = "free_x",
                    space = "free_x",
                    labeller = labeller(
                      age_sex = age_sex_labels,
                      solar_hour = local_solar_labels
                    )) +
  scale_y_continuous(breaks = c(0.2,0.4,0.6,0.8), labels = c("0.2","0.4", "0.6", "0.8"), limits = c(0,1)) +
  xlab("day of year") +
  ylab("haul-out probability") +
  labs(title = "Spotted seal predicted haul-out probability with uncertainty",
       subtitle = "predictions and associated 95% confidence intervals are shown for three **local solar** times and with smoothed weather covariates") +
  theme(legend.position = "none")

spotted_predse
```

## Exploring Insolation (Solar Radiation) as a Model Covariate

### Introduction

During the peer review process for this manuscript, Anthony Fishbach suggested
the possibility of using predicted insolation (or solar radiation) values from
the reanalysis model as a more direct and, potentially, more informative
predictor of the daily haul-out cycle in seals compared to time of day. The
notion being that seals are, likely, directly responding to changes in solar radiation
throughout the day and not what time of day it is (i.e. seals don't have
watches). Additionally, given the energetic benefits of increased solar
radiation it could be more informative as we would expect seals might have a
higher haul-out probability on sunnier days and for there to be geographic
variability in haul-out behavior associated with geographical differences in
insolation. This approach has an additional benefit of being more parsimonious
compared to our use of the Fourier series or other approaches to represent
hour-of-day in the model (e.g. 24 factors for each hour).

Because of these reasons, we considered and explored this
possibility for our model and the analysis presented in this manuscript. A key
drawback to reliance on solar radiation, in our minds, is that we would lose
insight regarding potential diel patterns -- solar radiation does not 
differentiate between dusk or dawn. Bi-modal patterns have been
previously observed in ringed seals and our results in this analysis show some indication of
increased haul-out probability during dawn and dusk periods for bearded seals.
For other phocid speices, increased haul-out probability before solar noon or after
solar noon has been observed. Importantly, understanding these relationships
between haul-out probability and hour-of-day can have important ramifications
on aerial survey study design -- a key focus of this paper.  
Another hesitation we had was that insolation estimates from reanalysis models have
not been previously used as a model covariate within a published study of 
pinniped haul-out behavior. Thus, for this analysis, we chose to keep our
original approach and rely on the Fourier series to capture any hour-of-day
effects.

That said, we think the idea of insolation as a model covariate in pinniped
haul-out models is intriguing and worth further exploration. The current
availability and increased accessibility to detailed climate reanalysis
products that include insolation is exciting and we encrourage future, more
detailed exploration of this as a component in pinniped haul-out analysis. To
provide some inspiration, we present some initial efforts and model 
comparisons.

### Methods

In this manuscript, we rely on the NARR reanalysis model as the source for our
weather covariates. However, since our initiation of this analysis, the ERA5
reanalysis model (https://doi.org/10.24381/cds.adbb2d47) has become one of the
go-to standards for global climate reanalysis and provides an increased temporal
resolution to hourly (compared to the 3-hour resolution of NARR). The global
coverage of ERA5 provides additional flexibility in that the area of interest is
not limited to North America. The ERA5 model provides a number of solar
radiation parameters and it is important to evaluate and understand each of
these estimates in order to select the one that is likely most relevant to
seals. Here, we use the 'surface short-wave (solar) radiation downwards.' This
parameter is described as _the amount of solar radiation (also known as shortwave radiation)
that reaches a horizontal plane at the surface of the Earth and comprises both
direct and diffuse solar radiation. To a reasonably good approximation, this
parameter is the model equivalent of what would be measured by a pyranometer (an
instrument used for measuring solar radiation) at the surface_ 
(https://codes.ecmwf.int/grib/param-db/?id=169). Thus, this is the
parameter which most closely represents the amount of solar radiation likely
felt by a seal hauled out of the water.

ERA5 data is available via the Copernicus climate data store API which can be
queried with the CDS-API Python package 
(https://cds.climate.copernicus.eu/api-how-to). The R code provided here
documents the download of the _surface_solar_radiation_downwards_ parameter for
our study area of interest and years of interest. The `reticulate` R package
(https://CRAN.R-project.org/package=reticulate) allows interaction with Python.
Additionally, note, extra steps are required to download data on either side
of the 180 anti-meridian.

```{r cdsapi, eval=FALSE, include=TRUE, echo = TRUE}
library(tidyverse)
library(reticulate)
library(sf)
library(terra)

#import python CDS-API
cdsapi <- import('cdsapi')
#for this step there must exist the file .cdsapirc
server = cdsapi$Client() #start the connection

get_era5 <- function(y) {
  #we create the query
  query <- r_to_py(
    list(
      variable = "surface_solar_radiation_downwards",
      product_type = "reanalysis",
      area = "75/152/47/180", # North, West, South, East
      year = y,
      month = str_pad(2:7, 2, "left", "0"),
      day = str_pad(1:31, 2, "left", "0"),
      time = str_c(0:23, "00", sep = ":") %>% str_pad(5, "left", "0"),
      format = "netcdf"
    )
  )
  #query to get the ncdf
  server$retrieve("reanalysis-era5-single-levels",
                  query,
                  paste0("era5_ssrd_", y, "_left.nc"))
  
  query <- r_to_py(
    list(
      variable = "surface_solar_radiation_downwards",
      product_type = "reanalysis",
      area = "75/-180/47/-142", # North, West, South, East
      year = y,
      month = str_pad(2:7, 2, "left", "0"),
      day = str_pad(1:31, 2, "left", "0"),
      time = str_c(0:23, "00", sep = ":") %>% str_pad(5, "left", "0"),
      format = "netcdf"
    )
  )
  #query to get the ncdf
  server$retrieve("reanalysis-era5-single-levels",
                  query,
                  paste0("era5_ssrd_", y, "_right.nc"))

}

years <- as.character(2005:2021)
for(i in 1:length(years)) {
  get_era5(years[i])
}

```

To explore performance of our solar radiation parameter within a haul-out model
we replace the various Fourier series parameters in our model from the manuscript
with the ERA5 _surface solar radiation downwards_ (`era_ssrd`) parameter. As
with other reanalysis values (from NARR) in the manuscript, the `era-ssrd`
values are matched in time and space to the seal haul-out observation data. We
use the full hourly temporal resolution from ERA5. The glmmLDTS framework used
in the paper does not allow for model comparisons with AIC because of
the reliance on pseudo-likelihood. The `bam` function within the `mgcv` package
provides a quick model fitting option that also allows us to do some model
comparison with AIC. This is sufficient for the general demonstration and
exploartion purposes here
but future research should consider a range of model fitting frameworks and
approaches that might be appropriate.

```{r load-model-data, include=FALSE}
library(targets)
tar_load(spotted_model_data,store = here::here("_targets"))
tar_load(ribbon_model_data,store = here::here("_targets"))
tar_load(bearded_model_data, store = here::here("_targets"))
```

The model specification below was used to specify an `mgcv::bam()` model that
matches the formula used in the manuscript for spotted seals. The `s(speno, bs = "re")` 
term is the smooth term for the random effect. All other predictors are
the same. 

```{r bam-m1-spotted, include=TRUE, echo = TRUE}
m1_spotted <- mgcv::bam(
  dry ~ age_sex + s(speno, bs = "re") + 
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 + 
    poly(day, 3, raw=TRUE) + 
    sin1:poly(day, 3, raw=TRUE) +
    cos1:poly(day, 3, raw=TRUE) +
    sin2:poly(day, 3, raw=TRUE) +
    cos2:poly(day, 3, raw=TRUE) +
    sin3:poly(day, 3, raw=TRUE) +
    cos3:poly(day, 3, raw=TRUE) +
    wind*temp2m + pressure + precip + 
    age_sex:poly(day, 4, raw=TRUE),
  data = spotted_model_data,
  family = binomial,
  discrete = TRUE)
```


```{r lag1-spotted, include=FALSE}
lag1_spotted <- acf(resid(m1_spotted), plot=FALSE)[1][[1]]
```

Note, the specification for _m1_spotted_ here does not include
any AR1 structure for temporal autocorrelation. To include this, we need to
provide a value for $\rho$ (or _rho_). We can examine the autocorrelation within
the model and use the lag-1 value for $\rho$ .The value for lag-1 
autocorrelation is `r formatC(as.numeric(lag1_spotted))` which is
rather high but not surprising. We can, now, update our model specification with
a value for $\rho$ as well as the `A1.start` argument with specifies (TRUE/FALSE) the
start point of each block.

```{r bam-m2-spotted, include=TRUE, echo = TRUE}
m2_spotted <- mgcv::bam(
  dry ~ age_sex + s(speno, bs = "re") + 
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 + 
    poly(day, 3, raw=TRUE) + 
    sin1:poly(day, 3, raw=TRUE) +
    cos1:poly(day, 3, raw=TRUE) +
    sin2:poly(day, 3, raw=TRUE) +
    cos2:poly(day, 3, raw=TRUE) +
    sin3:poly(day, 3, raw=TRUE) +
    cos3:poly(day, 3, raw=TRUE) +
    wind*temp2m + pressure + precip + 
    age_sex:poly(day, 3, raw=TRUE),
  data = spotted_model_data,
  family = binomial,
  AR.start = ar1_start,
  rho = lag1_spotted,
  discrete = TRUE)
```

The model specification for exploring the use of solar radiation is
specified similarly but without all of the Fourier series parameters and
interactions.

```{r bam-ssrd-spotted, include=TRUE, echo = TRUE}
m2_ssrd_spotted <- mgcv::bam(
  dry ~ age_sex + s(speno, bs = "re") + 
    era5_ssrd_watts +
    poly(day, 3, raw=TRUE) + 
    era5_ssrd_watts:poly(day, 3, raw=TRUE) +
    wind*temp2m + pressure + precip + 
    age_sex:poly(day, 3, raw=TRUE),
  data = spotted_model_data,
  family = binomial,
  AR.start = ar1_start,
  rho = lag1_spotted,
  discrete = TRUE)
```

Lastly, the two models were compared with AIC to evaluate whether the
reduction in degrees of freedom with fewer terms in the solar radiation
model was matched with improved explanatory power in the model fit. While the
model and code specified above is for spotted seals, the same approach was
repeated for bearded and ribbon seals.

```{r,bam-ssrd-ribbon-bearded}
m1_ribbon <- mgcv::bam(
  dry ~ age_sex + s(speno, bs = "re") + 
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 + 
    poly(day, 3, raw=TRUE) + 
    sin1:poly(day, 3, raw=TRUE) +
    cos1:poly(day, 3, raw=TRUE) +
    sin2:poly(day, 3, raw=TRUE) +
    cos2:poly(day, 3, raw=TRUE) +
    sin3:poly(day, 3, raw=TRUE) +
    cos3:poly(day, 3, raw=TRUE) +
    wind*temp2m + pressure + precip + 
    age_sex:poly(day, 4, raw=TRUE),
  data = ribbon_model_data,
  family = binomial,
  discrete = TRUE)

lag1_ribbon <- acf(resid(m1_ribbon), plot=FALSE)[1][[1]]

m2_ribbon <- mgcv::bam(
  dry ~ age_sex + s(speno, bs = "re") + 
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 + 
    poly(day, 3, raw=TRUE) + 
    sin1:poly(day, 3, raw=TRUE) +
    cos1:poly(day, 3, raw=TRUE) +
    sin2:poly(day, 3, raw=TRUE) +
    cos2:poly(day, 3, raw=TRUE) +
    sin3:poly(day, 3, raw=TRUE) +
    cos3:poly(day, 3, raw=TRUE) +
    wind*temp2m + pressure + precip + 
    age_sex:poly(day, 3, raw=TRUE),
  data = ribbon_model_data,
  family = binomial,
  AR.start = ar1_start,
  rho = lag1_ribbon,
  discrete = TRUE)

m2_ssrd_ribbon <- mgcv::bam(
  dry ~ age_sex + s(speno, bs = "re") + 
    era5_ssrd_watts +
    poly(day, 3, raw=TRUE) + 
    era5_ssrd_watts:poly(day, 3, raw=TRUE) +
    wind*temp2m + pressure + precip + 
    age_sex:poly(day, 3, raw=TRUE),
  data = ribbon_model_data,
  family = binomial,
  AR.start = ar1_start,
  rho = lag1_ribbon,
  discrete = TRUE)

m1_bearded <- mgcv::bam(
  dry ~ s(speno, bs = "re") + 
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 + 
    poly(day, 3, raw=TRUE) + 
    sin1:poly(day, 3, raw=TRUE) +
    cos1:poly(day, 3, raw=TRUE) +
    sin2:poly(day, 3, raw=TRUE) +
    cos2:poly(day, 3, raw=TRUE) +
    sin3:poly(day, 3, raw=TRUE) +
    cos3:poly(day, 3, raw=TRUE) +
    wind*temp2m + pressure + precip,
  data = bearded_model_data,
  family = binomial,
  discrete = TRUE)

lag1_bearded <- acf(resid(m1_bearded), plot=FALSE)[1][[1]]

m2_bearded <- mgcv::bam(
  dry ~ s(speno, bs = "re") + 
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 + 
    poly(day, 3, raw=TRUE) + 
    sin1:poly(day, 3, raw=TRUE) +
    cos1:poly(day, 3, raw=TRUE) +
    sin2:poly(day, 3, raw=TRUE) +
    cos2:poly(day, 3, raw=TRUE) +
    sin3:poly(day, 3, raw=TRUE) +
    cos3:poly(day, 3, raw=TRUE) +
    wind*temp2m + pressure + precip,
  data = ribbon_model_data,
  family = binomial,
  AR.start = ar1_start,
  rho = lag1_bearded,
  discrete = TRUE)

m2_ssrd_bearded <- mgcv::bam(
  dry ~ s(speno, bs = "re") + 
    era5_ssrd_watts +
    poly(day, 3, raw=TRUE) + 
    era5_ssrd_watts:poly(day, 3, raw=TRUE) +
    wind*temp2m + pressure + precip,
  data = bearded_model_data,
  family = binomial,
  AR.start = ar1_start,
  rho = lag1_bearded,
  discrete = TRUE)
```

## Results

To evaluate whether the solar radiation parameter matches our expectations and
compares well with hour of the day, we can visualize the variability of the 
`era5_ssrd` values within
our study area as they relate to hour of the day. The unimodal distribution
is centered around the middle of the solar day with peak solar radiation
coinciding with 13:00 local solar. This suggests solar radiation could be an
informative covariate for capturing unimodal diel patterns in haul-out
behavior.

```{r random-ssrd-pts, include=FALSE, eval=FALSE}
years <- 2005:2021

raster_merge <- vector(mode = "list", length = length(years))

for (i in 1:length(years)) {
  left_file <-
    here::here('data_raw',
               'era5_ssrd',
               paste0('era5_ssrd_', years[i], '_left.nc'))
  right_file <-
    here::here('data_raw',
               'era5_ssrd',
               paste0('era5_ssrd_', years[i], '_right.nc'))
  r1 <- terra::rast(left_file)
  r2 <- terra::rast(right_file)
  raster_merge[[i]] <- terra::merge(r1, r2)
}

ssrd_dataset <- terra::rast(raster_merge)

pt_ul = st_point(c(160, 70))
pt_br = st_point(c(179, 60))
poly_left <- st_bbox(st_sfc(pt_ul, pt_br,crs = 4326)) |> st_as_sfc()

pt_ul = st_point(c(-160, 70))
pt_br = st_point(c(-179, 60))
poly_right <- st_bbox(st_sfc(pt_ul, pt_br,crs = 4326)) |> st_as_sfc()

# how many random points do we want to generate
n_pts <- 5000

pts1 <- st_sample(poly_left,size = n_pts/2)
pts2 <- st_sample(poly_right, size = n_pts/2)

pts <- c(pts1,pts2)

# Set the seed for reproducibility
set.seed(123)

# Generate random hourly timestamps
get_random_times <- function(start_t, end_t, months, n) {
  tibble(
  time = seq(as.POSIXct(start_t, tz = "UTC"), as.POSIXct(end_t, tz = "UTC"), by = "hours")
)  |> 
  filter(month(time) %in% c(months))  |> 
    filter(month(time) != 2 & mday(time) != 1) |> 
  sample_n(n) %>%
  pull(time)
}

random_times <- get_random_times(start_t = "2005-02-01", end_t = "2021-07-30",
                                 months = c(2,3,4,5,6,7), n = n_pts)

# create a dataset of points with those random times
pts_sf <- st_sf(time=random_times,pts)
pts_vec <- terra::vect(pts_sf)

# list to store for-loop results
pts_ssrd_list <- vector(mode = "list", length = length(years))

years <- 2005:2021

for (i in 1:length(years)) {
  r <- terra::subset(ssrd_dataset, lubridate::year(time(ssrd_dataset)) == years[i])
  v <- terra::subset(pts_vec, lubridate::year(pts_vec$time) == years[i])
  tm <- match(v$time,time(r))
  pts_ssrd_list[[i]] <- terra::extract(r,v,layer=tm, bind=TRUE)
}

library(solaR)

pts_ssrd_sf <- vect(pts_ssrd_list) |> st_as_sf()

pts_ssrd_sf <- pts_ssrd_sf |> 
  mutate(lon = st_coordinates(geometry)[,1]) |> 
  mutate(solar_hour = lubridate::hour(solaR::local2Solar(time,lon)))
```

```{r era5-ssrd-plot, fig.asp = 0.75, include=TRUE, fig.cap="Downward surface solar radiation estimates from the ERA5 climate reanalysis for 5000 random points within the study area between 2005 and 2021. Solar radiation values are presented in Watts per square-meter and the smoothed line highlights the strong diel pattern."}

pts_ssrd_sf <- readRDS(here::here('data/random_ssrd_pts.rds'))

ssrd_solarhour_plot <- ggplot(data = pts_ssrd_sf, aes(x=solar_hour, y=value)) + 
  geom_point(size = 0.5, alpha = 0.2, color = "#edd9a3") + 
  geom_smooth(se=TRUE, linewidth = 0.2, color = "#4b2991") +
  # geom_vline(xintercept = 13, linetype="dashed", 
  #               linewidth = 1) +
  scale_x_continuous(breaks = c(3,6,9,12,15,18,21),
                     labels = c("03:00","06:00","09:00","12:00","15:00","18:00",
                                "21:00")) +
  xlab("Local Solar Hour") +
  ylab("Solar Radiation") +
  labs(title = "Diel Pattern of Solar Radiation Values from ERA5 Reanalysis",
       subtitle = "A random sample of hourly ERA5 downward surface solar radiation values for points within the study area confirms a unimodal relationship with local solar hour.",
       caption = "solar radiation values are presented in Watts per meter^2")

ssrd_solarhour_plot
```

The spotted seal model matching the specification from the manuscript resulted in 
`r AIC(m2_spotted,m2_ssrd_spotted)['m2_spotted','df']` degrees of freedom and an AIC value of
`r AIC(m2_spotted,m2_ssrd_spotted)['m2_spotted','AIC']`. The model with solar radiation resulted in 
`r AIC(m2_spotted,m2_ssrd_spotted)['m2_ssrd_spotted','df']` degrees of freedom and an AIC value of
`r AIC(m2_spotted,m2_ssrd_spotted)['m2_ssrd_spotted','AIC']`. Despite the additional terms, the
model with the Fourier series representation of hour of day resulted in a 
lower AIC value and was still preferred for spotted seals. The ribbon seal model matching the specification from the manuscript resulted in 
`r AIC(m2_ribbon,m2_ssrd_ribbon)['m2_ribbon','df']` degrees of freedom and an AIC value of
`r AIC(m2_ribbon,m2_ssrd_ribbon)['m2_ribbon','AIC']`. The model with solar radiation resulted in 
`r AIC(m2_ribbon,m2_ssrd_ribbon)['m2_ssrd_ribbon','df']` degrees of freedom and an AIC value of
`r AIC(m2_ribbon,m2_ssrd_ribbon)['m2_ssrd_ribbon','AIC']`. Despite the additional terms, the
model with the Fourier series representation of hour of day resulted in a 
lower AIC value and was still preferred for bearded seals. The bearded seal model matching the specification from the manuscript resulted in 
`r AIC(m2_bearded,m2_ssrd_bearded)['m2_bearded','df']` degrees of freedom and an AIC value of
`r AIC(m2_bearded,m2_ssrd_bearded)['m2_bearded','AIC']`. The model with solar radiation resulted in 
`r AIC(m2_bearded,m2_ssrd_bearded)['m2_ssrd_bearded','df']` degrees of freedom and an AIC value of
`r AIC(m2_bearded,m2_ssrd_bearded)['m2_ssrd_bearded','AIC']`. Despite the additional terms, the
model with the Fourier series representation of hour of day resulted in a 
lower AIC value and was still preferred for bearded seals.



